<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>MTG Commander Deckbuilder</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#07070f;--s1:#0d0d1a;--s2:#12121f;--s3:#181826;--s4:#1e1e30;
  --l0:#0a0a16;--l1:#1e1e32;--l2:#2e2e48;--l3:#484868;
  --t1:#eeeaf8;--t2:#b0acc8;--t3:#706c90;--t4:#403c60;
  --gold:#c8902a;--gold2:#e0aa40;--goldbg:rgba(200,144,42,.09);
  --W:#f5e8c0;--U:#4a90d8;--B:#7850b8;--R:#d06030;--G:#40a858;--C:#888aa8;
  --sb:env(safe-area-inset-bottom,0px);--st:env(safe-area-inset-top,0px);
  --r:10px;
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html{height:100%}
body{background:var(--bg);color:var(--t1);font-family:'Libre Baskerville',Georgia,serif;font-size:15px;line-height:1.65;min-height:100%;-webkit-font-smoothing:antialiased;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;z-index:0;pointer-events:none;background:radial-gradient(ellipse 100% 70% at 10% -5%,rgba(80,40,160,.12) 0%,transparent 50%),radial-gradient(ellipse 80% 60% at 90% 105%,rgba(200,144,42,.06) 0%,transparent 50%)}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-thumb{background:var(--l1);border-radius:2px}

/* HEADER */
header{position:sticky;top:0;z-index:900;background:rgba(7,7,15,.96);border-bottom:1px solid var(--l1);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);padding:0 16px;padding-top:var(--st);height:calc(52px + var(--st));display:flex;align-items:center;gap:12px}
.logo{display:flex;align-items:center;gap:8px;flex-shrink:0;cursor:pointer;text-decoration:none}
.logo-hex{width:26px;height:26px;background:linear-gradient(135deg,var(--gold),#905010);clip-path:polygon(50% 0%,94% 25%,94% 75%,50% 100%,6% 75%,6% 25%);display:flex;align-items:center;justify-content:center;font-size:10px;color:#000}
.logo-n{font-family:'Cinzel',serif;font-size:11px;font-weight:700;letter-spacing:.1em}
.logo-s{font-family:'JetBrains Mono',monospace;font-size:7px;color:var(--t3);letter-spacing:.1em;text-transform:uppercase}
.steps{display:flex;align-items:stretch;flex:1;justify-content:flex-end;overflow:hidden}
.step{display:flex;align-items:center;gap:5px;padding:0 8px;border-bottom:2px solid transparent;opacity:.18;transition:all .25s;flex-shrink:0;cursor:default}
.step.act{opacity:1;border-bottom-color:var(--gold)}
.step.done{opacity:.4;cursor:pointer}
.step-b{width:16px;height:16px;border-radius:50%;background:var(--s3);color:var(--t3);font-family:'JetBrains Mono',monospace;font-size:7px;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .2s}
.step.act .step-b{background:var(--gold);color:#000;font-weight:700}
.step.done .step-b{background:var(--l2);color:var(--t1)}
.step-l{font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--t3);letter-spacing:.04em;white-space:nowrap}
.step.act .step-l{color:var(--t2)}
.ssep{color:var(--l1);font-size:10px;display:flex;align-items:center}
@media(max-width:400px){.step-l{display:none}}

/* MAIN */
main{position:relative;z-index:1;max-width:680px;margin:0 auto;padding:26px 14px calc(90px + var(--sb))}
.page{display:none}
.page.on{display:block;animation:pgIn .3s cubic-bezier(.16,1,.3,1) both}
@keyframes pgIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.ptit{font-family:'Cinzel',serif;font-size:23px;font-weight:700;letter-spacing:.02em;line-height:1.2;margin-bottom:4px}
.psub{font-size:13px;color:var(--t3);font-style:italic;margin-bottom:24px}
.lbl{font-family:'JetBrains Mono',monospace;font-size:8px;font-weight:500;letter-spacing:.16em;text-transform:uppercase;color:var(--t3);margin-bottom:9px;margin-top:20px;display:flex;align-items:center;gap:8px}
.lbl::after{content:'';flex:1;height:1px;background:linear-gradient(to right,var(--l1),transparent);max-width:60px}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:13px 24px;min-height:48px;background:var(--gold);border:none;border-radius:8px;color:#000;font-family:'Cinzel',serif;font-size:10px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;cursor:pointer;touch-action:manipulation;-webkit-appearance:none;box-shadow:0 4px 20px rgba(200,144,42,.22);transition:all .15s}
.btn:hover{background:var(--gold2)}
.btn:active{transform:scale(.97)}
.btn:disabled{background:var(--s4);color:var(--t3);box-shadow:none;cursor:not-allowed;transform:none}
.btng{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:12px 20px;min-height:48px;background:transparent;border:1px solid var(--l2);border-radius:8px;color:var(--t2);font-size:13px;cursor:pointer;touch-action:manipulation;-webkit-appearance:none;transition:all .15s;font-family:'Libre Baskerville',serif}
.btng:hover{border-color:var(--l3);color:var(--t1)}
.btng:active{transform:scale(.97)}
.pnav{display:flex;justify-content:space-between;align-items:center;margin-top:24px;gap:10px}

/* SEARCH */
.sw{position:relative;margin-bottom:8px}
.sbox{display:flex;align-items:center;background:var(--s1);border:1px solid var(--l1);border-radius:var(--r);overflow:hidden;transition:border-color .2s,box-shadow .2s}
.sbox:focus-within{border-color:rgba(200,144,42,.5);box-shadow:0 0 0 3px rgba(200,144,42,.08)}
.sico{padding:0 13px;color:var(--t3);font-size:16px;flex-shrink:0}
.sinp{flex:1;padding:15px 0;background:transparent;border:none;color:var(--t1);font-size:16px;font-family:'Libre Baskerville',serif;outline:none;min-width:0}
.sinp::placeholder{color:var(--t4);font-style:italic}
.sspin{padding:0 12px;display:none}
.spin{display:inline-block;animation:rot .6s linear infinite;color:var(--gold);font-size:14px}
@keyframes rot{to{transform:rotate(360deg)}}
.scl{padding:0 14px;background:none;border:none;color:var(--t3);font-size:18px;cursor:pointer;min-width:46px;display:none;align-items:center;justify-content:center;touch-action:manipulation;transition:color .15s}
.scl:hover{color:var(--t1)}

/* DROPDOWN */
.sdrop{display:none;position:absolute;top:calc(100% + 6px);left:0;right:0;z-index:700;background:var(--s1);border:1px solid var(--l1);border-radius:var(--r);box-shadow:0 24px 60px rgba(0,0,0,.9);max-height:380px;overflow-y:auto;-webkit-overflow-scrolling:touch}
.di{display:flex;align-items:center;gap:10px;padding:9px 12px;border-bottom:1px solid var(--l0);cursor:pointer;touch-action:manipulation;transition:background .1s}
.di:last-child{border-bottom:none}
.di:active{background:var(--s2)}
.di-img{width:28px;height:40px;border-radius:3px;object-fit:cover;object-position:top;flex-shrink:0;background:var(--s3)}
.di-name{font-family:'Cinzel',serif;font-size:11px;font-weight:600;color:var(--t1);line-height:1.2}
.di-type{font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--t3);margin-top:2px}
.di-ci{display:flex;gap:3px;margin-top:3px}
.ci{width:7px;height:7px;border-radius:50%}
.di-rank{font-family:'JetBrains Mono',monospace;font-size:7px;color:var(--t4);margin-top:1px}

/* COMMANDER CARD */
.cc{display:flex;background:var(--s1);border:1px solid var(--l1);border-radius:12px;overflow:hidden;margin-bottom:18px;box-shadow:0 16px 50px rgba(0,0,0,.7)}
.cc-bar{width:4px;flex-shrink:0}
.cc-art{width:96px;flex-shrink:0;object-fit:cover;object-position:20% 12%}
.cc-body{padding:13px 15px;flex:1;min-width:0;display:flex;flex-direction:column;gap:5px}
.cc-name{font-family:'Cinzel',serif;font-size:14px;font-weight:700;line-height:1.2;letter-spacing:.01em}
.cc-type{font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--t3);text-transform:uppercase;letter-spacing:.06em}
.cc-mana{display:flex;gap:3px;align-items:center;flex-wrap:wrap}
.cc-oracle{font-size:12px;color:var(--t3);font-style:italic;line-height:1.55;border-left:2px solid var(--l1);padding-left:9px}
.cc-meta{display:flex;gap:10px;flex-wrap:wrap}
.cc-edh{font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--t4)}
.cc-price{font-family:'JetBrains Mono',monospace;font-size:8px;color:#40a858}

/* MANA SYMBOLS */
.ms{display:inline-flex;align-items:center;justify-content:center;width:16px;height:16px;border-radius:50%;font-family:'JetBrains Mono',monospace;font-size:8px;font-weight:700;flex-shrink:0;border:1px solid rgba(0,0,0,.3);line-height:1}
.ms-W{background:#f5e8c0;color:#5a4820}
.ms-U{background:#4a90d8;color:#fff}
.ms-B{background:#7850b8;color:#fff}
.ms-R{background:#d06030;color:#fff}
.ms-G{background:#40a858;color:#fff}
.ms-C{background:#888aa8;color:#fff}
.ms-X{background:#444460;color:#ccc}
.ms-n{background:#b0b0c0;color:#333}

/* COLLECTION */
.dz{border:1px dashed var(--l2);border-radius:8px;padding:14px;text-align:center;cursor:pointer;touch-action:manipulation;font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--t3);letter-spacing:.06em;min-height:48px;display:flex;align-items:center;justify-content:center;transition:all .2s}
.dz:hover,.dz.drag{border-color:var(--gold);color:var(--gold)}
.dz.loaded{border-color:rgba(200,144,42,.4);color:var(--gold2);border-style:solid}

/* PAGE 2 ‚Äì THEMES */
.edh-stat{font-size:12px;color:var(--t3);font-style:italic;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.edh-dot{width:6px;height:6px;border-radius:50%;background:var(--gold);animation:pulse 1.4s infinite}
.edh-dot.ok{background:#40a858;animation:none}
.edh-dot.err{background:#c04040;animation:none}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.25}}
.sel-bar{display:flex;gap:6px;flex-wrap:wrap;min-height:28px;margin-bottom:14px;align-items:center}
.sel-chip{display:inline-flex;align-items:center;gap:5px;padding:4px 10px;border-radius:100px;font-family:'JetBrains Mono',monospace;font-size:9px}
.sc1{background:var(--goldbg);border:1px solid rgba(200,144,42,.35);color:var(--gold)}
.sc2{background:rgba(130,80,200,.08);border:1px solid rgba(130,80,200,.35);color:#a870e8}

/* THEME TAGS */
.tgrid{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px}
.ttag{display:flex;align-items:center;gap:6px;padding:8px 12px;border-radius:100px;background:var(--s1);border:1px solid var(--l1);cursor:pointer;touch-action:manipulation;transition:all .18s;min-height:38px}
.ttag:active{transform:scale(.97)}
.ttag.s1{background:var(--goldbg);border-color:rgba(200,144,42,.45)}
.ttag.s2{background:rgba(130,80,200,.1);border-color:rgba(130,80,200,.4)}
.tt-icon{font-size:13px}
.tt-name{font-family:'Cinzel',serif;font-size:11px;color:var(--t2);transition:color .18s}
.ttag.s1 .tt-name{color:var(--gold)}
.ttag.s2 .tt-name{color:#a870e8}
.tt-cnt{font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--t4);background:var(--s3);padding:1px 5px;border-radius:4px}
.ttag.s1 .tt-cnt{background:rgba(200,144,42,.15);color:var(--gold)}
.ttag.s2 .tt-cnt{background:rgba(130,80,200,.15);color:#a870e8}

/* BRACKET */
.bgrid{display:grid;grid-template-columns:repeat(5,1fr);gap:5px;margin-bottom:18px}
@media(max-width:480px){.bgrid{grid-template-columns:repeat(3,1fr)}}
.bcard{background:var(--s1);border:1px solid var(--l1);border-radius:8px;padding:10px 6px 8px;text-align:center;cursor:pointer;touch-action:manipulation;position:relative;overflow:hidden;transition:all .2s}
.bcard::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:var(--bc,transparent)}
.bcard:active{transform:scale(.97)}
.bcard.sel{background:var(--s2);border-color:var(--bc,var(--l2))}
.b-num{font-family:'Cinzel',serif;font-size:20px;font-weight:700;color:var(--bc,var(--l2));line-height:1;margin-bottom:3px}
.b-lbl{font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--t3);letter-spacing:.04em;text-transform:uppercase}
.bcard.sel .b-lbl{color:var(--t2)}

/* OPTIONS ‚Äî now fully independent from bracket */
.opts{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:18px}
.opill{padding:8px 13px;border-radius:100px;min-height:38px;display:flex;align-items:center;gap:6px;background:var(--s1);border:1px solid var(--l1);cursor:pointer;touch-action:manipulation;font-size:12px;color:var(--t2);transition:all .15s;font-family:'Libre Baskerville',serif}
.opill:active{transform:scale(.97)}
.opill.on{background:var(--goldbg);border-color:rgba(200,144,42,.4);color:var(--gold)}
.opill.danger{border-color:rgba(192,72,72,.3)}
.opill.danger.on{background:rgba(192,72,72,.08);border-color:rgba(192,72,72,.4);color:#e07070}
.op-ico{font-size:11px}

/* LAND SLIDER */
.land-row{display:flex;align-items:center;gap:14px;background:var(--s1);border:1px solid var(--l1);border-radius:var(--r);padding:14px 18px;margin-bottom:18px}
.land-n{font-family:'Cinzel',serif;font-size:32px;font-weight:700;color:var(--gold);min-width:44px;text-align:center;line-height:1}
.land-side{flex:1}
.land-sl{width:100%;-webkit-appearance:none;height:3px;background:var(--l1);border-radius:2px;outline:none;cursor:pointer;accent-color:var(--gold)}
.land-sl::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;border-radius:50%;background:var(--gold);cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.5)}
.land-hint{font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--t4);margin-top:5px}
.land-rec{font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--gold);margin-top:2px}

/* BUDGET ‚Äî with custom input */
.bgrid2{display:grid;grid-template-columns:repeat(3,1fr);gap:5px;margin-bottom:8px}
.bud{background:var(--s1);border:1px solid var(--l1);border-radius:8px;padding:9px 10px;cursor:pointer;touch-action:manipulation;display:flex;align-items:center;gap:7px;min-height:40px;transition:all .2s}
.bud:active{transform:scale(.97)}
.bud.sel{background:var(--s2)}
.bud-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.bud-l{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--t3);line-height:1.3}
.bud.sel .bud-l{color:var(--t1)}
.custom-price{display:flex;gap:6px;align-items:center;margin-bottom:18px}
.cp-inp{flex:1;padding:9px 12px;background:var(--s1);border:1px solid var(--l1);border-radius:8px;color:var(--t1);font-family:'JetBrains Mono',monospace;font-size:12px;outline:none;transition:border-color .2s;min-width:0}
.cp-inp:focus{border-color:rgba(200,144,42,.5)}
.cp-inp::placeholder{color:var(--t4)}
.cp-btn{padding:9px 14px;background:var(--s1);border:1px solid var(--l1);border-radius:8px;color:var(--t2);font-family:'JetBrains Mono',monospace;font-size:9px;cursor:pointer;touch-action:manipulation;transition:all .15s;min-height:38px;white-space:nowrap;-webkit-appearance:none}
.cp-btn:active{border-color:var(--gold);color:var(--gold)}

/* SUMMARY */
.sumbox{background:var(--s1);border:1px solid var(--l1);border-radius:var(--r);padding:14px 16px;margin-top:14px}
.sum-r{display:flex;gap:10px;margin-bottom:5px;align-items:baseline}
.sum-k{font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--t3);min-width:80px;text-transform:uppercase;letter-spacing:.06em;flex-shrink:0}
.sum-v{font-size:13px;color:var(--t1)}

/* LOADING */
.lw{text-align:center;padding:70px 20px}
.lring{width:48px;height:48px;border:2px solid var(--l1);border-top-color:var(--gold);border-radius:50%;animation:rot .75s linear infinite;margin:0 auto 18px}
.lt{font-family:'Cinzel',serif;font-size:18px;font-weight:700;margin-bottom:4px}
.lm{font-size:12px;color:var(--t3);font-style:italic;margin-bottom:14px}
.lbar{width:100%;max-width:300px;height:2px;background:var(--l1);border-radius:1px;overflow:hidden;margin:0 auto 16px}
.lfill{height:100%;background:linear-gradient(to right,#9a7020,var(--gold));border-radius:1px;transition:width .4s;width:0}
.llog{text-align:left;max-width:300px;margin:0 auto}
.lli{font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--t4);margin-bottom:2px;animation:fi .3s forwards;opacity:0}
@keyframes fi{to{opacity:.7}}

/* ERROR */
.ebox{max-width:380px;margin:70px auto;background:var(--s1);border:1px solid #3a1818;border-radius:12px;padding:24px 20px;text-align:center}
.etit{font-family:'Cinzel',serif;font-size:15px;color:#c05050;margin-bottom:6px}
.emsg{font-family:'JetBrains Mono',monospace;font-size:9px;color:#905050;margin-bottom:16px;word-break:break-word;line-height:1.7}

/* DECK RESULT */
.dh{display:flex;gap:14px;margin-bottom:18px;align-items:flex-start;flex-wrap:wrap}
.d-art{width:84px;height:118px;border-radius:8px;object-fit:cover;object-position:15% 12%;box-shadow:0 10px 30px rgba(0,0,0,.7);flex-shrink:0}
.d-info{flex:1;min-width:200px}
.d-title{font-family:'Cinzel',serif;font-size:20px;font-weight:700;line-height:1.2;margin-bottom:5px}
.d-chips{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:7px}
.chip{padding:2px 8px;border-radius:100px;background:var(--s2);border:1px solid var(--l1);font-family:'JetBrains Mono',monospace;font-size:8px}
.d-stats{display:flex;gap:12px;flex-wrap:wrap}
.dst{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--t3)}
.dst strong{color:var(--t1)}
.d-actions{display:flex;gap:7px;flex-wrap:wrap;margin-bottom:20px}

/* CHAT */
.chatbox{background:var(--s1);border:1px solid var(--l1);border-radius:var(--r);overflow:hidden;margin-bottom:22px}
.ch{padding:10px 14px;border-bottom:1px solid var(--l0);display:flex;align-items:center;gap:8px}
.c-orb{width:22px;height:22px;border-radius:50%;background:linear-gradient(135deg,#5040c0,#a060e0);display:flex;align-items:center;justify-content:center;font-size:10px;flex-shrink:0}
.c-tit{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--t2);letter-spacing:.06em;text-transform:uppercase}
.c-hint{font-family:'JetBrains Mono',monospace;font-size:7px;color:var(--t4);margin-left:4px}
.cmsgs{padding:10px 14px;max-height:190px;overflow-y:auto;-webkit-overflow-scrolling:touch;display:flex;flex-direction:column;gap:8px}
.cmsg{display:flex;flex-direction:column;gap:2px}
.cml{font-family:'JetBrains Mono',monospace;font-size:7px;color:var(--t4);padding:0 3px}
.cmsg.u .cml{text-align:right}
.cmb{padding:8px 12px;font-size:12px;line-height:1.55;border-radius:8px}
.cmsg.u .cmb{background:rgba(200,144,42,.1);border:1px solid rgba(200,144,42,.2);color:var(--t1);border-radius:8px 8px 2px 8px;margin-left:25%}
.cmsg.a .cmb{background:var(--s2);border:1px solid var(--l1);color:var(--t1);border-radius:8px 8px 8px 2px;margin-right:25%}
.ctyp{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--t4);padding:2px 14px;font-style:italic;display:none}
.ctyp.on{display:block;animation:bk 1.2s infinite}
@keyframes bk{0%,100%{opacity:.2}50%{opacity:1}}
.cinr{display:flex;border-top:1px solid var(--l0)}
.cinp{flex:1;padding:11px 13px;background:transparent;border:none;color:var(--t1);font-size:14px;font-family:'Libre Baskerville',serif;outline:none;min-width:0}
.cinp::placeholder{color:var(--t4);font-style:italic}
.csnd{padding:0 16px;background:var(--gold);border:none;color:#000;font-family:'JetBrains Mono',monospace;font-size:9px;font-weight:700;cursor:pointer;touch-action:manipulation;transition:background .15s;min-width:56px;letter-spacing:.06em;text-transform:uppercase}
.csnd:hover{background:var(--gold2)}
.csnd:disabled{background:var(--s4);color:var(--t3);cursor:not-allowed}

/* DECK SECTIONS */
.dsec{margin-bottom:26px}
.dsh{display:flex;align-items:center;justify-content:space-between;padding-bottom:8px;border-bottom:1px solid var(--l1);margin-bottom:8px}
.dst2{font-family:'Cinzel',serif;font-size:13px;font-weight:700;color:var(--t2);display:flex;align-items:center;gap:8px;letter-spacing:.04em}
.dsc{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--t3);background:var(--s2);padding:2px 7px;border-radius:4px}
.dsadd{padding:5px 10px;background:transparent;border:1px solid var(--l1);border-radius:5px;color:var(--t3);font-family:'JetBrains Mono',monospace;font-size:8px;cursor:pointer;touch-action:manipulation;min-height:28px;transition:all .15s;letter-spacing:.04em;text-transform:uppercase;-webkit-appearance:none}
.dsadd:active{border-color:var(--gold);color:var(--gold)}
.crow-list{display:flex;flex-direction:column;gap:2px}
.crow{display:flex;align-items:center;gap:8px;padding:5px 8px;background:var(--s1);border:1px solid var(--l0);border-radius:6px;transition:border-color .1s}
.crow.sel{border-color:rgba(64,168,88,.35);background:#060f08}
.crow.gc{border-color:rgba(200,144,42,.25)}
.crow.no{opacity:.35}
.c-qty{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--t3);min-width:16px;flex-shrink:0}
.c-img{width:20px;height:28px;border-radius:2px;object-fit:cover;object-position:top;flex-shrink:0;background:var(--s3)}
.c-name{flex:1;min-width:0;font-family:'Cinzel',serif;font-size:11px;color:var(--t1);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.c-typ{font-family:'JetBrains Mono',monospace;font-size:7px;color:var(--t4);white-space:nowrap;display:none}
@media(min-width:460px){.c-typ{display:block}}
.c-mana{display:flex;gap:2px;flex-shrink:0;min-width:40px;justify-content:flex-end}
.c-badges{display:flex;gap:3px;flex-shrink:0}
.bgc{font-family:'JetBrains Mono',monospace;font-size:7px;color:var(--gold);background:rgba(200,144,42,.1);border:1px solid rgba(200,144,42,.22);padding:1px 4px;border-radius:3px}
.bco{font-family:'JetBrains Mono',monospace;font-size:7px;color:#a870e8;background:rgba(130,80,200,.1);border:1px solid rgba(130,80,200,.22);padding:1px 4px;border-radius:3px}
.c-price{font-family:'JetBrains Mono',monospace;font-size:8px;color:#40a858;white-space:nowrap;flex-shrink:0}
.c-btn{padding:3px 8px;border-radius:4px;cursor:pointer;touch-action:manipulation;font-family:'JetBrains Mono',monospace;font-size:8px;border:1px solid var(--l1);background:var(--s2);color:var(--t3);min-height:26px;transition:all .15s;flex-shrink:0;-webkit-appearance:none;letter-spacing:.04em}
.c-btn:active{transform:scale(.95)}
.crow.sel .c-btn{border-color:rgba(64,168,88,.35);color:#40a858}

/* PANEL */
.panel{position:fixed;left:0;right:0;bottom:0;z-index:800;background:rgba(7,7,15,.97);border-top:1px solid var(--l2);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);padding:10px 16px calc(10px + var(--sb));display:none;box-shadow:0 -10px 40px rgba(0,0,0,.8)}
.prow{display:flex;align-items:center;gap:10px}
.p-info{flex:1;min-width:0}
.p-cnt{font-family:'Cinzel',serif;font-size:14px;font-weight:700;color:var(--gold)}
.p-sub{font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--t3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.p-prog{height:2px;background:var(--l1);border-radius:1px;overflow:hidden;margin-top:4px}
.p-fill{height:100%;background:linear-gradient(to right,#9a7020,var(--gold));border-radius:1px;transition:width .3s}
.p-btns{display:flex;gap:5px}
.pb{padding:7px 12px;border-radius:6px;cursor:pointer;touch-action:manipulation;font-family:'JetBrains Mono',monospace;font-size:8px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;border:1px solid;min-height:34px;-webkit-appearance:none;transition:opacity .15s}
.pb:active{opacity:.6}
.pb-a{background:rgba(72,120,200,.06);border-color:rgba(72,120,200,.25);color:#6090d8}
.pb-s{background:rgba(64,168,88,.06);border-color:rgba(64,168,88,.25);color:#40a858}
@media(min-width:500px){
  .panel{left:auto;right:14px;bottom:14px;width:280px;border-radius:10px;border:1px solid var(--l2);max-height:none}
  main{padding-bottom:60px}
}
</style>
</head>
<body>

<header>
  <a class="logo" onclick="nav(1);return false" href="#">
    <div class="logo-hex">‚öî</div>
    <div><div class="logo-n">Commander</div><div class="logo-s">Deckbuilder</div></div>
  </a>
  <div class="steps" id="stps">
    <div class="step act" id="st1"><div class="step-b" id="sb1">1</div><span class="step-l">Commander</span></div>
    <div class="ssep">‚Ä∫</div>
    <div class="step" id="st2"><div class="step-b" id="sb2">2</div><span class="step-l">Themes</span></div>
    <div class="ssep">‚Ä∫</div>
    <div class="step" id="st3"><div class="step-b" id="sb3">3</div><span class="step-l">Bracket</span></div>
    <div class="ssep">‚Ä∫</div>
    <div class="step" id="st4"><div class="step-b" id="sb4">4</div><span class="step-l">Deck</span></div>
  </div>
</header>

<main>

<!-- PAGE 1 -->
<div class="page on" id="p1">
  <h1 class="ptit">Commander w√§hlen</h1>
  <p class="psub">Scryfall-Suche in Echtzeit ¬∑ EDHREC-Rang ¬∑ Cardmarket-Preis</p>
  <div class="sw" id="sw">
    <div class="sbox">
      <span class="sico">‚åï</span>
      <input class="sinp" id="si" type="search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Atraxa, Light-Paws, Krenko, Edgar Markov‚Ä¶">
      <div class="sspin" id="ssp"><span class="spin">‚óå</span></div>
      <button class="scl" id="scl">‚úï</button>
    </div>
    <div class="sdrop" id="sd"></div>
  </div>
  <div id="serr" style="display:none;margin-top:6px;font-size:11px;color:#e06060;font-family:'JetBrains Mono',monospace;padding:6px 10px;background:rgba(180,50,50,.07);border:1px solid rgba(180,50,50,.18);border-radius:6px"></div>
  <div id="cprev" style="display:none;margin-top:16px"></div>
  <div style="margin-top:20px">
    <div class="lbl" style="margin-top:0">Sammlung importieren <span style="color:var(--t4);font-size:9px;text-transform:none;letter-spacing:0;font-style:italic;font-weight:400">‚Äî optional</span></div>
    <div class="dz" id="dz" ondragover="event.preventDefault();this.classList.add('drag')" ondragleave="this.classList.remove('drag')" ondrop="hdrop(event)">‚Üë CSV / TXT ablegen (Moxfield, Manabox, plain)</div>
    <input type="file" id="fi" accept=".csv,.txt" style="display:none">
    <div id="ci2" style="display:none;margin-top:8px;font-size:11px;font-family:'JetBrains Mono',monospace;color:var(--gold);align-items:center;gap:10px">
      <span id="ciTxt"></span>
      <button id="ciClr" style="background:none;border:none;color:var(--t3);cursor:pointer;text-decoration:underline;font-size:12px;font-family:'Libre Baskerville',serif;touch-action:manipulation">Entfernen</button>
    </div>
  </div>
</div>

<!-- PAGE 2 -->
<div class="page" id="p2">
  <h1 class="ptit">Themes & Tags</h1>
  <p class="psub">EDHREC-Daten f√ºr deinen Commander ‚Äî w√§hle bis zu 2 Themes</p>
  <div id="p2mini"></div>
  <div class="lbl" style="margin-top:0">EDHREC Archetypen</div>
  <div class="edh-stat"><div class="edh-dot" id="edd"></div><span id="edtxt">Lade‚Ä¶</span></div>
  <div class="sel-bar" id="selbar"><span style="font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--t4)">Noch nichts ausgew√§hlt ‚Äî bis zu 2 Themes</span></div>
  <div class="tgrid" id="tgrid"></div>
  <div class="lbl">Bekannte Kombos</div>
  <div class="tgrid" id="cgrid"></div>
  <div class="pnav">
    <button class="btng" id="p2b">‚Üê Zur√ºck</button>
    <button class="btn" id="p2n">Weiter ‚Üí</button>
  </div>
</div>

<!-- PAGE 3 -->
<div class="page" id="p3">
  <h1 class="ptit">Powerlevel & Optionen</h1>
  <p class="psub">Bracket und Karten-Optionen sind unabh√§ngig voneinander w√§hlbar</p>

  <div class="lbl" style="margin-top:0">Power-Bracket <span style="color:var(--t4);font-size:9px;text-transform:none;letter-spacing:0;font-weight:400">‚Äî bestimmt nur das Spielniveau, nicht welche Karten erlaubt sind</span></div>
  <div class="bgrid" id="bg"></div>

  <div class="lbl">Karten-Optionen <span style="color:var(--t4);font-size:9px;text-transform:none;letter-spacing:0;font-weight:400">‚Äî unabh√§ngig vom Bracket w√§hlbar</span></div>
  <div class="opts" id="opts"></div>

  <div class="lbl">L√§nderzahl</div>
  <div class="land-row">
    <div class="land-n" id="ln">36</div>
    <div class="land-side">
      <input class="land-sl" type="range" id="lsl" min="30" max="42" value="36" step="1">
      <div class="land-hint">L√§nder im Deck (30‚Äì42)</div>
      <div class="land-rec" id="lrec">Empfehlung: 36</div>
    </div>
  </div>

  <div class="lbl">Budget</div>
  <div class="bgrid2" id="budg"></div>
  <div class="custom-price">
    <input class="cp-inp" id="cpMin" type="number" min="0" placeholder="Min ‚Ç¨ (leer = 0)">
    <span style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--t3)">bis</span>
    <input class="cp-inp" id="cpMax" type="number" min="0" placeholder="Max ‚Ç¨ (leer = unbegrenzt)">
    <button class="cp-btn" id="cpSet">Setzen</button>
  </div>
  <div id="priceHint" style="font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--gold);margin-bottom:14px;display:none"></div>

  <div class="sumbox" id="sumbox"></div>
  <div class="pnav">
    <button class="btng" id="p3b">‚Üê Zur√ºck</button>
    <button class="btn" id="p3g" disabled>Deck generieren ‚Üí</button>
  </div>
</div>

<!-- PAGE 4 -->
<div class="page" id="p4">
  <div id="p4l" style="display:none">
    <div class="lw">
      <div class="lring"></div>
      <div class="lt">Deck wird gebaut</div>
      <div class="lm" id="lmsg">Verbinde‚Ä¶</div>
      <div class="lbar"><div class="lfill" id="lfill"></div></div>
      <div class="llog" id="llog"></div>
    </div>
  </div>
  <div id="p4e" style="display:none">
    <div class="ebox">
      <div class="etit">Fehler</div>
      <div class="emsg" id="emsg"></div>
      <div style="display:flex;gap:8px;justify-content:center">
        <button class="btng" id="p4eb">‚Üê Zur√ºck</button>
        <button class="btn" id="p4er">Erneut</button>
      </div>
    </div>
  </div>
  <div id="p4r" style="display:none">
    <div class="dh">
      <img class="d-art" id="dart" src="" alt="" onerror="this.style.display='none'">
      <div class="d-info">
        <div class="d-title" id="dtit"></div>
        <div class="d-chips" id="dchips"></div>
        <div class="d-stats" id="dstats"></div>
      </div>
    </div>
    <div class="d-actions">
      <button class="btng" style="font-size:12px;padding:9px 14px;min-height:40px" id="adjBtn">‚Üê Anpassen</button>
      <button class="btng" style="font-size:12px;padding:9px 14px;min-height:40px;border-color:rgba(64,168,88,.3);color:#40a858" id="exAll">Export .txt</button>
    </div>
    <div class="chatbox">
      <div class="ch">
        <div class="c-orb">‚ú¶</div>
        <span class="c-tit">Deck-Assistent</span>
        <span class="c-hint">‚Äûmehr Auras" ¬∑ ‚Äûersetze Sol Ring" ¬∑ ‚Äûweniger Removal"</span>
      </div>
      <div class="cmsgs" id="cmsgs">
        <div class="cmsg a"><div class="cml">Assistent</div><div class="cmb">Deck fertig! Ich kann Karten hinzuf√ºgen, ersetzen oder entfernen.</div></div>
      </div>
      <div class="ctyp" id="ctyp">tippt‚Ä¶</div>
      <div class="cinr">
        <input class="cinp" id="cinp" placeholder="z.B. ‚Äûf√ºge 5 Auras hinzu"" autocomplete="off">
        <button class="csnd" id="csnd">‚Üí</button>
      </div>
    </div>
    <div id="dsecs"></div>
  </div>
  <div class="panel" id="panel">
    <div class="prow">
      <div class="p-info">
        <div class="p-cnt"><span id="pcnt">0</span>/100</div>
        <div class="p-sub" id="psub">Karten ausw√§hlen</div>
        <div class="p-prog"><div class="p-fill" id="pfill"></div></div>
      </div>
      <div class="p-btns">
        <button class="pb pb-a" id="pea">Alles</button>
        <button class="pb pb-s" id="pes">Auswahl</button>
      </div>
    </div>
  </div>
</div>

</main>

<script>
'use strict';
// ‚îÄ‚îÄ CONSTANTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SF = 'https://api.scryfall.com';
// CORS proxies to try for EDHREC
const PROXIES = [
  u => `https://corsproxy.io/?url=${encodeURIComponent(u)}`,
  u => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
  u => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(u)}`,
];

const GC = new Set(['Black Lotus','Ancestral Recall','Time Walk','Mox Pearl','Mox Sapphire','Mox Jet','Mox Ruby','Mox Emerald','Mana Crypt','Mana Vault','Grim Monolith','Chrome Mox','Mox Diamond','Mox Opal','Jeweled Lotus','Demonic Tutor','Vampiric Tutor','Imperial Seal','Mystical Tutor','Enlightened Tutor','Worldly Tutor','Sylvan Tutor','Necropotence','Ad Nauseam','Timetwister','Time Spiral','Wheel of Fortune','Cyclonic Rift','Expropriate','Armageddon','Ravages of War',"Thassa's Oracle",'Doomsday','Demonic Consultation','Tainted Pact','Flash','Protean Hulk','Seedborn Muse','Rhystic Study','Smothering Tithe',"Teferi's Protection",'Omniscience','Craterhoof Behemoth','Triumph of the Hordes','Doubling Season','Parallel Lives','Food Chain','Survival of the Fittest',"Yawgmoth's Will",'Underworld Breach',"Sensei's Divining Top",'Fierce Guardianship','Deflecting Swipe','Deadly Rollick','Flawless Maneuver',"Bolas's Citadel",'Isochron Scepter','Hermit Druid','Hullbreacher','Opposition Agent','Narset, Parter of Veils','Leovold, Emissary of Trest','Winter Orb','Static Orb','Stasis']);
const COMBO = new Set(['Isochron Scepter','Dramatic Reversal','Basalt Monolith','Rings of Brighthearth','Palinchron','Deadeye Navigator','Nim Deathmantle',"Ashnod's Altar",'Phyrexian Altar','Mikaeus, the Unhallowed','Triskelion','Walking Ballista','Devoted Druid','Vizier of Remedies','Kiki-Jiki, Mirror Breaker','Splinter Twin','Deceiver Exarch','Pestermite','Exquisite Blood','Sanguine Bond','Vito, Thorn of the Dusk Rose','Heliod, Sun-Crowned','Food Chain',"Thassa's Oracle",'Demonic Consultation','Tainted Pact']);

const BR=[
  {id:1,l:'Casual',   c:'#40a858',d:'Pre-Con Niveau'},
  {id:2,l:'Focused',  c:'#4888d0',d:'Klare Strategie'},
  {id:3,l:'Optimized',c:'#c89030',d:'Starke Synergien'},
  {id:4,l:'cEDH',     c:'#c04848',d:'Turn 3-4 Win'},
  {id:5,l:'cEDH+',    c:'#9030a0',d:'Proxies OK'},
];

// Options are now FULLY independent from bracket
const OPTS=[
  {id:'gc',   n:'Gamechanger-Karten', ico:'‚ö†', danger:true},
  {id:'combo',n:'Infinite Kombos',    ico:'‚àû', danger:true},
  {id:'tutor',n:'Alle Tutoren',       ico:'üîç',danger:false},
  {id:'stax', n:'Stax',               ico:'‚õì',danger:false},
  {id:'extra',n:'Extra Turns',        ico:'‚è©',danger:false},
  {id:'mld',  n:'Mass Land Destroy',  ico:'üí•',danger:true},
  {id:'wheel',n:'Wheel Effects',      ico:'üé°',danger:false},
  {id:'proxy',n:'Proxies erlaubt',    ico:'üìã',danger:false},
];

const BUDGETS=[
  {id:'xs',l:'< 10 ‚Ç¨',   lo:0,  hi:10,   c:'#40a858'},
  {id:'s', l:'10‚Äì30 ‚Ç¨',  lo:0,  hi:30,   c:'#34c890'},
  {id:'m', l:'30‚Äì100 ‚Ç¨', lo:0,  hi:100,  c:'#4888d0'},
  {id:'l', l:'100‚Äì300 ‚Ç¨',lo:0,  hi:300,  c:'#9060d0'},
  {id:'xl',l:'300‚Äì800 ‚Ç¨',lo:0,  hi:800,  c:'#c89030'},
  {id:'op',l:'Kein Limit',lo:0, hi:9999, c:'#c04848'},
];

const COLORS={W:'#f5e8c0',U:'#4a90d8',B:'#7850b8',R:'#d06030',G:'#40a858',C:'#888aa8'};
const CN={W:'Wei√ü',U:'Blau',B:'Schwarz',R:'Rot',G:'Gr√ºn',C:'Farblos'};
const BASICS={W:'Plains',U:'Island',B:'Swamp',R:'Mountain',G:'Forest'};
const SECS=[
  {k:'Creature',    l:'Kreaturen',      i:'‚öî'},
  {k:'Instant',     l:'Sofortzauber',   i:'‚ö°'},
  {k:'Sorcery',     l:'Hexerei',        i:'‚ú¶'},
  {k:'Enchantment', l:'Verzauberungen', i:'‚óé'},
  {k:'Artifact',    l:'Artefakte',      i:'‚öô'},
  {k:'Planeswalker',l:'Planeswalker',   i:'‚óà'},
  {k:'Land',        l:'L√§nder',         i:'‚õ∞'},
  {k:'Other',       l:'Sonstige',       i:'¬∑'},
];

// Comprehensive built-in theme list (used as fallback if EDHREC unavailable)
const BUILTIN_THEMES = [
  {l:'Voltron',        s:'voltron',        i:'‚öî', d:'Auras & Equipment auf Commander'},
  {l:'Auras',          s:'auras',          i:'‚óé', d:'Enchant creatures'},
  {l:'Enchantress',    s:'enchantress',    i:'‚óé', d:'Vorteil durch Verzauberungen'},
  {l:'Equipment',      s:'equipment',      i:'‚öô', d:'Ausr√ºstungen'},
  {l:'Tokens',         s:'tokens',         i:'‚¨°', d:'Token-Strategien'},
  {l:'Reanimator',     s:'reanimator',     i:'‚Ä†', d:'Aus dem Friedhof'},
  {l:'Aristocrats',    s:'aristocrats',    i:'‚ô¶', d:'Sacrifice-Vorteil'},
  {l:'Stax',           s:'stax',           i:'‚õì', d:'Einschr√§nkungen setzen'},
  {l:'Combo',          s:'combo',          i:'‚àû', d:'Infinite Kombos'},
  {l:'Spellslinger',   s:'spellslinger',   i:'‚ö°', d:'Instants & Sorceries'},
  {l:'Graveyard',      s:'graveyard',      i:'‚ö∞', d:'Friedhof-Mechaniken'},
  {l:'Landfall',       s:'landfall',       i:'‚õ∞', d:'Land kommt ins Spiel'},
  {l:'Blink',          s:'blink',          i:'‚Üª', d:'ETB-Effekte wiederholen'},
  {l:'Tribal',         s:'tribal',         i:'‚òÖ', d:'Kreatur-Typen-Synergien'},
  {l:'+1/+1 Counters', s:'counters',       i:'+', d:'Counter-Strategien'},
  {l:'Infect',         s:'infect',         i:'‚ò†', d:'Gift-Schaden'},
  {l:'Storm',          s:'storm',          i:'üå™', d:'Viele Zauber pro Zug'},
  {l:'Lifegain',       s:'lifegain',       i:'‚ô•', d:'Leben gewinnen'},
  {l:'Theft',          s:'theft',          i:'‚óà', d:'Gegnerische Karten √ºbernehmen'},
  {l:'Big Mana',       s:'bigmana',        i:'üíé', d:'Viel Mana erzeugen'},
  {l:'Ramp',           s:'ramp',           i:'‚õ∞', d:'Mana beschleunigen'},
  {l:'Control',        s:'control',        i:'üõ°', d:'Kontrolle & Antworten'},
  {l:'Sacrifice',      s:'sacrifice',      i:'ü©∏', d:'Opfern als Ressource'},
];

// Theme icon map
const TICO={'voltron':'‚öî','aura':'‚óé','auras':'‚óé','enchantress':'‚óé','enchantment':'‚óé','equipment':'‚öô','tokens':'‚¨°','token':'‚¨°','reanimator':'‚Ä†','reanimate':'‚Ä†','aristocrats':'‚ô¶','sacrifice':'ü©∏','stax':'‚õì','combo':'‚àû','spellslinger':'‚ö°','graveyard':'‚ö∞','landfall':'‚õ∞','blink':'‚Üª','tribal':'‚òÖ','counters':'+','infect':'‚ò†','storm':'üå™','lifegain':'‚ô•','theft':'‚óà','big':'üíé','ramp':'‚õ∞','control':'üõ°'};
function ticon(lbl){const k=lbl.toLowerCase().replace(/[^a-z ]/g,'').trim();for(const[p,i]of Object.entries(TICO))if(k.includes(p))return i;return'‚úß';}

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const S={
  cmd:null, bracket:null, opts:[], budget:null,
  priceMin:0, priceMax:9999,
  landCount:36, themes:[], coll:null, collMode:false,
  edhData:null, deck:[], sel:new Set(),
};

// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const esc=s=>String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
const slp=ms=>new Promise(r=>setTimeout(r,ms));
const gi=(c,z)=>c.image_uris?.[z]||c.card_faces?.[0]?.image_uris?.[z]||null;
const eur=c=>parseFloat(c.prices?.eur||c.prices?.eur_foil||0)||null;
const feur=p=>!p?null:p<.05?'< 0,05 ‚Ç¨':p.toFixed(2).replace('.',',')+' ‚Ç¨';

function tap(el,fn){
  if(!el)return;
  let mv=false;
  el.addEventListener('touchstart',()=>{mv=false},{passive:true});
  el.addEventListener('touchmove',()=>{mv=true},{passive:true});
  el.addEventListener('touchend',ev=>{if(mv)return;ev.preventDefault();fn();},{passive:false});
  el.addEventListener('click',fn);
}

function mana(cost){
  if(!cost)return'';
  return(cost.match(/\{[^}]+\}/g)||[]).map(t=>{
    const v=t.slice(1,-1);
    let c='ms-n',d=v;
    if(v==='W'){c='ms-W';d='W';}else if(v==='U'){c='ms-U';d='U';}
    else if(v==='B'){c='ms-B';d='B';}else if(v==='R'){c='ms-R';d='R';}
    else if(v==='G'){c='ms-G';d='G';}else if(v==='C'){c='ms-C';d='‚óá';}
    else if(v==='X'){c='ms-X';d='X';}
    else if(/^\d+$/.test(v)){c='ms-n';d=v;}
    else if(v.includes('/')){c='ms-'+v[0];d=v;}
    return`<span class="ms ${c}">${d}</span>`;
  }).join('');
}

// ‚îÄ‚îÄ SCRYFALL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function sfetch(path){
  const r=await fetch(SF+path,{mode:'cors'});
  if(!r.ok)throw new Error('SF '+r.status);
  return r.json();
}
async function sfSearch(q,n=20){
  try{const d=await sfetch('/cards/search?q='+encodeURIComponent(q)+'&order=edhrec&unique=cards');return(d.data||[]).slice(0,n);}
  catch{return[];}
}
async function sfNamed(name){
  try{return await sfetch('/cards/named?fuzzy='+encodeURIComponent(name));}catch{return null;}
}

// ‚îÄ‚îÄ EDHREC via CORS PROXY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function edhSlug(name){
  return name.toLowerCase().replace(/['']/g,'').replace(/,/g,'')
    .replace(/[^a-z0-9 -]/g,'').trim().replace(/\s+/g,'-');
}

async function fetchEDH(cmd){
  const slug=edhSlug(cmd.name);
  const url=`https://json.edhrec.com/pages/commanders/${slug}.json`;
  // Try direct first (works if CORS is open on their end)
  for(const proxy of[u=>u,...PROXIES]){
    try{
      const r=await fetch(proxy(url),{mode:'cors',headers:{Accept:'application/json'}});
      if(r.ok){const d=await r.json();if(d&&(d.container||d.cardlists))return d;}
    }catch{}
  }
  throw new Error('EDHREC nicht erreichbar');
}

async function fetchEDHTheme(cmd,slug){
  const cslug=edhSlug(cmd.name);
  const url=`https://json.edhrec.com/pages/commanders/${cslug}/${slug}.json`;
  for(const proxy of[u=>u,...PROXIES]){
    try{
      const r=await fetch(proxy(url),{mode:'cors'});
      if(r.ok){const d=await r.json();if(d&&(d.container||d.cardlists))return d;}
    }catch{}
  }
  throw new Error('Theme '+slug+' nicht verf√ºgbar');
}

function parseEDHCards(data){
  const cards=[];
  try{
    const jd=data.container?.json_dict||data;
    const lists=jd.cardlists||data.cardlists||[];
    lists.forEach(sec=>(sec.cardviews||[]).forEach(cv=>{
      if(cv.name)cards.push({name:cv.name,synergy:cv.synergy||0,numDecks:cv.num_decks||0,type:cv.primary_type||''});
    }));
  }catch{}
  return cards;
}

function parseEDHThemes(data){
  const out=[],seen=new Set();
  const add=(label,href,count)=>{
    if(!label||seen.has(label))return;
    seen.add(label);
    const slug=(href||'').split('/').pop().replace(/\.json$/,'');
    if(slug)out.push({l:label,s:slug,cnt:count||0,i:ticon(label)});
  };
  // path 1 ‚Äî panels.links
  try{Object.values(data.container?.panels?.links||{}).flat().forEach(l=>add(l.label,l.href,l.num_decks));}catch{}
  // path 2 ‚Äî json_dict.taglinks
  try{(data.container?.json_dict?.taglinks||[]).forEach(t=>add(t.label||t.tag,t.href||t.slug,t.num_decks));}catch{}
  // path 3 ‚Äî relatedinfo
  try{(data.relatedinfo?.themes||data.related_info?.themes||[]).forEach(t=>add(t.label,t.href,t.num_decks));}catch{}
  // path 4 ‚Äî panels itself as array
  try{
    const p=data.container?.panels||{};
    (p.taglinks||p.themes||[]).forEach(t=>add(t.label||t.value,t.href||t.slug,t.count||t.num_decks));
  }catch{}
  return out.sort((a,b)=>b.cnt-a.cnt);
}

function parseEDHCombos(data){
  const out=[];
  try{
    const p=data.container?.panels||{};
    (p.combos||p['combos']||[]).forEach(c=>out.push({l:c.label||c.name||'',cnt:c.num_decks||0}));
    (data.container?.json_dict?.combos||[]).forEach(c=>out.push({l:c.label||c.name||'',cnt:c.num_decks||0}));
  }catch{}
  return out.slice(0,10);
}

// ‚îÄ‚îÄ THEME ‚Üí SCRYFALL QUERY MAP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function themeQ(themes,ci,hi,comboOk){
  const cs=ci.join('')||'C';
  const pr=hi<9999?` eur<=${hi}`:'';
  const base=`id<=${cs} -is:land -is:dfc game:paper${pr}`;
  const map={
    'voltron':  `${base} (type:aura OR type:equipment)`,
    'auras':    `${base} type:aura`,
    'aura':     `${base} type:aura`,
    'enchantress':`${base} (type:enchantment OR o:"enchantress")`,
    'equipment':`${base} type:equipment`,
    'tokens':   `${base} o:"create" o:"token"`,
    'token':    `${base} o:"create" o:"token"`,
    'reanimator':`${base} (o:"from your graveyard" OR o:"unearth" OR o:"dredge")`,
    'reanimate':`${base} (o:"from your graveyard" OR o:"unearth")`,
    'graveyard':`${base} (o:"flashback" OR o:"unearth" OR o:"dredge")`,
    'landfall': `${base} o:"landfall"`,
    'combo':    comboOk?`${base} (o:"untap" o:"whenever") cmc<=4`:`${base} type:creature cmc<=4`,
    'stax':     `${base} (o:"opponent" o:"can't") type:permanent`,
    'tribal':   `${base} type:creature cmc<=4`,
    'blink':    `${base} (o:"exile" o:"return to the battlefield")`,
    'aristocrats':`${base} (o:"whenever a creature" o:"dies")`,
    'sacrifice':`${base} (o:"sacrifice" o:"whenever")`,
    'spellslinger':`${base} o:"whenever you cast" (o:"instant or sorcery")`,
    'artifacts':`${base} type:artifact`,
    'artifact': `${base} type:artifact`,
    'counters': `${base} o:"+1/+1 counter" o:"whenever"`,
    'infect':   `${base} o:"infect"`,
    'storm':    `${base} (o:"storm" OR (o:"whenever you cast" o:"this turn"))`,
    'lifegain': `${base} o:"you gain" o:"life" o:"whenever"`,
    'theft':    `${base} o:"gain control"`,
    'bigmana':  `${base} type:creature cmc>=6`,
    'big mana': `${base} type:creature cmc>=6`,
    'ramp':     `${base} (type:sorcery o:"search" o:"land")`,
    'control':  `${base} type:instant o:"counter target"`,
    'big':      `${base} type:creature cmc>=6`,
  };
  for(const t of themes){
    const k=t.l.toLowerCase().replace(/[^a-z0-9 ]/g,'').trim();
    if(map[k])return map[k];
    for(const[mk,q]of Object.entries(map))if(k.includes(mk)||mk.includes(k))return q;
  }
  return`${base} type:creature o:"whenever" cmc<=5`;
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('load',()=>{
  // Search
  const inp=document.getElementById('si');
  let tmr=null,lastQ='';
  inp.addEventListener('input',function(){
    const v=this.value.trim();
    document.getElementById('scl').style.display=v?'flex':'none';
    clearTimeout(tmr);
    if(v.length<2){hideDrop();return;}
    if(v===lastQ)return;lastQ=v;
    showSpin(true);
    tmr=setTimeout(()=>doSearch(v),420);
  });
  inp.addEventListener('keydown',ev=>{if(ev.key==='Escape')hideDrop();});
  document.addEventListener('touchstart',ev=>{if(!document.getElementById('sw').contains(ev.target))hideDrop();},{passive:true});
  document.addEventListener('click',ev=>{if(!document.getElementById('sw').contains(ev.target))hideDrop();});
  tap(document.getElementById('scl'),clearSearch);
  tap(document.getElementById('dz'),()=>document.getElementById('fi').click());
  document.getElementById('fi').addEventListener('change',function(){loadFile(this.files[0]);});
  tap(document.getElementById('ciClr'),clearColl);
  tap(document.getElementById('p2b'),()=>nav(1));
  tap(document.getElementById('p2n'),()=>nav(3));
  tap(document.getElementById('p3b'),()=>nav(2));
  tap(document.getElementById('p3g'),genDeck);
  document.getElementById('lsl').addEventListener('input',function(){S.landCount=+this.value;document.getElementById('ln').textContent=this.value;landRec();renderSum();});
  // Custom price
  tap(document.getElementById('cpSet'),setCustomPrice);
  tap(document.getElementById('p4eb'),()=>nav(3));
  tap(document.getElementById('p4er'),genDeck);
  tap(document.getElementById('adjBtn'),()=>{nav(3);document.getElementById('p4r').style.display='none';});
  tap(document.getElementById('exAll'),exportAll);
  tap(document.getElementById('pea'),exportAll);
  tap(document.getElementById('pes'),exportSel);
  const ci=document.getElementById('cinp');
  tap(document.getElementById('csnd'),()=>doChat(ci.value.trim()));
  ci.addEventListener('keydown',ev=>{if(ev.key==='Enter')doChat(ci.value.trim());});
});

// ‚îÄ‚îÄ SEARCH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function doSearch(q){
  try{const cards=await sfSearch(`is:commander name:${q} game:paper`,12);renderDrop(cards);}
  catch(e){showErr(e.message);}
  showSpin(false);
}
function renderDrop(cards){
  const d=document.getElementById('sd');
  if(!cards.length){d.style.display='none';return;}
  d.innerHTML='';
  cards.forEach(c=>{
    const img=gi(c,'small'),ci=c.color_identity||[];
    const el=document.createElement('div');el.className='di';
    el.innerHTML=(img?`<img class="di-img" src="${img}" alt="" loading="lazy" onerror="this.style.display='none'">`:'<div class="di-img"></div>')+
      `<div><div class="di-name">${esc(c.name)}${GC.has(c.name)?'<span style="color:var(--gold);font-size:7px;margin-left:4px">[GC]</span>':''}</div>`+
      `<div class="di-type">${esc((c.type_line||'').replace('Legendary ',''))}</div>`+
      `<div class="di-ci">${ci.map(x=>`<div class="ci" style="background:${COLORS[x]||'#888'}"></div>`).join('')}</div>`+
      (c.edhrec_rank?`<div class="di-rank">EDHREC #${c.edhrec_rank.toLocaleString('de')}</div>`:'')+
      `</div>`;
    el._card=c;
    el.addEventListener('touchend',ev=>{ev.preventDefault();pickCmd(el._card);});
    el.addEventListener('click',()=>pickCmd(el._card));
    d.appendChild(el);
  });
  d.style.display='block';
}
function hideDrop(){document.getElementById('sd').style.display='none';}
function showSpin(on){document.getElementById('ssp').style.display=on?'block':'none';}
function showErr(msg){const el=document.getElementById('serr');el.textContent=msg;el.style.display='block';setTimeout(()=>el.style.display='none',4000);}
function clearSearch(){document.getElementById('si').value='';document.getElementById('scl').style.display='none';document.getElementById('cprev').style.display='none';hideDrop();S.cmd=null;}

function pickCmd(c){
  S.cmd=c;hideDrop();
  document.getElementById('si').value=c.name;
  document.getElementById('scl').style.display='flex';
  renderCmdr(c);
}
function renderCmdr(c){
  const ci=c.color_identity||[];
  const bar=ci.length?ci.map(x=>COLORS[x]||'#555').join(','):'#c89030';
  const el=document.getElementById('cprev');
  el.innerHTML=`<div class="cc">
    <div class="cc-bar" style="background:linear-gradient(to bottom,${bar})"></div>
    ${gi(c,'normal')?`<img class="cc-art" src="${gi(c,'normal')}" alt="" onerror="this.style.display='none'">`:''}
    <div class="cc-body">
      <div class="cc-name">${esc(c.name)}</div>
      <div class="cc-type">${esc((c.type_line||'').replace('Legendary ',''))}</div>
      <div class="cc-mana">${mana(c.mana_cost||'')}${ci.map(x=>`<span style="font-size:9px;color:${COLORS[x]};font-family:'JetBrains Mono',monospace;margin-left:3px">${CN[x]||x}</span>`).join('')}</div>
      ${c.oracle_text?`<div class="cc-oracle">${esc(c.oracle_text.slice(0,180))}${c.oracle_text.length>180?'‚Ä¶':''}</div>`:''}
      <div class="cc-meta">${c.edhrec_rank?`<span class="cc-edh">EDHREC #${c.edhrec_rank.toLocaleString('de')}</span>`:''}${eur(c)?`<span class="cc-price">~${feur(eur(c))} (Cardmarket)</span>`:''}</div>
      <div style="margin-top:10px"><button class="btn" id="goT">Themes w√§hlen ‚Üí</button></div>
    </div>
  </div>`;
  el.style.display='block';
  tap(document.getElementById('goT'),()=>nav(2));
}

// ‚îÄ‚îÄ COLLECTION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function hdrop(ev){ev.preventDefault();document.getElementById('dz').classList.remove('drag');loadFile(ev.dataTransfer.files[0]);}
function loadFile(f){
  if(!f)return;
  const r=new FileReader();
  r.onload=ev=>{
    const set=parseColl(ev.target.result);
    if(!set.size){alert('Keine Karten erkannt.');return;}
    S.coll=new Set([...set].map(n=>n.toLowerCase()));S.collMode=true;
    const dz=document.getElementById('dz');dz.classList.add('loaded');dz.textContent=set.size+' Karten geladen ‚úì';
    document.getElementById('ci2').style.display='flex';document.getElementById('ciTxt').textContent=set.size+' Karten';
  };r.readAsText(f);
}
function parseColl(txt){
  const out=new Set();
  txt.split(/\r?\n/).map(l=>l.trim()).filter(Boolean).forEach(line=>{
    if(/^[/#]/.test(line)||/^(name|qty|quantity|card)/i.test(line))return;
    let name=null;
    if(line.includes(','))name=line.split(',').map(x=>x.replace(/"/g,'').trim()).find(x=>x.length>1&&isNaN(+x));
    else{const m=line.match(/^(?:\d+[xX]?\s+)?(.+?)(?:\s+\(.*\))?$/);if(m)name=m[1].trim();}
    if(name&&name.length>1&&name.length<120)out.add(name);
  });return out;
}
function clearColl(){S.coll=null;S.collMode=false;const dz=document.getElementById('dz');dz.classList.remove('loaded');dz.textContent='‚Üë CSV / TXT ablegen (Moxfield, Manabox, plain)';document.getElementById('ci2').style.display='none';}
function owned(n){return!S.collMode||!S.coll||S.coll.has(n.toLowerCase());}

// ‚îÄ‚îÄ PAGE 2: THEMES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function setupP2(){
  const c=S.cmd;S.themes=[];
  document.getElementById('p2mini').innerHTML=`<div style="display:flex;align-items:center;gap:10px;background:var(--s1);border:1px solid var(--l1);border-radius:8px;padding:9px 12px;margin-bottom:16px">
    ${gi(c,'small')?`<img src="${gi(c,'small')}" style="width:22px;height:32px;border-radius:2px;object-fit:cover;object-position:top">`:''}
    <div><div style="font-family:'Cinzel',serif;font-size:12px;font-weight:700">${esc(c.name)}</div><div style="display:flex;gap:3px;margin-top:3px">${mana(c.mana_cost||'')}</div></div>
    <div style="margin-left:auto;font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--t3)">${c.edhrec_rank?'EDHREC #'+c.edhrec_rank.toLocaleString('de'):''}</div>
  </div>`;
  document.getElementById('tgrid').innerHTML='<span style="font-family:\'JetBrains Mono\',monospace;font-size:9px;color:var(--t4)">Lade EDHREC‚Ä¶</span>';
  document.getElementById('cgrid').innerHTML='';
  document.getElementById('selbar').innerHTML='<span style="font-family:\'JetBrains Mono\',monospace;font-size:9px;color:var(--t4)">Noch nichts ausgew√§hlt</span>';
  document.getElementById('edd').className='edh-dot';
  document.getElementById('edtxt').textContent='Lade EDHREC-Daten f√ºr '+c.name+'‚Ä¶';

  try{
    const data=await fetchEDH(c);S.edhData=data;
    let themes=parseEDHThemes(data);
    const combos=parseEDHCombos(data);
    document.getElementById('edd').className='edh-dot ok';
    if(themes.length){
      document.getElementById('edtxt').textContent=themes.length+' Themes von EDHREC ‚Äî w√§hle bis zu 2:';
      renderThemes(themes,combos);
    }else{
      document.getElementById('edtxt').textContent='EDHREC erreichbar, aber keine Theme-Links ‚Äî verwende eingebaute Liste:';
      renderThemes(BUILTIN_THEMES.map(t=>({l:t.l,s:t.s,cnt:0,i:t.i})),combos);
    }
  }catch(e){
    document.getElementById('edd').className='edh-dot err';
    document.getElementById('edtxt').textContent='EDHREC nicht erreichbar ‚Äî eingebaute Themes:';
    renderThemes(BUILTIN_THEMES.map(t=>({l:t.l,s:t.s,cnt:0,i:t.i})),[]);
  }
}

function renderThemes(themes,combos){
  const g=document.getElementById('tgrid');g.innerHTML='';
  themes.forEach(t=>{
    const d=document.createElement('div');d.className='ttag';
    d.innerHTML=`<span class="tt-icon">${t.i||ticon(t.l)}</span><span class="tt-name">${esc(t.l)}</span>${t.cnt?`<span class="tt-cnt">${t.cnt.toLocaleString('de')} Decks</span>`:''}`;
    d._t=t;
    d.addEventListener('touchend',ev=>{ev.preventDefault();togTheme(d._t,d);});
    d.addEventListener('click',()=>togTheme(d._t,d));
    g.appendChild(d);
  });
  const cg=document.getElementById('cgrid');
  if(combos.length){combos.forEach(c=>{
    const d=document.createElement('div');d.className='ttag';d.style.opacity='.5';d.style.cursor='default';
    d.innerHTML=`<span class="tt-icon">‚àû</span><span class="tt-name">${esc(c.l)}</span>${c.cnt?`<span class="tt-cnt">${c.cnt.toLocaleString('de')} Decks</span>`:''}`;
    cg.appendChild(d);
  });}else{cg.innerHTML='<span style="font-family:\'JetBrains Mono\',monospace;font-size:9px;color:var(--t4)">Keine Kombos gefunden</span>';}
}

function togTheme(t,el){
  const idx=S.themes.findIndex(x=>x.l===t.l);
  if(idx>=0){S.themes.splice(idx,1);}
  else{
    if(S.themes.length>=2){
      const rem=S.themes.shift();
      document.querySelectorAll('.ttag').forEach(e=>{if(e._t?.l===rem.l)e.classList.remove('s1','s2');});
    }
    S.themes.push(t);
  }
  document.querySelectorAll('.ttag').forEach(e=>{
    e.classList.remove('s1','s2');
    const i=S.themes.findIndex(x=>x.l===e._t?.l);
    if(i===0)e.classList.add('s1');else if(i===1)e.classList.add('s2');
  });
  const bar=document.getElementById('selbar');
  if(!S.themes.length)bar.innerHTML='<span style="font-family:\'JetBrains Mono\',monospace;font-size:9px;color:var(--t4)">Noch nichts ausgew√§hlt</span>';
  else bar.innerHTML=S.themes.map((t,i)=>`<span class="sel-chip ${i===0?'sc1':'sc2'}">${t.i||ticon(t.l)} ${esc(t.l)}${t.cnt?` ¬∑ ${t.cnt.toLocaleString('de')} Decks`:''}</span>`).join('');
}

// ‚îÄ‚îÄ PAGE 3: BRACKET + OPTIONS + LANDS + BUDGET ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setupP3(){
  // BRACKET
  const bg=document.getElementById('bg');bg.innerHTML='';
  BR.forEach(b=>{
    const d=document.createElement('div');d.className='bcard';d.id='br'+b.id;d.style.setProperty('--bc',b.c);
    d.innerHTML=`<div class="b-num">${b.id}</div><div class="b-lbl">${b.l}</div>`;
    d._id=b.id;
    d.addEventListener('touchend',ev=>{ev.preventDefault();selBr(d._id);});
    d.addEventListener('click',()=>selBr(d._id));
    bg.appendChild(d);
  });
  if(S.bracket)document.getElementById('br'+S.bracket)?.classList.add('sel');

  // OPTIONS ‚Äî completely independent
  const og=document.getElementById('opts');og.innerHTML='';
  OPTS.forEach(o=>{
    const d=document.createElement('div');
    d.className='opill'+(o.danger?' danger':'');d.id='op'+o.id;
    d.innerHTML=`<span class="op-ico">${o.ico}</span>${o.n}`;
    if(S.opts.includes(o.id))d.classList.add('on');
    d._id=o.id;
    d.addEventListener('touchend',ev=>{ev.preventDefault();togOpt(d._id);});
    d.addEventListener('click',()=>togOpt(d._id));
    og.appendChild(d);
  });

  // BUDGET
  const budg=document.getElementById('budg');budg.innerHTML='';
  BUDGETS.forEach(b=>{
    const d=document.createElement('div');d.className='bud';d.id='bu'+b.id;
    d.innerHTML=`<div class="bud-dot" style="background:${b.c}"></div><span class="bud-l">${b.l}</span>`;
    if(S.budget===b.id){d.classList.add('sel');d.style.borderColor=b.c;}
    d._id=b.id;
    d.addEventListener('touchend',ev=>{ev.preventDefault();selBud(d._id);});
    d.addEventListener('click',()=>selBud(d._id));
    budg.appendChild(d);
  });

  landRec();renderSum();chkP3();
}
function selBr(id){S.bracket=id;document.querySelectorAll('.bcard').forEach(e=>e.classList.remove('sel'));const el=document.getElementById('br'+id);el.classList.add('sel');chkP3();renderSum();}
function togOpt(id){const el=document.getElementById('op'+id);if(S.opts.includes(id)){S.opts=S.opts.filter(x=>x!==id);el.classList.remove('on');}else{S.opts.push(id);el.classList.add('on');}}
function selBud(id){
  S.budget=id;
  document.querySelectorAll('.bud').forEach(e=>{e.classList.remove('sel');e.style.borderColor='';});
  const b=BUDGETS.find(x=>x.id===id);
  const el=document.getElementById('bu'+id);el.classList.add('sel');el.style.borderColor=b.c;
  S.priceMin=b.lo;S.priceMax=b.hi;
  document.getElementById('cpMin').value='';document.getElementById('cpMax').value='';
  document.getElementById('priceHint').style.display='none';
  chkP3();renderSum();
}
function setCustomPrice(){
  const mn=parseFloat(document.getElementById('cpMin').value)||0;
  const mx=parseFloat(document.getElementById('cpMax').value)||9999;
  S.priceMin=mn;S.priceMax=mx;S.budget='custom';
  document.querySelectorAll('.bud').forEach(e=>{e.classList.remove('sel');e.style.borderColor='';});
  const h=document.getElementById('priceHint');
  h.textContent=`Eigene Spanne: ${mn===0?'0':mn.toFixed(2)} ‚Ç¨ ‚Äì ${mx>=9999?'‚àû':mx.toFixed(2)+' ‚Ç¨'}`;
  h.style.display='block';
  chkP3();renderSum();
}
function chkP3(){document.getElementById('p3g').disabled=!(S.bracket&&(S.budget||S.budget==='custom'));}
function landRec(){
  const c=S.cmd;if(!c)return;
  const cmc=c.cmc||3,nc=(c.color_identity||[]).length;
  let rec=36;if(cmc<=2)rec=33;else if(cmc<=3)rec=35;else if(cmc>=5)rec=38;if(nc>=4)rec=Math.max(rec,37);
  document.getElementById('lrec').textContent=`Empfehlung: ${rec} (MK ${cmc}, ${nc} Farbe${nc!==1?'n':''})`;
}
function renderSum(){
  const b=BR.find(x=>x.id===S.bracket);
  const ci=S.cmd?.color_identity||[];
  const priceStr=S.budget==='custom'?`${S.priceMin}‚Äì${S.priceMax>=9999?'‚àû':S.priceMax} ‚Ç¨`:
    BUDGETS.find(x=>x.id===S.budget)?.l||'‚Äî';
  document.getElementById('sumbox').innerHTML=
    '<div class="lbl" style="margin-top:0;margin-bottom:10px">Zusammenfassung</div>'+
    `<div class="sum-r"><span class="sum-k">Commander</span><span class="sum-v">${S.cmd?esc(S.cmd.name):'‚Äî'}</span></div>`+
    `<div class="sum-r"><span class="sum-k">Farben</span><span class="sum-v">${ci.map(c=>`<span style="color:${COLORS[c]}">${CN[c]}</span>`).join(' ¬∑ ')||'Farblos'}</span></div>`+
    `<div class="sum-r"><span class="sum-k">Themes</span><span class="sum-v" style="color:var(--gold)">${S.themes.length?S.themes.map(t=>esc(t.l)).join(' + '):'Generisch'}</span></div>`+
    `<div class="sum-r"><span class="sum-k">Bracket</span><span class="sum-v" style="color:${b?b.c:'#fff'}">${b?b.id+' ‚Äî '+b.l:'‚Äî'}</span></div>`+
    `<div class="sum-r"><span class="sum-k">Optionen</span><span class="sum-v" style="font-size:11px">${S.opts.length?S.opts.map(id=>OPTS.find(o=>o.id===id)?.n).join(', '):'Keine'}</span></div>`+
    `<div class="sum-r"><span class="sum-k">L√§nder</span><span class="sum-v">${S.landCount}</span></div>`+
    `<div class="sum-r"><span class="sum-k">Budget</span><span class="sum-v">${priceStr}</span></div>`;
}

// ‚îÄ‚îÄ DECK GENERATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function genDeck(){
  if(!S.bracket||(S.budget===null&&S.budget!=='custom')){alert('Bracket und Budget w√§hlen.');return;}
  nav(4);
  document.getElementById('p4l').style.display='block';
  document.getElementById('p4e').style.display='none';
  document.getElementById('p4r').style.display='none';
  document.getElementById('panel').style.display='none';
  S.deck=[];S.sel=new Set();

  const ci=S.cmd?.color_identity||[];
  const cs=ci.join('')||'C';
  const maxEur=S.priceMax;
  const minEur=S.priceMin;
  const pr=maxEur<9999?` eur<=${maxEur}`:'';
  const gcOk=S.opts.includes('gc');
  const comboOk=S.opts.includes('combo');
  const base=`id<=${cs} -is:land -is:dfc game:paper${pr}`;

  let pct=0;
  function log(msg,p){
    document.getElementById('lmsg').textContent=msg;
    pct=p||pct;document.getElementById('lfill').style.width=pct+'%';
    const li=document.createElement('div');li.className='lli';li.textContent='‚ñ∏ '+msg;
    document.getElementById('llog').appendChild(li);
  }

  try{
    const seen=new Set();
    function dedup(arr){return arr.filter(c=>{const n=c.name||c;if(seen.has(n))return false;seen.add(n);return true;});}
    function noGC(arr){return gcOk?arr:arr.filter(c=>!GC.has(c.name||c));}

    // Step 1: EDHREC data
    log('Lade EDHREC f√ºr '+S.cmd.name+'‚Ä¶',5);
    let edhMain=[],edhTheme=[];
    if(S.edhData)edhMain=parseEDHCards(S.edhData);
    else{try{const d=await fetchEDH(S.cmd);S.edhData=d;edhMain=parseEDHCards(d);}catch{}}

    for(const t of S.themes){
      if(!t.s)continue;
      log('EDHREC Theme: '+t.l+'‚Ä¶',12);
      try{const td=await fetchEDHTheme(S.cmd,t.s);edhTheme=[...edhTheme,...parseEDHCards(td)];}
      catch{log('Theme '+t.l+' nicht verf√ºgbar',12);}
      await slp(60);
    }

    // Build merged EDHREC pool (theme cards first, deduped, sorted by synergy)
    const allEdh=[...edhTheme,...edhMain];
    const edhPool=[];const edhSeen=new Set();
    allEdh.forEach(c=>{if(!edhSeen.has(c.name)){edhSeen.add(c.name);edhPool.push(c);}});
    edhPool.sort((a,b)=>(b.synergy||0)-(a.synergy||0));
    const pool=noGC(edhPool);

    async function pull(label,sfQ,n,typeHint){
      log(label+'‚Ä¶',pct+4);
      const fromEdh=pool.filter(c=>!seen.has(c.name)&&(!typeHint||typeHint(c))).slice(0,n);
      const r=dedup(fromEdh).map(c=>({name:c.name,type:c.type||'',manaCost:'',price:null,img:null,synergy:c.synergy||0,isGC:GC.has(c.name),isCombo:COMBO.has(c.name)}));
      const need=n-r.length;
      if(need>0&&sfQ){
        const sf=noGC(await sfSearch(sfQ,need+6));
        dedup(sf).slice(0,need).forEach(c=>r.push({name:c.name,type:c.type_line||'',manaCost:c.mana_cost||'',price:eur(c),img:gi(c,'small'),synergy:0,isGC:GC.has(c.name),isCombo:COMBO.has(c.name)}));
      }
      return r;
    }

    // Sol Ring
    if(!seen.has('Sol Ring')&&gcOk){
      const sr=await sfNamed('Sol Ring');
      if(sr){seen.add('Sol Ring');}
    } else if(!seen.has('Sol Ring')){
      const sr=await sfNamed('Sol Ring');
      if(sr){seen.add('Sol Ring');/* will add below */}
    }

    log('Mana-Ramp‚Ä¶',20);
    const ramp=await pull('Ramp',`${base} (o:"add {" o:"mana" OR (type:sorcery o:"search" o:"land")) cmc<=4`,10);
    // Add Sol Ring to front
    if(!ramp.find(c=>c.name==='Sol Ring')&&!seen.has('Sol Ring')){
      const sr=await sfNamed('Sol Ring');
      if(sr){seen.add('Sol Ring');ramp.unshift({name:'Sol Ring',type:'Artifact',manaCost:'{1}',price:eur(sr),img:gi(sr,'small'),synergy:99,isGC:GC.has('Sol Ring'),isCombo:false});}
    }
    await slp(60);

    log('Karten-Vorteil‚Ä¶',28);
    const draw=await pull('Draw',`${base} (o:"draw" o:"card") cmc<=5`,8);await slp(60);

    log('Removal‚Ä¶',35);
    const rem=await pull('Removal',`${base} (o:"destroy target" OR o:"exile target"${ci.includes('U')?' OR (type:instant o:"counter target")':\"\"}  OR o:"destroy all creatures") cmc<=6`,8);await slp(60);

    log('Theme-Synergien ('+S.themes.map(t=>t.l).join('+')||'generisch'+')‚Ä¶',43);
    const highSyn=pool.filter(c=>!seen.has(c.name)&&(c.synergy||0)>3).slice(0,22);
    const synEdh=dedup(highSyn).map(c=>({name:c.name,type:c.type||'',manaCost:'',price:null,img:null,synergy:c.synergy,isGC:GC.has(c.name),isCombo:COMBO.has(c.name)}));
    const synQ=themeQ(S.themes,ci,maxEur,comboOk);
    const synSf=noGC(await sfSearch(synQ,22-synEdh.length+6));
    dedup(synSf).slice(0,22-synEdh.length).forEach(c=>synEdh.push({name:c.name,type:c.type_line||'',manaCost:c.mana_cost||'',price:eur(c),img:gi(c,'small'),synergy:0,isGC:GC.has(c.name),isCombo:COMBO.has(c.name)}));
    await slp(60);

    log('Win Conditions‚Ä¶',55);
    const wins=await pull('Wins',comboOk?`${base} o:"you win the game" cmc<=8`:`${base} type:creature (o:"trample" OR o:"haste") cmc>=5`,5);await slp(60);

    log('Utility & Schutz‚Ä¶',62);
    const util=await pull('Util',`${base} (o:"hexproof" OR o:"indestructible") cmc<=4`,5);await slp(60);

    log('Mana-Basis‚Ä¶',70);
    const lseen=new Set([...seen]);
    const nbl=[];
    if(ci.length>1){const ct=await sfNamed('Command Tower');if(ct&&!lseen.has('Command Tower')){lseen.add('Command Tower');nbl.push({name:'Command Tower',type:'Land',manaCost:'',price:eur(ct),img:gi(ct,'small')});}}
    const flands=noGC(await sfSearch(`id<=${cs} type:land -type:basic game:paper${pr} (o:"add" OR o:"search your library") -type:snow`,22));
    flands.forEach(c=>{if(!lseen.has(c.name)){lseen.add(c.name);nbl.push({name:c.name,type:c.type_line||'Land',manaCost:'',price:eur(c),img:gi(c,'small')});}});
    const nbc=Math.min(nbl.length,Math.round(S.landCount*.6));
    const bc=S.landCount-nbc;
    const basics=[];
    if(ci.length>0){
      const per=Math.floor(bc/ci.length),rem2=bc%ci.length;
      ci.forEach((col,i)=>{const bn=BASICS[col];if(!bn)return;const n=per+(i<rem2?1:0);for(let j=0;j<n;j++)basics.push({name:bn,type:'Basic Land',manaCost:'',price:.1,img:null,isBasic:true});});
    }else{for(let i=0;i<bc;i++)basics.push({name:'Wastes',type:'Basic Land',manaCost:'',price:.1,img:null,isBasic:true});}
    const allLands=[...nbl.slice(0,nbc),...basics];

    log('Zusammenstellen‚Ä¶',82);
    const nonL=[...ramp,...draw,...rem,...synEdh,...wins,...util];
    const nlTarget=99-S.landCount;
    let final=nonL.slice(0,nlTarget);
    if(final.length<nlTarget){
      const extra=noGC(await sfSearch(`${base} type:creature cmc<=4`,nlTarget-final.length+8));
      dedup(extra).slice(0,nlTarget-final.length).forEach(c=>final.push({name:c.name,type:c.type_line||'',manaCost:c.mana_cost||'',price:eur(c),img:gi(c,'small'),synergy:0,isGC:GC.has(c.name),isCombo:COMBO.has(c.name)}));
    }

    // Apply price filter on individual cards if min price set
    if(minEur>0)final=final.filter(c=>c.isBasic||(c.price==null)||(c.price>=minEur));

    S.deck=[...final,...allLands.slice(0,S.landCount)];

    log('Anreichern‚Ä¶',88);
    await enrich();
    log('Fertig! '+(1+S.deck.length)+'/100',100);
    await slp(250);
    document.getElementById('p4l').style.display='none';
    renderResult();
  }catch(err){
    document.getElementById('p4l').style.display='none';
    document.getElementById('p4e').style.display='block';
    document.getElementById('emsg').textContent=err.message;
  }
}

async function enrich(){
  const toE=S.deck.filter(c=>!c.isBasic&&(!c.manaCost||!c.type||!c.img));
  if(!toE.length)return;
  const chunks=[];for(let i=0;i<toE.length;i+=75)chunks.push(toE.slice(i,i+75));
  for(const ch of chunks){
    try{
      const r=await fetch(`${SF}/cards/collection`,{method:'POST',mode:'cors',headers:{'Content-Type':'application/json'},body:JSON.stringify({identifiers:ch.map(c=>({name:c.name}))})});
      if(!r.ok)continue;
      const data=await r.json();
      (data.data||[]).forEach(sf=>{const d=S.deck.find(c=>c.name===sf.name);if(d){d.type=d.type||sf.type_line||'';d.manaCost=d.manaCost||sf.mana_cost||'';d.price=d.price??eur(sf);d.img=d.img||gi(sf,'small');}});
    }catch{}
    await slp(100);
  }
}

// ‚îÄ‚îÄ RENDER RESULT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function secOf(c){
  const t=(c.type||'').toLowerCase();
  if(c.isBasic||t.includes('land'))return'Land';
  if(t.includes('creature'))return'Creature';
  if(t.includes('instant'))return'Instant';
  if(t.includes('sorcery'))return'Sorcery';
  if(t.includes('enchantment'))return'Enchantment';
  if(t.includes('artifact'))return'Artifact';
  if(t.includes('planeswalker'))return'Planeswalker';
  return'Other';
}

function renderResult(){
  const c=S.cmd,b=BR.find(x=>x.id===S.bracket);
  const ci=c?.color_identity||[];
  const total=1+S.deck.length;
  document.getElementById('dart').src=gi(c,'art_crop')||gi(c,'normal')||'';
  document.getElementById('dtit').textContent=c?.name||'';
  const totalP=S.deck.reduce((s,c)=>s+(c.price||0),0);
  const priceStr=S.budget==='custom'?`${S.priceMin}‚Äì${S.priceMax>=9999?'‚àû':S.priceMax} ‚Ç¨`:(BUDGETS.find(x=>x.id===S.budget)?.l||'');
  document.getElementById('dchips').innerHTML=
    ci.map(col=>`<span class="chip" style="color:${COLORS[col]}">${CN[col]}</span>`).join('')+
    (b?`<span class="chip" style="color:${b.c}">${b.l}</span>`:'')+
    (priceStr?`<span class="chip">${priceStr}</span>`:'')+
    S.themes.map(t=>`<span class="chip" style="color:var(--gold)">${esc(t.l)}</span>`).join('')+
    `<span class="chip" style="color:${total===100?'#40a858':'#c04848'}">${total}/100</span>`;
  document.getElementById('dstats').innerHTML=
    `<span class="dst"><strong>${total}</strong> Karten</span>`+
    `<span class="dst"><strong>${S.deck.filter(c=>secOf(c)==='Land').length}</strong> L√§nder</span>`+
    (totalP>0?`<span class="dst">~<strong>${totalP.toFixed(0)} ‚Ç¨</strong> Cardmarket</span>`:'');
  renderSecs();
  document.getElementById('p4r').style.display='block';
  updPanel();
}

function renderSecs(){
  const groups={};SECS.forEach(s=>groups[s.k]=[]);
  S.deck.forEach(c=>{const k=secOf(c);(groups[k]=groups[k]||[]).push(c);});
  const cont=document.getElementById('dsecs');cont.innerHTML='';
  SECS.forEach(sec=>{
    const cards=groups[sec.k]||[];if(!cards.length)return;
    const display=sec.k==='Land'?consBasics(cards):cards;
    const div=document.createElement('div');div.className='dsec';
    div.innerHTML=`<div class="dsh"><div class="dst2">${sec.i} ${sec.l} <span class="dsc">${cards.length}</span></div><button class="dsadd" id="dsa_${sec.k}">ALLE +</button></div><div class="crow-list" id="cl_${sec.k}"></div>`;
    cont.appendChild(div);
    tap(document.getElementById('dsa_'+sec.k),()=>addAll(sec.k));
    const list=document.getElementById('cl_'+sec.k);
    display.forEach(card=>list.appendChild(mkRow(card)));
  });
}

function consBasics(cards){
  const cnt={};cards.forEach(c=>{cnt[c.name]=(cnt[c.name]||0)+1;});
  const seen=new Set();
  return cards.filter(c=>{if(seen.has(c.name))return false;seen.add(c.name);return true;}).map(c=>({...c,_qty:cnt[c.name]}));
}

function mkRow(card){
  const inSel=S.sel.has(card.name),notOwn=S.collMode&&!owned(card.name);
  const div=document.createElement('div');
  div.className='crow'+(inSel?' sel':'')+(GC.has(card.name)?' gc':'')+(notOwn?' no':'');
  div.innerHTML=
    `<span class="c-qty">${(card._qty||1)>1?card._qty+'√ó':'1√ó'}</span>`+
    (card.img?`<img class="c-img" src="${card.img}" alt="" loading="lazy" onerror="this.style.display='none'">`:'<div class="c-img"></div>')+
    `<span class="c-name">${esc(card.name)}</span>`+
    `<span class="c-typ">${esc((card.type||'').replace('Legendary ','').split(' ‚Äî ')[0])}</span>`+
    `<div class="c-mana">${card.manaCost?mana(card.manaCost):''}</div>`+
    `<div class="c-badges">${GC.has(card.name)?'<span class="bgc">GC</span>':''}${COMBO.has(card.name)?'<span class="bco">‚àû</span>':''}</div>`+
    (card.price&&!card.isBasic?`<span class="c-price">${feur(card.price)}</span>`:'')+
    `<button class="c-btn">${inSel?'‚úì Deck':'+ Deck'}</button>`;
  const btn=div.querySelector('.c-btn');
  btn._card=card;
  btn.addEventListener('touchend',ev=>{ev.preventDefault();togCard(btn._card,div,btn);});
  btn.addEventListener('click',()=>togCard(btn._card,div,btn));
  return div;
}

function togCard(card,row,btn){
  if(S.sel.has(card.name)){S.sel.delete(card.name);row.classList.remove('sel');btn.textContent='+ Deck';}
  else{S.sel.add(card.name);row.classList.add('sel');btn.textContent='‚úì Deck';}
  updPanel();
}
function addAll(sk){
  const groups={};SECS.forEach(s=>groups[s.k]=[]);S.deck.forEach(c=>{(groups[secOf(c)]=groups[secOf(c)]||[]).push(c);});
  (groups[sk]||[]).forEach(c=>S.sel.add(c.name));renderSecs();updPanel();
}
function updPanel(){
  const total=1+S.sel.size;
  document.getElementById('pcnt').textContent=total;
  document.getElementById('psub').textContent=S.cmd?'Commander: '+S.cmd.name:'';
  document.getElementById('pfill').style.width=Math.min(100,total)+'%';
  document.getElementById('panel').style.display='flex';
}

// ‚îÄ‚îÄ CHAT (Claude API) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function doChat(msg){
  if(!msg)return;
  document.getElementById('cinp').value='';
  addMsg('u',msg);
  document.getElementById('csnd').disabled=true;
  document.getElementById('ctyp').classList.add('on');

  const ctx=`Commander: ${S.cmd?.name}\nThemes: ${S.themes.map(t=>t.l).join(', ')||'keine'}\nBracket: ${S.bracket}\nOptionen: ${S.opts.join(', ')||'keine'}\nDeck (${S.deck.length} Karten):\n${SECS.map(s=>{const cards=S.deck.filter(c=>secOf(c)===s.k);return cards.length?s.l+' ('+cards.length+'): '+cards.slice(0,8).map(c=>c.name).join(', ')+(cards.length>8?'‚Ä¶':''): '';}).filter(Boolean).join('\n')}`;

  try{
    const resp=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json','anthropic-dangerous-direct-browser-access':'true'},
      body:JSON.stringify({
        model:'claude-sonnet-4-20250514',max_tokens:800,
        system:`Du bist ein MTG Commander Deck-Assistent. Antworte IMMER auf Deutsch, kurz (max 3 S√§tze). Wenn Karten ge√§ndert werden sollen, antworte MIT diesem JSON-Block ‚Äî sonst OHNE:
[CHANGES]{"add":["Kartenname1","Kartenname2"],"remove":["Kartenname3"]}[/CHANGES]`,
        messages:[{role:'user',content:`Deck:\n${ctx}\n\nAnfrage: "${msg}"`}]
      })
    });
    const data=await resp.json();
    let text=(data.content?.[0]?.text||'Keine Antwort');
    const cm=text.match(/\[CHANGES\]([\s\S]*?)\[\/CHANGES\]/);
    const display=text.replace(/\[CHANGES\][\s\S]*?\[\/CHANGES\]/g,'').trim();
    if(cm){try{const ch=JSON.parse(cm[1]);await applyChanges(ch);}catch{}}
    addMsg('a',display||'Fertig!');
  }catch(e){
    addMsg('a','Fehler: '+e.message+'. Tipp: API-Key wird direkt im Browser ben√∂tigt.');
  }
  document.getElementById('csnd').disabled=false;
  document.getElementById('ctyp').classList.remove('on');
}

function addMsg(role,txt){
  const msgs=document.getElementById('cmsgs');
  const d=document.createElement('div');d.className='cmsg '+role;
  d.innerHTML=`<div class="cml">${role==='u'?'Du':'Assistent'}</div><div class="cmb">${esc(txt).replace(/\n/g,'<br>')}</div>`;
  msgs.appendChild(d);msgs.scrollTop=msgs.scrollHeight;
}

async function applyChanges(ch){
  if(ch.remove)ch.remove.forEach(n=>{const i=S.deck.findIndex(c=>c.name.toLowerCase()===n.toLowerCase());if(i>=0){S.sel.delete(S.deck[i].name);S.deck.splice(i,1);}});
  if(ch.add)for(const n of ch.add){
    const c=await sfNamed(n);
    if(c&&!S.deck.find(d=>d.name===c.name)){S.deck.push({name:c.name,type:c.type_line||'',manaCost:c.mana_cost||'',price:eur(c),img:gi(c,'small'),isGC:GC.has(c.name),isCombo:COMBO.has(c.name)});S.sel.add(c.name);}
  }
  renderSecs();updPanel();
}

// ‚îÄ‚îÄ EXPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function dl(content,fname){const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([content],{type:'text/plain;charset=utf-8'}));a.download=fname;a.click();}
function exportAll(){const seen=new Set();const lines=[`1 ${S.cmd?.name||''} *CMDR*`];S.deck.forEach(c=>{if(!seen.has(c.name)){seen.add(c.name);lines.push(`1 ${c.name}`);}});dl(lines.join('\n'),(S.cmd?.name||'deck').replace(/[^a-z0-9]/gi,'_')+'_full.txt');}
function exportSel(){const lines=[`1 ${S.cmd?.name||''} *CMDR*`,...[...S.sel].map(n=>`1 ${n}`)];dl(lines.join('\n'),(S.cmd?.name||'deck').replace(/[^a-z0-9]/gi,'_')+'_sel.txt');}

// ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function nav(n){
  if(n===2&&!S.cmd)return;
  if(n===2)setupP2();
  if(n===3){setupP3();chkP3();}
  document.querySelectorAll('.page').forEach((p,i)=>p.classList.toggle('on',i+1===n));
  for(let i=1;i<=4;i++){
    const s=document.getElementById('st'+i),b=document.getElementById('sb'+i);
    s.classList.remove('act','done');
    if(i===n){s.classList.add('act');}
    else if(i<n){s.classList.add('done');b.textContent='‚úì';}
    else{b.textContent=i;}
  }
  document.querySelectorAll('.step.done').forEach(el=>{const n2=+el.id.replace('st','');el.onclick=()=>nav(n2);});
  window.scrollTo({top:0,behavior:'smooth'});
}
nav(1);
</script>
</body>
</html>
