<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Commander Deckbuilder</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Pro:ital,wght@0,300;0,400;0,500;1,300;1,400&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#07070f;--s1:#0c0c18;--s2:#11111f;--s3:#171728;--s4:#1e1e30;
  --b0:#111120;--b1:#202035;--b2:#303050;--b3:#505075;
  --t1:#ece8f8;--t2:#a8a4c0;--t3:#68648a;--t4:#38345a;
  --gold:#c89030;--gold2:#e0aa40;--gold3:#9a7020;
  --red:#c84848;--blue:#4888d0;--green:#40a860;--purple:#9060c8;
  --W:#f0e8cc;--U:#5890d0;--B:#9070c0;--R:#c86840;--G:#48a868;--C:#9090b0;
  --safe-b:env(safe-area-inset-bottom,0px);
  --safe-t:env(safe-area-inset-top,0px);
  --r:10px;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html{height:100%;scroll-behavior:smooth}
body{background:var(--bg);color:var(--t1);font-family:'Crimson Pro',Georgia,serif;font-size:16px;line-height:1.6;min-height:100%;-webkit-font-smoothing:antialiased;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;z-index:0;pointer-events:none;background:radial-gradient(ellipse 90% 60% at 15% 0%,rgba(80,40,160,.1) 0%,transparent 55%),radial-gradient(ellipse 70% 50% at 85% 100%,rgba(200,144,48,.05) 0%,transparent 55%)}
::-webkit-scrollbar{width:3px}::-webkit-scrollbar-thumb{background:var(--b2);border-radius:2px}

/* ── HEADER ── */
header{position:sticky;top:0;z-index:500;background:rgba(7,7,15,.93);border-bottom:1px solid var(--b1);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);padding:0 16px;padding-top:var(--safe-t);display:flex;align-items:center;gap:12px;height:calc(50px + var(--safe-t))}
.logo{display:flex;align-items:center;gap:8px;flex-shrink:0;text-decoration:none}
.logo-hex{width:26px;height:26px;background:var(--gold);clip-path:polygon(50% 0%,93% 25%,93% 75%,50% 100%,7% 75%,7% 25%);display:flex;align-items:center;justify-content:center;font-size:10px;color:#000;flex-shrink:0}
.logo-t{font-family:'Cinzel',serif;font-size:11px;font-weight:700;letter-spacing:.1em;color:var(--t1)}
.logo-s{font-size:8px;font-family:'DM Mono',monospace;color:var(--t3);letter-spacing:.08em}
.steps{display:flex;gap:0;overflow:hidden;flex:1;justify-content:flex-end}
.stp{display:flex;align-items:center;gap:4px;padding:0 7px;height:calc(50px);border-bottom:2px solid transparent;opacity:.2;transition:all .25s;flex-shrink:0;cursor:default}
.stp.active{opacity:1;border-bottom-color:var(--gold)}
.stp.done{opacity:.45;cursor:pointer}
.stp-n{width:15px;height:15px;border-radius:50%;background:var(--b1);color:var(--t3);font-family:'DM Mono',monospace;font-size:7px;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0}
.stp.active .stp-n{background:var(--gold);color:#000;font-weight:700}
.stp.done .stp-n{background:var(--b2);color:var(--t1)}
.stp-l{font-size:8px;font-family:'DM Mono',monospace;color:var(--t3);letter-spacing:.04em;white-space:nowrap}
.stp.active .stp-l{color:var(--t2)}
.sep{color:var(--b1);font-size:9px}
@media(max-width:400px){.stp-l{display:none}}

/* ── MAIN ── */
main{position:relative;z-index:1;max-width:700px;margin:0 auto;padding:24px 14px calc(80px + var(--safe-b))}
.page{display:none;animation:pgIn .3s cubic-bezier(.16,1,.3,1) both}
.page.on{display:block}
@keyframes pgIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.ptitle{font-family:'Cinzel',serif;font-size:22px;font-weight:700;letter-spacing:.02em;line-height:1.2;margin-bottom:3px}
.psub{font-size:13px;color:var(--t3);font-style:italic;margin-bottom:24px;font-weight:300}
.lbl{font-family:'DM Mono',monospace;font-size:8px;letter-spacing:.14em;text-transform:uppercase;color:var(--t3);margin-bottom:8px;margin-top:20px;display:flex;align-items:center;gap:8px}
.lbl::after{content:'';flex:1;height:1px;background:linear-gradient(to right,var(--b1),transparent);max-width:50px}

/* ── BUTTONS ── */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:12px 22px;background:var(--gold);border:none;border-radius:8px;color:#000;font-family:'Cinzel',serif;font-size:10px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;min-height:46px;box-shadow:0 4px 18px rgba(200,144,48,.22);transition:all .15s;touch-action:manipulation;-webkit-appearance:none}
.btn:hover{background:var(--gold2)}
.btn:active{transform:scale(.97)}
.btn:disabled{background:var(--b1);color:var(--t3);box-shadow:none;cursor:not-allowed;transform:none}
.btns{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:11px 18px;background:transparent;border:1px solid var(--b2);border-radius:8px;color:var(--t2);font-size:13px;cursor:pointer;min-height:46px;transition:all .15s;touch-action:manipulation;-webkit-appearance:none;font-family:'Crimson Pro',serif}
.btns:hover{border-color:var(--b3);color:var(--t1)}
.btns:active{transform:scale(.97)}
.nav{display:flex;justify-content:space-between;align-items:center;margin-top:24px;gap:8px}

/* ── SEARCH ── */
.sw{position:relative;margin-bottom:6px}
.sr{display:flex;align-items:center;background:var(--s1);border:1px solid var(--b1);border-radius:var(--r);overflow:hidden;transition:border-color .2s,box-shadow .2s}
.sr:focus-within{border-color:rgba(200,144,48,.5);box-shadow:0 0 0 3px rgba(200,144,48,.07)}
.si{flex:1;padding:14px 12px;background:transparent;border:none;color:var(--t1);font-size:16px;font-family:'Crimson Pro',serif;outline:none;min-width:0}
.si::placeholder{color:var(--b2);font-style:italic}
.sico{padding:0 12px;color:var(--t3);font-size:15px;flex-shrink:0}
.scl{padding:0 12px;background:none;border:none;color:var(--t3);cursor:pointer;font-size:18px;min-width:44px;display:flex;align-items:center;justify-content:center;touch-action:manipulation;transition:color .15s}
.scl:hover{color:var(--t1)}
.sspin{padding:0 10px;display:none}
.spn{animation:rot .6s linear infinite;color:var(--gold);display:inline-block;font-size:13px}
@keyframes rot{to{transform:rotate(360deg)}}

/* ── DROPDOWN ── */
.dr{position:absolute;top:calc(100% + 5px);left:0;right:0;z-index:600;background:var(--s1);border:1px solid var(--b1);border-radius:var(--r);box-shadow:0 20px 50px rgba(0,0,0,.9);max-height:340px;overflow-y:auto;-webkit-overflow-scrolling:touch;display:none}
.dri{display:flex;align-items:center;gap:10px;padding:9px 11px;border-bottom:1px solid var(--b0);cursor:pointer;touch-action:manipulation;transition:background .1s}
.dri:last-child{border-bottom:none}
.dri:active,.dri.hover{background:var(--s2)}
.drimg{width:26px;height:37px;border-radius:3px;object-fit:cover;object-position:top center;flex-shrink:0;background:var(--b0)}
.drname{font-family:'Cinzel',serif;font-size:11px;font-weight:600;color:var(--t1);line-height:1.2}
.drtype{font-size:8px;color:var(--t3);font-family:'DM Mono',monospace;margin-top:1px}
.drci{display:flex;gap:3px;margin-top:3px}
.drciw{width:6px;height:6px;border-radius:50%}

/* ── COMMANDER CARD ── */
.cmdr{display:flex;background:var(--s1);border:1px solid var(--b1);border-radius:12px;overflow:hidden;margin-bottom:18px;box-shadow:0 12px 40px rgba(0,0,0,.6)}
.cmdr-stripe{width:3px;flex-shrink:0}
.cmdr-art{width:90px;flex-shrink:0;object-fit:cover;object-position:15% 12%}
.cmdr-info{padding:13px 14px;flex:1;min-width:0}
.cmdr-name{font-family:'Cinzel',serif;font-size:14px;font-weight:700;line-height:1.2;margin-bottom:3px;letter-spacing:.01em}
.cmdr-type{font-size:8px;color:var(--t3);font-family:'DM Mono',monospace;letter-spacing:.05em;text-transform:uppercase;margin-bottom:6px}
.cmdr-mana{display:flex;gap:3px;align-items:center;margin-bottom:6px;flex-wrap:wrap}
.ms{width:16px;height:16px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:8px;font-weight:700;font-family:'DM Mono',monospace;flex-shrink:0;line-height:1;border:1px solid rgba(0,0,0,.3)}
.ms-W{background:#f0e8cc;color:#5a5030}
.ms-U{background:#5890d0;color:#fff}
.ms-B{background:#9070c0;color:#fff}
.ms-R{background:#c86840;color:#fff}
.ms-G{background:#48a868;color:#fff}
.ms-C{background:#9090b0;color:#fff}
.ms-N{background:#8a7050;color:#fff}
.ms-X{background:#444;color:#fff}
.ms-num{background:#bbb;color:#333}
.cmdr-oracle{font-size:11px;color:var(--t3);font-style:italic;line-height:1.5;margin-bottom:6px;font-weight:300;border-left:2px solid var(--b1);padding-left:8px}
.cmdr-meta{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.cmdr-rank{font-size:8px;color:var(--t4);font-family:'DM Mono',monospace}
.cmdr-price{font-size:9px;color:#48a868;font-family:'DM Mono',monospace}
.cmdr-gc{font-size:8px;color:var(--gold);font-family:'DM Mono',monospace;background:rgba(200,144,48,.1);padding:2px 6px;border-radius:3px;border:1px solid rgba(200,144,48,.2)}

/* ── TAGS (EDHREC) ── */
.tag-grid{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px}
.tag{padding:7px 12px;border-radius:100px;background:var(--s1);border:1px solid var(--b1);cursor:pointer;touch-action:manipulation;font-size:11px;font-family:'Crimson Pro',serif;color:var(--t2);transition:all .15s;display:flex;align-items:center;gap:5px;min-height:36px}
.tag:active{transform:scale(.97)}
.tag.sel{background:rgba(200,144,48,.1);border-color:rgba(200,144,48,.4);color:var(--gold)}
.tag.sel2{background:rgba(144,96,200,.08);border-color:rgba(144,96,200,.35);color:#a070e0}
.tag-count{font-family:'DM Mono',monospace;font-size:8px;color:var(--t4);background:var(--b0);padding:1px 4px;border-radius:3px}
.tag.sel .tag-count{background:rgba(200,144,48,.15);color:var(--gold3)}
.tag-info{font-size:11px;color:var(--t3);font-style:italic;margin-bottom:10px;font-family:'Crimson Pro',serif}

/* ── BRACKET ── */
.bgrid{display:grid;grid-template-columns:repeat(5,1fr);gap:5px;margin-bottom:20px}
@media(max-width:500px){.bgrid{grid-template-columns:repeat(3,1fr)}}
.bc{background:var(--s1);border:1px solid var(--b1);border-radius:8px;padding:10px 6px;cursor:pointer;touch-action:manipulation;text-align:center;transition:all .2s;position:relative;overflow:hidden}
.bc::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:var(--cc,transparent)}
.bc:active{transform:scale(.97)}
.bc.sel{background:var(--s2);border-color:var(--cc,var(--b2))}
.bc-num{font-family:'Cinzel',serif;font-size:18px;font-weight:700;color:var(--cc,var(--b2));line-height:1;margin-bottom:3px}
.bc-lbl{font-size:8px;font-family:'DM Mono',monospace;color:var(--t3);letter-spacing:.05em;text-transform:uppercase}
.bc.sel .bc-lbl{color:var(--t2)}

/* ── OPTIONS ── */
.og{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:20px}
.oc{padding:7px 11px;border-radius:100px;background:var(--s1);border:1px solid var(--b1);cursor:pointer;touch-action:manipulation;font-size:11px;color:var(--t2);transition:all .15s;min-height:34px;display:flex;align-items:center;font-family:'Crimson Pro',serif}
.oc.sel{background:rgba(200,144,48,.08);border-color:rgba(200,144,48,.35);color:var(--gold)}
.oc:active{transform:scale(.97)}

/* ── LAND SLIDER ── */
.slider-row{display:flex;align-items:center;gap:12px;background:var(--s1);border:1px solid var(--b1);border-radius:var(--r);padding:14px 16px;margin-bottom:16px}
.slider-val{font-family:'Cinzel',serif;font-size:28px;font-weight:700;color:var(--gold);min-width:36px;text-align:center;line-height:1}
.slider-info{flex:1}
.slider-info input[type=range]{width:100%;-webkit-appearance:none;height:3px;border-radius:2px;background:var(--b1);outline:none;cursor:pointer;accent-color:var(--gold)}
.slider-info input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;border-radius:50%;background:var(--gold);cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.4)}
.slider-label{font-size:11px;color:var(--t3);font-family:'Crimson Pro',serif;font-style:italic;margin-top:4px}
.slider-rec{font-size:9px;color:var(--gold3);font-family:'DM Mono',monospace;margin-top:2px}

/* ── BUDGET ── */
.pgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:5px;margin-bottom:20px}
.pc{background:var(--s1);border:1px solid var(--b1);border-radius:8px;padding:9px 10px;cursor:pointer;touch-action:manipulation;display:flex;align-items:center;gap:6px;transition:all .2s;min-height:40px}
.pc.sel{background:var(--s2)}
.pc:active{transform:scale(.97)}
.pc-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.pc-l{font-size:10px;font-family:'DM Mono',monospace;color:var(--t3);line-height:1.2}
.pc.sel .pc-l{color:var(--t1)}

/* ── SUMMARY ── */
.sbox{background:var(--s1);border:1px solid var(--b1);border-radius:var(--r);padding:13px 15px;margin-top:14px}
.srow{display:flex;gap:8px;margin-bottom:4px;align-items:baseline}
.sk{font-family:'DM Mono',monospace;font-size:8px;color:var(--t3);min-width:78px;letter-spacing:.06em;text-transform:uppercase;flex-shrink:0}
.sv{color:var(--t1);font-size:13px}

/* ── LOADING ── */
.lw{text-align:center;padding:60px 20px}
.lring{width:44px;height:44px;border:2px solid var(--b1);border-top-color:var(--gold);border-radius:50%;animation:rot .75s linear infinite;margin:0 auto 16px}
.lt{font-family:'Cinzel',serif;font-size:17px;font-weight:700;margin-bottom:4px}
.lm{font-size:12px;color:var(--t3);font-style:italic;margin-bottom:14px}
.lbar{width:100%;max-width:280px;height:2px;background:var(--b1);border-radius:1px;overflow:hidden;margin:0 auto 16px}
.lbar-fill{height:100%;background:linear-gradient(to right,var(--gold3),var(--gold));border-radius:1px;transition:width .4s ease;width:0}
.llog{text-align:left;max-width:280px;margin:0 auto;font-family:'DM Mono',monospace;font-size:8px;color:var(--t4)}
.li{margin-bottom:2px;animation:fadeUp .3s forwards;opacity:0}
@keyframes fadeUp{to{opacity:.7}}

/* ── ERROR ── */
.ebox{max-width:360px;margin:60px auto;text-align:center;background:var(--s1);border:1px solid #3a1818;border-radius:12px;padding:22px 18px}
.etit{font-family:'Cinzel',serif;font-size:15px;color:#c05050;margin-bottom:6px}
.emsg{font-size:10px;color:#905050;font-family:'DM Mono',monospace;margin-bottom:14px;word-break:break-word;line-height:1.6}

/* ── DECK VIEW ── */
.deck-header{display:flex;align-items:flex-start;gap:14px;margin-bottom:20px;flex-wrap:wrap}
.deck-art{width:80px;height:112px;border-radius:8px;object-fit:cover;object-position:15% 12%;flex-shrink:0;box-shadow:0 8px 24px rgba(0,0,0,.6)}
.deck-title-block{flex:1;min-width:0}
.deck-title{font-family:'Cinzel',serif;font-size:19px;font-weight:700;line-height:1.2;margin-bottom:5px;letter-spacing:.01em}
.deck-chips{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:8px}
.chip{padding:3px 8px;border-radius:100px;background:var(--s1);border:1px solid var(--b1);font-size:8px;font-family:'DM Mono',monospace}
.deck-stats{display:flex;gap:8px;flex-wrap:wrap}
.dstat{font-size:10px;font-family:'DM Mono',monospace;color:var(--t3)}
.dstat strong{color:var(--t1)}
.deck-actions{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:20px}

/* ── SECTION GROUPS ── */
.section-group{margin-bottom:28px}
.sg-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;padding-bottom:7px;border-bottom:1px solid var(--b1)}
.sg-title{font-family:'Cinzel',serif;font-size:13px;font-weight:700;letter-spacing:.05em;color:var(--t2);display:flex;align-items:center;gap:8px}
.sg-count{font-family:'DM Mono',monospace;font-size:9px;color:var(--t3);background:var(--s2);padding:2px 6px;border-radius:4px}
.sg-addall{padding:4px 10px;background:transparent;border:1px solid var(--b1);border-radius:5px;color:var(--t3);font-size:8px;font-family:'DM Mono',monospace;cursor:pointer;touch-action:manipulation;min-height:28px;transition:all .15s;letter-spacing:.05em}
.sg-addall:active{border-color:var(--gold);color:var(--gold)}

/* ── CARD LIST (list view inside each section) ── */
.card-list{display:flex;flex-direction:column;gap:3px}
.citem{display:flex;align-items:center;gap:8px;padding:6px 10px;background:var(--s1);border:1px solid var(--b0);border-radius:6px;transition:border-color .1s;cursor:default}
.citem.in-deck{border-color:rgba(72,168,104,.3);background:#070f09}
.citem.is-gc{border-color:rgba(200,144,48,.25)}
.citem-qty{font-family:'DM Mono',monospace;font-size:10px;color:var(--t3);min-width:12px;flex-shrink:0}
.citem-img{width:20px;height:28px;border-radius:2px;object-fit:cover;object-position:top;flex-shrink:0;background:var(--b0)}
.citem-mana{display:flex;gap:2px;flex-shrink:0;min-width:50px;justify-content:flex-end}
.citem-name{flex:1;min-width:0;font-size:13px;font-weight:500;color:var(--t1);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-family:'Cinzel',serif;font-size:11px}
.citem-type{font-size:8px;color:var(--t4);font-family:'DM Mono',monospace;white-space:nowrap;display:none}
@media(min-width:480px){.citem-type{display:block}}
.citem-price{font-size:8px;color:#48a868;font-family:'DM Mono',monospace;white-space:nowrap;flex-shrink:0}
.citem-badges{display:flex;gap:3px;flex-shrink:0}
.badge-gc{font-size:7px;color:var(--gold);background:rgba(200,144,48,.1);border:1px solid rgba(200,144,48,.2);padding:1px 4px;border-radius:3px;font-family:'DM Mono',monospace}
.badge-combo{font-size:7px;color:#a070e0;background:rgba(144,96,200,.08);border:1px solid rgba(144,96,200,.2);padding:1px 4px;border-radius:3px;font-family:'DM Mono',monospace}
.citem-add{padding:3px 8px;border-radius:4px;cursor:pointer;touch-action:manipulation;font-size:9px;border:1px solid var(--b1);background:var(--s2);color:var(--t3);font-family:'DM Mono',monospace;min-height:26px;transition:all .15s;white-space:nowrap;flex-shrink:0;-webkit-appearance:none}
.citem-add:active{transform:scale(.95)}
.citem.in-deck .citem-add{border-color:rgba(72,168,104,.3);color:#48a868}

/* ── AI CHAT ── */
.chat-wrap{background:var(--s1);border:1px solid var(--b1);border-radius:var(--r);overflow:hidden;margin-bottom:20px}
.chat-header{padding:10px 14px;border-bottom:1px solid var(--b0);display:flex;align-items:center;gap:8px}
.chat-icon{width:20px;height:20px;background:linear-gradient(135deg,#6040c0,#a060e0);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:9px;color:#fff;flex-shrink:0}
.chat-title{font-family:'DM Mono',monospace;font-size:9px;color:var(--t2);letter-spacing:.08em;text-transform:uppercase}
.chat-msgs{padding:10px 14px;max-height:200px;overflow-y:auto;-webkit-overflow-scrolling:touch;display:flex;flex-direction:column;gap:8px}
.chat-msg{display:flex;flex-direction:column;gap:2px}
.chat-msg.user .cm-text{background:rgba(200,144,48,.1);border:1px solid rgba(200,144,48,.2);color:var(--t1);border-radius:8px 8px 2px 8px;margin-left:20%}
.chat-msg.ai .cm-text{background:var(--s2);border:1px solid var(--b1);color:var(--t1);border-radius:8px 8px 8px 2px;margin-right:20%}
.cm-text{padding:8px 11px;font-size:12px;line-height:1.55;font-family:'Crimson Pro',serif}
.cm-name{font-size:8px;font-family:'DM Mono',monospace;color:var(--t4);padding:0 2px}
.chat-msg.user .cm-name{text-align:right}
.chat-input-row{display:flex;border-top:1px solid var(--b0)}
.chat-inp{flex:1;padding:10px 12px;background:transparent;border:none;color:var(--t1);font-size:14px;font-family:'Crimson Pro',serif;outline:none;min-width:0}
.chat-inp::placeholder{color:var(--b2);font-style:italic}
.chat-send{padding:0 14px;background:var(--gold);border:none;color:#000;cursor:pointer;font-family:'DM Mono',monospace;font-size:10px;font-weight:700;transition:background .15s;min-width:56px;touch-action:manipulation}
.chat-send:hover{background:var(--gold2)}
.chat-send:disabled{background:var(--b1);color:var(--t3);cursor:not-allowed}
.chat-typing{font-size:10px;color:var(--t3);font-style:italic;font-family:'Crimson Pro',serif;padding:4px 14px;animation:pulse 1.2s infinite}
@keyframes pulse{0%,100%{opacity:.4}50%{opacity:1}}

/* ── DECK PANEL ── */
.dp{position:fixed;left:0;right:0;bottom:0;z-index:600;background:rgba(7,7,15,.96);border-top:1px solid var(--b2);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);padding:9px 14px calc(9px + var(--safe-b));display:none}
.dp-row{display:flex;align-items:center;gap:10px}
.dp-info{flex:1;min-width:0}
.dp-cnt{font-family:'Cinzel',serif;font-size:13px;font-weight:700;color:var(--gold)}
.dp-sub{font-size:9px;color:var(--t3);font-family:'DM Mono',monospace;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.dp-prog{height:2px;background:var(--b1);border-radius:1px;overflow:hidden;margin-top:4px}
.dp-prog-fill{height:100%;background:linear-gradient(to right,var(--gold3),var(--gold));border-radius:1px;transition:width .3s}
.dp-btns{display:flex;gap:5px}
.dpb{padding:7px 11px;border-radius:6px;cursor:pointer;touch-action:manipulation;font-size:8px;font-family:'DM Mono',monospace;font-weight:700;letter-spacing:.05em;border:1px solid;min-height:34px;display:flex;align-items:center;-webkit-appearance:none;transition:opacity .15s}
.dpb:active{opacity:.7}
.dpb.a{background:rgba(72,120,200,.06);border-color:rgba(72,120,200,.22);color:#6090d8}
.dpb.s{background:rgba(72,168,104,.06);border-color:rgba(72,168,104,.22);color:#48a868}
@media(min-width:500px){
  .dp{left:auto;right:14px;bottom:14px;width:270px;border-radius:10px;border:1px solid var(--b2);max-height:none}
  main{padding-bottom:60px}
}

/* ── MANA SYMBOLS ── */
.mana-render{display:inline-flex;gap:2px;align-items:center}
</style>
</head>
<body>
<header>
  <a class="logo" href="#" onclick="go(1);return false">
    <div class="logo-hex">⚔</div>
    <div><div class="logo-t">Commander</div><div class="logo-s">Deckbuilder</div></div>
  </a>
  <div class="steps">
    <div class="stp active" id="d1"><div class="stp-n" id="dn1">1</div><span class="stp-l">Commander</span></div>
    <div class="sep">›</div>
    <div class="stp" id="d2"><div class="stp-n" id="dn2">2</div><span class="stp-l">Themes</span></div>
    <div class="sep">›</div>
    <div class="stp" id="d3"><div class="stp-n" id="dn3">3</div><span class="stp-l">Bracket</span></div>
    <div class="sep">›</div>
    <div class="stp" id="d4"><div class="stp-n" id="dn4">4</div><span class="stp-l">Deck</span></div>
  </div>
</header>

<main>
<!-- PAGE 1: Commander Search -->
<div class="page on" id="p1">
  <h1 class="ptitle">Commander wählen</h1>
  <p class="psub">Suche nach einem legendären Commander — Scryfall-Daten in Echtzeit</p>
  <div class="sw" id="sw">
    <div class="sr">
      <span class="sico">⌕</span>
      <input class="si" id="si" type="search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Atraxa, Light-Paws, Krenko…">
      <div class="sspin" id="spin"><span class="spn">◌</span></div>
      <button class="scl" id="scl" style="display:none">✕</button>
    </div>
    <div class="dr" id="dr"></div>
  </div>
  <div id="serr" style="display:none;margin-top:6px"></div>
  <div id="sres" style="display:none;margin-top:14px"></div>
  <div style="margin-top:18px">
    <div class="lbl" style="margin-top:0">Sammlung importieren <span style="color:var(--t4);font-size:8px;text-transform:none;letter-spacing:0;font-weight:300;font-style:italic">— optional</span></div>
    <div class="dz" id="dz" ondragover="event.preventDefault();this.classList.add('drag')" ondragleave="this.classList.remove('drag')" ondrop="hdrop(event)">↑ CSV oder TXT ablegen (Moxfield / Manabox / Plain)</div>
    <input type="file" id="cf" accept=".csv,.txt" style="display:none">
    <div id="ci2" style="display:none;margin-top:7px;font-size:11px;font-family:'DM Mono',monospace;color:var(--gold);align-items:center;gap:10px">
      <span id="ct"></span>
      <button id="clrColl" style="background:none;border:none;color:var(--t3);cursor:pointer;text-decoration:underline;font-family:'Crimson Pro',serif;font-size:12px;touch-action:manipulation">Entfernen</button>
    </div>
  </div>
</div>

<!-- PAGE 2: EDHREC Tags -->
<div class="page" id="p2">
  <h1 class="ptitle">Themes & Tags</h1>
  <p class="psub">EDHREC-Daten direkt für deinen Commander — wähle bis zu 2 Themes</p>
  <div id="p2cmdr"></div>
  <div class="lbl" style="margin-top:0">EDHREC Themes <span id="tagload" style="font-size:8px;color:var(--t3);text-transform:none;letter-spacing:0;font-style:italic"></span></div>
  <div class="tag-info" id="tag-info">Lädt EDHREC-Daten…</div>
  <div class="tag-grid" id="tag-grid"></div>
  <div class="lbl">EDHREC Kombo-Daten <span id="comboload" style="font-size:8px;color:var(--t3);text-transform:none;letter-spacing:0"></span></div>
  <div id="combo-tags" class="tag-grid"></div>
  <div class="nav">
    <button class="btns" id="p2back">← Zurück</button>
    <button class="btn" id="p2next" disabled>Weiter →</button>
  </div>
</div>

<!-- PAGE 3: Bracket + Lands + Budget -->
<div class="page" id="p3">
  <h1 class="ptitle">Powerlevel & Länder</h1>
  <p class="psub">Bracket nach dem offiziellen MTG System, Länderanzahl mit Richtwert</p>
  <div class="lbl" style="margin-top:0">Power-Bracket</div>
  <div class="bgrid" id="bgrid"></div>
  <div class="lbl">Optionale Zusätze</div>
  <div class="og" id="og"></div>
  <div class="lbl">Länderzahl</div>
  <div class="slider-row">
    <div class="slider-val" id="landval">36</div>
    <div class="slider-info">
      <input type="range" id="landslider" min="30" max="42" value="36" step="1">
      <div class="slider-label">Länder im Deck (30–42)</div>
      <div class="slider-rec" id="landrec">Empfehlung: 36 für diesen Commander</div>
    </div>
  </div>
  <div class="lbl">Budget</div>
  <div class="pgrid" id="pgrid"></div>
  <div class="sbox" id="sumbox"></div>
  <div class="nav">
    <button class="btns" id="p3back">← Zurück</button>
    <button class="btn" id="p3gen">Deck generieren →</button>
  </div>
</div>

<!-- PAGE 4: Deck -->
<div class="page" id="p4">
  <div id="p4l" style="display:none">
    <div class="lw">
      <div class="lring"></div>
      <div class="lt">Deck wird gebaut</div>
      <div class="lm" id="lmsg">Verbinde mit EDHREC…</div>
      <div class="lbar"><div class="lbar-fill" id="lbarf"></div></div>
      <div class="llog" id="llog"></div>
    </div>
  </div>
  <div id="p4e" style="display:none">
    <div class="ebox">
      <div class="etit">Fehler beim Laden</div>
      <div class="emsg" id="etxt"></div>
      <div style="display:flex;gap:8px;justify-content:center">
        <button class="btns" id="p4eb">← Zurück</button>
        <button class="btn" id="p4er">Erneut versuchen</button>
      </div>
    </div>
  </div>
  <div id="p4r" style="display:none">
    <div class="deck-header">
      <img class="deck-art" id="deckArt" src="" alt="" onerror="this.style.display='none'">
      <div class="deck-title-block">
        <div class="deck-title" id="deckTitle"></div>
        <div class="deck-chips" id="deckChips"></div>
        <div class="deck-stats" id="deckStats"></div>
      </div>
    </div>
    <div class="deck-actions">
      <button class="btns" style="font-size:12px;padding:9px 14px;min-height:40px" id="adjBtn">← Anpassen</button>
      <button class="btns" style="font-size:12px;padding:9px 14px;min-height:40px;border-color:rgba(72,168,104,.3);color:#48a868" id="expBtn">Export .txt</button>
    </div>
    <div class="chat-wrap" id="chatWrap">
      <div class="chat-header">
        <div class="chat-icon">✦</div>
        <span class="chat-title">Deck-Assistent</span>
        <span style="font-size:8px;color:var(--t4);font-family:'DM Mono',monospace;margin-left:4px">— „füge 3 mehr Auras hinzu" oder „ersetze Sol Ring"</span>
      </div>
      <div class="chat-msgs" id="chatMsgs">
        <div class="chat-msg ai"><div class="cm-name">Assistent</div><div class="cm-text">Deck ist bereit! Ich kann Karten hinzufügen, ersetzen oder entfernen. Einfach auf Deutsch oder Englisch schreiben.</div></div>
      </div>
      <div id="chatTyping" style="display:none" class="chat-typing">tippt…</div>
      <div class="chat-input-row">
        <input class="chat-inp" id="chatInp" placeholder="z.B. „füge mehr Auras hinzu"" autocomplete="off">
        <button class="chat-send" id="chatSend">→</button>
      </div>
    </div>
    <div id="deckSections"></div>
  </div>
  <div class="dp" id="dp">
    <div class="dp-row">
      <div class="dp-info">
        <div class="dp-cnt"><span id="dpcnt">0</span>/100 Karten</div>
        <div class="dp-sub" id="dpsub">Commander wählen um zu beginnen</div>
        <div class="dp-prog"><div class="dp-prog-fill" id="dppf"></div></div>
      </div>
      <div class="dp-btns">
        <button class="dpb a" id="dpA">Alles</button>
        <button class="dpb s" id="dpS">Auswahl</button>
      </div>
    </div>
  </div>
</div>
</main>

<style>
.dz{border:1px dashed var(--b2);border-radius:8px;padding:13px;text-align:center;cursor:pointer;touch-action:manipulation;font-size:10px;color:var(--t3);font-family:'DM Mono',monospace;transition:all .2s;min-height:46px;display:flex;align-items:center;justify-content:center;letter-spacing:.04em}
.dz.drag,.dz:active{border-color:var(--gold);color:var(--gold)}
.dz.loaded{border-color:rgba(200,144,48,.3);color:var(--gold2);border-style:solid}
</style>

<script>
// ═══════════════════════════════════════════════════════
// CONSTANTS
// ═══════════════════════════════════════════════════════
const SF = 'https://api.scryfall.com';
const EDHREC_BASE = 'https://json.edhrec.com';
const EDHREC_IMG = 'https://edhrec.com';

const GC_CARDS = new Set(['Black Lotus','Ancestral Recall','Time Walk','Mox Pearl','Mox Sapphire','Mox Jet','Mox Ruby','Mox Emerald','Mana Crypt','Mana Vault','Grim Monolith','Chrome Mox','Mox Diamond','Mox Opal','Jeweled Lotus','Demonic Tutor','Vampiric Tutor','Imperial Seal','Mystical Tutor','Enlightened Tutor','Worldly Tutor','Sylvan Tutor','Necropotence','Ad Nauseam','Timetwister','Time Spiral','Wheel of Fortune','Cyclonic Rift','Expropriate','Armageddon','Ravages of War','Thassa\'s Oracle','Doomsday','Demonic Consultation','Tainted Pact','Flash','Protean Hulk','Seedborn Muse','Rhystic Study','Smothering Tithe','Teferi\'s Protection','Omniscience','Enter the Infinite','Tooth and Nail','Craterhoof Behemoth','Triumph of the Hordes','Doubling Season','Parallel Lives','Food Chain','Survival of the Fittest','Yawgmoth\'s Will','Underworld Breach','Past in Flames','Sensei\'s Divining Top','Scroll Rack','Intuition','Gifts Ungiven','Buried Alive','Fierce Guardianship','Deflecting Swipe','Deadly Rollick','Flawless Maneuver','Obscuring Haze','Bolas\'s Citadel','Aetherflux Reservoir','Isochron Scepter','Hermit Druid','Hullbreacher','Opposition Agent','Narset, Parter of Veils','Leovold, Emissary of Trest','Winter Orb','Static Orb','Stasis']);

const COMBOS = new Set(['Isochron Scepter','Dramatic Reversal','Basalt Monolith','Rings of Brighthearth','Grim Monolith','Power Artifact','Palinchron','Deadeye Navigator','Nim Deathmantle','Ashnod\'s Altar','Phyrexian Altar','Mikaeus, the Unhallowed','Triskelion','Walking Ballista','Devoted Druid','Vizier of Remedies','Kiki-Jiki, Mirror Breaker','Splinter Twin','Deceiver Exarch','Pestermite','Exquisite Blood','Sanguine Bond','Vito, Thorn of the Dusk Rose','Heliod, Sun-Crowned','Food Chain','Thassa\'s Oracle','Demonic Consultation','Tainted Pact','Doomsday','Auriok Salvagers','Lion\'s Eye Diamond','Cloudstone Curio','Temur Sabertooth']);

const BR = [
  {id:1,label:'Casual',   c:'#48a868',rules:['Keine Kombos','Keine Tutoren','Kein Fast-Mana']},
  {id:2,label:'Focused',  c:'#5888d0',rules:['Keine Kombos','Max 2 Tutoren','Kein Turn-5-Win']},
  {id:3,label:'Optimized',c:'#c89030',rules:['Interaktion erwartet','Synergien OK','GC nach Absprache']},
  {id:4,label:'cEDH',     c:'#c04848',rules:['Alles erlaubt','Fast-Mana OK','Turn 3-4 Win']},
  {id:5,label:'cEDH+',    c:'#a030a0',rules:['Proxies OK','Kein Limit','Turnier-Level']},
];
const OPT = [
  {id:'gc',   n:'Gamechanger-Karten'},
  {id:'combo',n:'Infinite Combos'},
  {id:'tutor',n:'Alle Tutoren'},
  {id:'stax', n:'Stax Pieces'},
  {id:'extra',n:'Extra Turns'},
  {id:'mld',  n:'Mass Land Destroy'},
];
const PT = [
  {id:'xs',l:'< 10 €',  max:10, c:'#48a868'},
  {id:'s', l:'10–30 €', max:30, c:'#34c890'},
  {id:'m', l:'30–100 €',max:100,c:'#5888d0'},
  {id:'l', l:'100–300 €',max:300,c:'#9860d0'},
  {id:'xl',l:'300–800 €',max:800,c:'#c89030'},
  {id:'op',l:'Kein Limit',max:9999,c:'#c04848'},
];
const COLORS = {W:'#f0e8cc',U:'#5890d0',B:'#9070c0',R:'c86840',G:'#48a868',C:'#9090b0'};
const COLOR_NAMES = {W:'Weiß',U:'Blau',B:'Schwarz',R:'Rot',G:'Grün',C:'Farblos'};
const BASICS = {W:'Plains',U:'Island',B:'Swamp',R:'Mountain',G:'Forest'};

// Section types for deck display
const SECTION_ORDER = [
  {key:'Commander',     label:'Commander',      icon:'★'},
  {key:'Creature',      label:'Kreaturen',       icon:'⚔'},
  {key:'Instant',       label:'Sofortzauber',    icon:'⚡'},
  {key:'Sorcery',       label:'Hexerei',         icon:'✦'},
  {key:'Enchantment',   label:'Verzauberungen',  icon:'◎'},
  {key:'Artifact',      label:'Artefakte',       icon:'⚙'},
  {key:'Planeswalker',  label:'Planeswalker',    icon:'◈'},
  {key:'Land',          label:'Länder',          icon:'⛰'},
  {key:'Other',         label:'Sonstige',        icon:'?'},
];

// App state
const S = {
  cmd: null, bracket: null, opts: [], pt: null,
  landCount: 36, themes: [], collMode: false, coll: null,
  deck: [], // array of {name, type, manaCost, price, img, isGC, isCombo, isBasic, synergy}
  edhrecData: null,
};

// ═══════════════════════════════════════════════════════
// UTILS
// ═══════════════════════════════════════════════════════
const esc = s => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
const slp = ms => new Promise(r => setTimeout(r, ms));
const gi = (c,z) => c.image_uris?.[z] || c.card_faces?.[0]?.image_uris?.[z] || null;
const cmEur = c => parseFloat(c.prices?.eur || c.prices?.eur_foil || 0) || null;
const fmtEur = p => !p ? null : (p < 0.05 ? '< 0,05 €' : p.toFixed(2).replace('.',',') + ' €');

function onTap(el, fn) {
  if (!el) return;
  let moved = false;
  el.addEventListener('touchstart', () => { moved = false; }, {passive:true});
  el.addEventListener('touchmove',  () => { moved = true;  }, {passive:true});
  el.addEventListener('touchend', ev => { if (moved) return; ev.preventDefault(); fn(); }, {passive:false});
  el.addEventListener('click', fn);
}

// Mana cost parser → HTML symbols
function renderMana(cost) {
  if (!cost) return '';
  const tokens = cost.match(/\{[^}]+\}/g) || [];
  return tokens.map(t => {
    const inner = t.slice(1,-1);
    let cls = 'ms-num', display = inner;
    if (inner === 'W') { cls='ms-W'; display='W'; }
    else if (inner === 'U') { cls='ms-U'; display='U'; }
    else if (inner === 'B') { cls='ms-B'; display='B'; }
    else if (inner === 'R') { cls='ms-R'; display='R'; }
    else if (inner === 'G') { cls='ms-G'; display='G'; }
    else if (inner === 'C') { cls='ms-C'; display='◇'; }
    else if (inner === 'X') { cls='ms-X'; display='X'; }
    else if (/^\d+$/.test(inner)) { cls='ms-num'; display=inner; }
    else if (inner.includes('/')) {
      const parts = inner.split('/');
      cls = 'ms-' + parts[0]; display = parts.join('/');
    } else { cls='ms-N'; display=inner; }
    return `<span class="ms ${cls}">${display}</span>`;
  }).join('');
}

// ═══════════════════════════════════════════════════════
// SCRYFALL
// ═══════════════════════════════════════════════════════
async function sfGet(path) {
  const r = await fetch(SF + path, {mode:'cors'});
  if (!r.ok) throw new Error('SF ' + r.status);
  return r.json();
}
async function sfSearch(q, n=20) {
  try {
    const d = await sfGet('/cards/search?q=' + encodeURIComponent(q) + '&order=edhrec&unique=cards');
    return (d.data || []).slice(0, n);
  } catch { return []; }
}

// ═══════════════════════════════════════════════════════
// EDHREC  (browser fetch — CORS allowed from edhrec.com)
// ═══════════════════════════════════════════════════════
function edhrecSlug(name) {
  return name.toLowerCase()
    .replace(/,/g,'').replace(/['']/g,'')
    .replace(/[^a-z0-9 -]/g,'').replace(/\s+/g,'-');
}

async function fetchEDHREC(commander) {
  const slug = edhrecSlug(commander.name);
  const url = `https://json.edhrec.com/pages/commanders/${slug}.json`;
  try {
    const r = await fetch(url, {mode:'cors'});
    if (!r.ok) throw new Error('EDHREC ' + r.status);
    return r.json();
  } catch(e) {
    // fallback: try without articles/punctuation
    const slug2 = slug.replace(/-the-/g,'-').replace(/-of-/g,'-');
    if (slug2 !== slug) {
      try {
        const r = await fetch(`https://json.edhrec.com/pages/commanders/${slug2}.json`, {mode:'cors'});
        if (r.ok) return r.json();
      } catch {}
    }
    throw e;
  }
}

async function fetchEDHRECTheme(commander, theme) {
  const slug = edhrecSlug(commander.name);
  const url = `https://json.edhrec.com/pages/commanders/${slug}/${theme}.json`;
  const r = await fetch(url, {mode:'cors'});
  if (!r.ok) throw new Error('Theme not found');
  return r.json();
}

// Parse EDHREC JSON page to extract card recommendations
function parseEDHRECCards(data) {
  const cards = [];
  const container = data.container || {};
  const json_dict = container.json_dict || data;
  
  // Try multiple paths
  const cardrows = json_dict.cardlists || data.cardlists || [];
  cardrows.forEach(section => {
    const header = section.header || '';
    (section.cardviews || []).forEach(cv => {
      if (cv.name) {
        cards.push({
          name: cv.name,
          manaCost: cv.cards?.[0]?.cmc !== undefined ? null : null,
          synergy: cv.synergy,
          numDecks: cv.num_decks,
          percentDecks: cv.percent_decks,
          type: cv.primary_type || '',
          img: cv.image_uris?.art_crop || null,
          section: header,
        });
      }
    });
  });
  return cards;
}

// Extract themes/tags from EDHREC data
function parseEDHRECThemes(data) {
  const container = data.container || {};
  const panels = container.panels || data.panels || {};
  const links = [];
  
  // Try panels.links
  if (panels.links) {
    Object.entries(panels.links).forEach(([k, v]) => {
      if (Array.isArray(v)) {
        v.forEach(item => {
          if (item.label && item.href) links.push({label: item.label, href: item.href, count: item.count});
        });
      }
    });
  }
  
  // Also try top-level themes
  const related = data.related_info || data.relatedinfo || {};
  if (related.themes) {
    related.themes.forEach(t => links.push({label: t.label, href: t.href, count: t.count}));
  }

  // Try container.json_dict.taglinks
  const jd = container.json_dict || {};
  if (jd.taglinks) {
    (jd.taglinks || []).forEach(t => links.push({label: t.label || t.tag, href: t.href || t.slug, count: t.count}));
  }

  return links;
}

// ═══════════════════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════════════════
let searchTmr = null, lastQ = '';

window.addEventListener('load', function() {
  // Search
  const inp = document.getElementById('si');
  inp.addEventListener('input', function() {
    const v = this.value.trim();
    document.getElementById('scl').style.display = v ? 'flex' : 'none';
    clearTimeout(searchTmr);
    if (v.length < 2) { hideDr(); return; }
    if (v === lastQ) return;
    lastQ = v;
    showSpin(true);
    searchTmr = setTimeout(() => doSearch(v), 420);
  });
  inp.addEventListener('keydown', ev => { if (ev.key === 'Escape') hideDr(); });
  document.addEventListener('touchstart', ev => { if (!document.getElementById('sw').contains(ev.target)) hideDr(); }, {passive:true});
  document.addEventListener('click', ev => { if (!document.getElementById('sw').contains(ev.target)) hideDr(); });

  onTap(document.getElementById('scl'), clearSearch);
  onTap(document.getElementById('dz'), () => document.getElementById('cf').click());
  document.getElementById('cf').addEventListener('change', function() { loadFile(this.files[0]); });
  onTap(document.getElementById('clrColl'), clearColl);

  // P2
  onTap(document.getElementById('p2back'), () => go(1));
  onTap(document.getElementById('p2next'), () => go(3));

  // P3
  onTap(document.getElementById('p3back'), () => go(2));
  onTap(document.getElementById('p3gen'), generateDeck);
  document.getElementById('landslider').addEventListener('input', function() {
    S.landCount = +this.value;
    document.getElementById('landval').textContent = this.value;
    updateLandRec();
    renderSummary();
  });

  // P4
  onTap(document.getElementById('p4eb'), () => go(3));
  onTap(document.getElementById('p4er'), generateDeck);
  onTap(document.getElementById('adjBtn'), () => { go(3); document.getElementById('p4r').style.display='none'; });
  onTap(document.getElementById('expBtn'), exportAll);
  onTap(document.getElementById('dpA'), exportAll);
  onTap(document.getElementById('dpS'), exportSel);

  // Chat
  const chatInp = document.getElementById('chatInp');
  onTap(document.getElementById('chatSend'), () => handleChat(chatInp.value.trim()));
  chatInp.addEventListener('keydown', ev => { if (ev.key === 'Enter') handleChat(chatInp.value.trim()); });
});

// ═══════════════════════════════════════════════════════
// SEARCH
// ═══════════════════════════════════════════════════════
async function doSearch(q) {
  try {
    const cards = await sfSearch(`is:commander name:${q} game:paper`, 12);
    showDropdown(cards);
  } catch(err) {
    showErr(err.message);
  }
  showSpin(false);
}

function showDropdown(cards) {
  const d = document.getElementById('dr');
  if (!cards.length) { d.style.display='none'; return; }
  d.innerHTML = '';
  cards.forEach(c => {
    const img = gi(c,'small'), ci = c.color_identity || [];
    const div = document.createElement('div');
    div.className = 'dri';
    div.innerHTML =
      (img ? `<img class="drimg" src="${img}" alt="" loading="lazy" onerror="this.style.display='none'">` : '<div class="drimg"></div>') +
      `<div style="flex:1;min-width:0">
        <div class="drname">${esc(c.name)}${GC_CARDS.has(c.name)?'<span style="color:var(--gold);font-size:7px;margin-left:4px">[GC]</span>':''}</div>
        <div class="drtype">${esc((c.type_line||'').replace('Legendary ',''))}</div>
        <div class="drci">${ci.map(x=>`<div class="drciw" style="background:${COLORS[x]||'#888'}"></div>`).join('')}</div>
      </div>`;
    div._card = c;
    div.addEventListener('touchend', ev => { ev.preventDefault(); pickCard(div._card); });
    div.addEventListener('click', () => pickCard(div._card));
    d.appendChild(div);
  });
  d.style.display = 'block';
}

function hideDr() { document.getElementById('dr').style.display = 'none'; }
function showSpin(on) { document.getElementById('spin').style.display = on ? 'block' : 'none'; }
function showErr(msg) {
  const el = document.getElementById('serr');
  el.style.cssText = 'display:block;font-size:11px;color:#e06060;padding:6px 10px;background:rgba(180,50,50,.07);border:1px solid rgba(180,50,50,.18);border-radius:6px;font-family:DM Mono,monospace';
  el.textContent = msg;
  setTimeout(() => el.style.display='none', 4000);
}
function clearSearch() {
  document.getElementById('si').value = '';
  document.getElementById('scl').style.display = 'none';
  document.getElementById('sres').style.display = 'none';
  hideDr(); S.cmd = null; lastQ = '';
}

function pickCard(c) {
  S.cmd = c; hideDr();
  document.getElementById('si').value = c.name;
  document.getElementById('scl').style.display = 'flex';
  renderCmdrPreview(c);
}

function renderCmdrPreview(c) {
  const ci = c.color_identity || [];
  const bar = ci.length ? ci.map(x => COLORS[x] || '#555').join(',') : '#c89030';
  const imgN = gi(c,'normal'), txt = c.oracle_text || '';
  const eur = cmEur(c);
  const el = document.getElementById('sres');
  el.innerHTML = `
    <div class="cmdr">
      <div class="cmdr-stripe" style="background:linear-gradient(to bottom,${bar})"></div>
      ${imgN ? `<img class="cmdr-art" src="${imgN}" alt="" onerror="this.style.display='none'">` : ''}
      <div class="cmdr-info">
        <div class="cmdr-name">${esc(c.name)}${GC_CARDS.has(c.name)?'<span class="cmdr-gc" style="margin-left:6px">Gamechanger</span>':''}</div>
        <div class="cmdr-type">${esc((c.type_line||'').replace('Legendary ',''))}</div>
        <div class="cmdr-mana">${renderMana(c.mana_cost||'')}${ci.map(x=>`<span style="font-size:9px;color:${COLORS[x]};font-family:'DM Mono',monospace;margin-left:2px">${COLOR_NAMES[x]||x}</span>`).join('')}</div>
        ${GC_CARDS.has(c.name)?'':''}
        ${txt ? `<div class="cmdr-oracle">${esc(txt.slice(0,180))}${txt.length>180?'…':''}</div>` : ''}
        <div class="cmdr-meta">
          ${c.edhrec_rank ? `<span class="cmdr-rank">EDHREC #${c.edhrec_rank.toLocaleString('de')}</span>` : ''}
          ${eur ? `<span class="cmdr-price">~${fmtEur(eur)} (Cardmarket)</span>` : ''}
        </div>
        <div style="margin-top:10px"><button class="btn" id="cmdrgo">Themes wählen →</button></div>
      </div>
    </div>`;
  el.style.display = 'block';
  onTap(document.getElementById('cmdrgo'), () => go(2));
}

// ═══════════════════════════════════════════════════════
// COLLECTION
// ═══════════════════════════════════════════════════════
function hdrop(ev) { ev.preventDefault(); document.getElementById('dz').classList.remove('drag'); loadFile(ev.dataTransfer.files[0]); }
function loadFile(f) {
  if (!f) return;
  const r = new FileReader();
  r.onload = ev => {
    const cards = parseCollection(ev.target.result);
    if (!cards.size) { alert('Keine Karten erkannt.'); return; }
    S.coll = new Set([...cards].map(n => n.toLowerCase()));
    S.collMode = true;
    const d = document.getElementById('dz');
    d.classList.add('loaded'); d.textContent = cards.size + ' Karten geladen ✓';
    document.getElementById('ci2').style.display = 'flex';
    document.getElementById('ct').textContent = cards.size + ' Karten';
  };
  r.readAsText(f);
}
function parseCollection(txt) {
  const out = new Set();
  txt.split(/\r?\n/).map(l => l.trim()).filter(Boolean).forEach(line => {
    if (/^[/#]/.test(line) || /^(name|qty|quantity|card)/i.test(line)) return;
    let name = null;
    if (line.includes(',')) name = line.split(',').map(x => x.replace(/"/g,'').trim()).find(x => x.length > 1 && isNaN(+x));
    else { const m = line.match(/^(?:\d+[xX]?\s+)?(.+?)(?:\s+\(.*\))?$/); if (m) name = m[1].trim(); }
    if (name && name.length > 1 && name.length < 120) out.add(name);
  });
  return out;
}
function clearColl() { S.coll=null; S.collMode=false; const d=document.getElementById('dz'); d.classList.remove('loaded'); d.textContent='↑ CSV oder TXT ablegen'; document.getElementById('ci2').style.display='none'; }
function inColl(n) { return !S.collMode || !S.coll || S.coll.has(n.toLowerCase()); }

// ═══════════════════════════════════════════════════════
// PAGE 2: EDHREC TAGS
// ═══════════════════════════════════════════════════════
async function setupP2() {
  // Show mini commander card
  const c = S.cmd;
  const ci = c.color_identity || [];
  document.getElementById('p2cmdr').innerHTML = `
    <div style="display:flex;align-items:center;gap:10px;background:var(--s1);border:1px solid var(--b1);border-radius:8px;padding:10px 12px;margin-bottom:16px">
      ${gi(c,'small') ? `<img src="${gi(c,'small')}" style="width:22px;height:32px;border-radius:2px;object-fit:cover;object-position:top">` : ''}
      <div>
        <div style="font-family:'Cinzel',serif;font-size:12px;font-weight:700;color:var(--t1)">${esc(c.name)}</div>
        <div style="display:flex;gap:3px;margin-top:3px">${renderMana(c.mana_cost||'')}</div>
      </div>
    </div>`;

  // Reset
  S.themes = [];
  document.getElementById('tag-grid').innerHTML = '';
  document.getElementById('combo-tags').innerHTML = '';
  document.getElementById('tag-info').textContent = 'Lade EDHREC-Daten…';
  document.getElementById('tagload').textContent = '';
  document.getElementById('comboload').textContent = '';
  document.getElementById('p2next').disabled = true;

  // Fetch EDHREC
  try {
    const data = await fetchEDHREC(c);
    S.edhrecData = data;

    // Extract themes from the JSON
    const themes = extractThemes(data);
    const combos = extractCombos(data);

    renderTagGrid(themes, combos);
    document.getElementById('tag-info').textContent = themes.length ? `${themes.length} Themes von EDHREC gefunden — wähle bis zu 2:` : 'Keine spezifischen Themes gefunden — verwende generische Kategorien.';
    document.getElementById('tagload').textContent = `(${themes.length} Themes)`;
    document.getElementById('comboload').textContent = combos.length ? `(${combos.length} Kombos)` : '(keine)';
  } catch(e) {
    document.getElementById('tag-info').textContent = 'EDHREC nicht erreichbar — generische Themes verwendet.';
    renderTagGrid(getGenericThemes(S.cmd), []);
  }
  // Enable next even without theme selection
  document.getElementById('p2next').disabled = false;
}

function extractThemes(data) {
  const themes = [];
  const seen = new Set();

  // Path 1: panels.links (most common)
  try {
    const panels = data.container?.panels || data.panels || {};
    const links = panels.links || panels.taglinks || {};
    Object.values(links).flat().forEach(item => {
      if (item?.label && !seen.has(item.label)) {
        seen.add(item.label);
        themes.push({ label: item.label, slug: (item.href||item.slug||'').replace(/.*commanders\/[^/]+\//,''), count: item.num_decks || item.count || 0 });
      }
    });
  } catch {}

  // Path 2: container.json_dict.taglinks
  try {
    const tl = data.container?.json_dict?.taglinks || [];
    tl.forEach(t => {
      const label = t.label || t.tag || '';
      if (label && !seen.has(label)) {
        seen.add(label);
        themes.push({ label, slug: t.href || t.slug || '', count: t.num_decks || 0 });
      }
    });
  } catch {}

  // Path 3: relatedinfo / related_info
  try {
    const ri = data.relatedinfo || data.related_info || {};
    (ri.themes || ri.taglinks || []).forEach(t => {
      const label = t.label || t.tag;
      if (label && !seen.has(label)) {
        seen.add(label);
        themes.push({ label, slug: t.href || t.slug || '', count: t.num_decks || 0 });
      }
    });
  } catch {}

  return themes.sort((a,b) => b.count - a.count);
}

function extractCombos(data) {
  const combos = [];
  try {
    const panels = data.container?.panels || data.panels || {};
    const comboSection = panels.combos || panels['combos'] || [];
    (Array.isArray(comboSection) ? comboSection : []).forEach(c => {
      combos.push({ label: c.label || c.name || '', count: c.num_decks || 0 });
    });
    // also try container.json_dict.combos
    const jdcombos = data.container?.json_dict?.combos || [];
    jdcombos.forEach(c => combos.push({ label: c.label || c.name || '', count: c.num_decks || 0 }));
  } catch {}
  return combos.slice(0, 8);
}

function getGenericThemes(cmd) {
  const types = (cmd?.oracle_text || '').toLowerCase();
  const themes = [
    {label:'Tokens', slug:'tokens', count:0},
    {label:'Voltron', slug:'voltron', count:0},
    {label:'Reanimator', slug:'reanimator', count:0},
    {label:'Combo', slug:'combo', count:0},
    {label:'Stax', slug:'stax', count:0},
    {label:'Spellslinger', slug:'spellslinger', count:0},
    {label:'Graveyard', slug:'graveyard', count:0},
    {label:'Tribal', slug:'tribal', count:0},
    {label:'Aristocrats', slug:'aristocrats', count:0},
    {label:'Landfall', slug:'landfall', count:0},
    {label:'Blink', slug:'blink', count:0},
    {label:'Artifacts', slug:'artifacts', count:0},
    {label:'+1/+1 Counters', slug:'counters', count:0},
    {label:'Enchantress', slug:'enchantress', count:0},
  ];
  return themes;
}

function renderTagGrid(themes, combos) {
  const grid = document.getElementById('tag-grid');
  grid.innerHTML = '';
  if (!themes.length) {
    grid.innerHTML = '<span style="font-size:11px;color:var(--t4);font-family:\'DM Mono\',monospace">Keine Themes verfügbar</span>';
    return;
  }
  themes.forEach((t, i) => {
    const div = document.createElement('div');
    div.className = 'tag';
    div.innerHTML = esc(t.label) + (t.count ? ` <span class="tag-count">${t.count.toLocaleString('de')}</span>` : '');
    div._theme = t;
    div.addEventListener('touchend', ev => { ev.preventDefault(); toggleTheme(div._theme, div); });
    div.addEventListener('click', () => toggleTheme(div._theme, div));
    grid.appendChild(div);
  });

  // Combo tags (informational only)
  const cg = document.getElementById('combo-tags');
  if (combos.length) {
    combos.forEach(c => {
      const div = document.createElement('div');
      div.className = 'tag';
      div.style.opacity = '.6';
      div.innerHTML = `∞ ${esc(c.label)}`;
      div.style.cursor = 'default';
      cg.appendChild(div);
    });
  } else {
    cg.innerHTML = '<span style="font-size:10px;color:var(--t4);font-family:\'DM Mono\',monospace">Keine Kombos für diesen Commander auf EDHREC</span>';
  }
}

function toggleTheme(t, el) {
  const idx = S.themes.findIndex(x => x.label === t.label);
  if (idx >= 0) {
    S.themes.splice(idx, 1);
  } else {
    if (S.themes.length >= 2) {
      // Remove first
      const firstLabel = S.themes[0].label;
      document.querySelectorAll('.tag').forEach(el2 => {
        if (el2._theme?.label === firstLabel) { el2.classList.remove('sel','sel2'); }
      });
      S.themes.shift();
    }
    S.themes.push(t);
  }
  // Re-render selections
  document.querySelectorAll('.tag').forEach(el2 => {
    el2.classList.remove('sel','sel2');
    const tidx = S.themes.findIndex(x => x.label === el2._theme?.label);
    if (tidx === 0) el2.classList.add('sel');
    else if (tidx === 1) el2.classList.add('sel2');
  });
}

// ═══════════════════════════════════════════════════════
// PAGE 3: Bracket + Lands + Budget
// ═══════════════════════════════════════════════════════
function setupP3() {
  // Bracket
  const bg = document.getElementById('bgrid'); bg.innerHTML = '';
  BR.forEach(b => {
    const div = document.createElement('div'); div.className='bc'; div.id='br'+b.id;
    div.style.setProperty('--cc', b.c);
    div.innerHTML = `<div class="bc-num">${b.id}</div><div class="bc-lbl">${b.label}</div>`;
    div._bid = b.id;
    div.addEventListener('touchend', ev => { ev.preventDefault(); selBr(div._bid); });
    div.addEventListener('click', () => selBr(div._bid));
    bg.appendChild(div);
  });
  // Opts
  const og = document.getElementById('og'); og.innerHTML = '';
  OPT.forEach(o => {
    const div = document.createElement('div'); div.className='oc'; div.id='oc'+o.id;
    div.textContent = o.n; div._oid = o.id;
    div.addEventListener('touchend', ev => { ev.preventDefault(); togOpt(div._oid); });
    div.addEventListener('click', () => togOpt(div._oid));
    og.appendChild(div);
  });
  // Budget
  const pg = document.getElementById('pgrid'); pg.innerHTML = '';
  PT.forEach(p => {
    const div = document.createElement('div'); div.className='pc'; div.id='pt'+p.id;
    div.innerHTML = `<div class="pc-dot" style="background:${p.c}"></div><span class="pc-l">${p.l}</span>`;
    div._pid = p.id;
    div.addEventListener('touchend', ev => { ev.preventDefault(); selPt(div._pid); });
    div.addEventListener('click', () => selPt(div._pid));
    pg.appendChild(div);
  });
  updateLandRec();
  renderSummary();
}

function selBr(id) {
  S.bracket = id;
  document.querySelectorAll('.bc').forEach(el => el.classList.remove('sel'));
  const el = document.getElementById('br'+id); el.classList.add('sel');
  el.style.borderColor = BR.find(x=>x.id===id).c;
  renderSummary();
}
function togOpt(id) {
  const el = document.getElementById('oc'+id);
  if (S.opts.includes(id)) { S.opts = S.opts.filter(x=>x!==id); el.classList.remove('sel'); }
  else { S.opts.push(id); el.classList.add('sel'); }
}
function selPt(id) {
  S.pt = id;
  document.querySelectorAll('.pc').forEach(el => el.classList.remove('sel'));
  const el = document.getElementById('pt'+id); el.classList.add('sel');
  el.style.borderColor = PT.find(x=>x.id===id).c;
  renderSummary();
}

function updateLandRec() {
  // Recommend land count based on commander's average mana cost and color count
  const c = S.cmd;
  if (!c) return;
  const ci = c.color_identity || [];
  const cmc = c.cmc || 3;
  let rec = 36;
  if (cmc <= 2) rec = 33;
  else if (cmc <= 3) rec = 35;
  else if (cmc >= 5) rec = 38;
  if (ci.length >= 4) rec = Math.max(rec, 37);
  document.getElementById('landrec').textContent = `Empfehlung: ${rec} für diesen Commander (MK ${cmc}, ${ci.length} Farben)`;
}

function renderSummary() {
  const b = BR.find(x=>x.id===S.bracket), p = PT.find(x=>x.id===S.pt);
  const ci = S.cmd?.color_identity || [];
  document.getElementById('sumbox').innerHTML =
    '<div class="lbl" style="margin-top:0;margin-bottom:8px">Zusammenfassung</div>' +
    `<div class="srow"><span class="sk">Commander</span><span class="sv">${S.cmd ? esc(S.cmd.name) : '—'}</span></div>` +
    `<div class="srow"><span class="sk">Farben</span><span class="sv">${ci.map(c=>`<span style="color:${COLORS[c]}">${COLOR_NAMES[c]}</span>`).join(' · ')||'Farblos'}</span></div>` +
    `<div class="srow"><span class="sk">Themes</span><span class="sv">${S.themes.length ? S.themes.map(t=>esc(t.label)).join(' + ') : 'Kein Theme'}</span></div>` +
    `<div class="srow"><span class="sk">Bracket</span><span class="sv" style="color:${b?b.c:'#fff'}">${b ? b.id+' — '+b.label : '—'}</span></div>` +
    `<div class="srow"><span class="sk">Länder</span><span class="sv">${S.landCount}</span></div>` +
    `<div class="srow"><span class="sk">Budget</span><span class="sv" style="color:${p?p.c:'#fff'}">${p ? p.l : '—'}</span></div>`;
}

// ═══════════════════════════════════════════════════════
// DECK GENERATION
// ═══════════════════════════════════════════════════════
async function generateDeck() {
  if (!S.bracket || !S.pt) { alert('Bitte Bracket und Budget wählen.'); return; }
  go(4);
  document.getElementById('p4l').style.display = 'block';
  document.getElementById('p4e').style.display = 'none';
  document.getElementById('p4r').style.display = 'none';
  S.deck = [];

  const ci = S.cmd?.color_identity || [];
  const cs = ci.length ? ci.join('') : 'C';
  const pt = PT.find(x=>x.id===S.pt);
  const maxEur = pt?.max || 9999;
  const pf = maxEur < 9999 ? ` eur<=${maxEur}` : '';
  const gcOk = S.opts.includes('gc') || S.bracket >= 3;
  const comboOk = S.opts.includes('combo') || S.bracket >= 4;
  const tutorOk = S.opts.includes('tutor') || S.bracket >= 3;
  const targetTotal = 99; // Commander is 1, so 99 in the 99

  let progress = 0;
  function log(msg, pct) {
    document.getElementById('lmsg').textContent = msg;
    progress = pct || progress;
    document.getElementById('lbarf').style.width = progress + '%';
    const li = document.createElement('div'); li.className='li'; li.textContent='▸ '+msg;
    document.getElementById('llog').appendChild(li);
  }

  try {
    const seen = new Set(); // global dedup

    // Helper to add cards to seen and return filtered
    function dedup(arr) {
      return arr.filter(c => { if (seen.has(c.name)) return false; seen.add(c.name); return true; });
    }

    // --- STEP 1: Fetch EDHREC data for this commander + themes ---
    log('Lade EDHREC-Empfehlungen…', 5);
    let edhCards = [];
    let themeCards = {};

    // Try main commander page
    if (S.edhrecData) {
      edhCards = parseEDHRECPage(S.edhrecData, gcOk, comboOk);
    } else {
      try {
        const data = await fetchEDHREC(S.cmd);
        S.edhrecData = data;
        edhCards = parseEDHRECPage(data, gcOk, comboOk);
      } catch { log('EDHREC nicht erreichbar — nutze Scryfall', 5); }
    }

    // Fetch theme-specific EDHREC pages
    for (const theme of S.themes) {
      if (!theme.slug) continue;
      log(`Lade EDHREC Theme: ${theme.label}…`, 10);
      try {
        const slug = edhrecSlug(S.cmd.name);
        const themeSlug = theme.slug.replace(/.*\//, '');
        const tdata = await fetchEDHRECTheme(S.cmd, themeSlug);
        themeCards[theme.label] = parseEDHRECPage(tdata, gcOk, comboOk);
      } catch {
        log(`Theme ${theme.label} nicht via EDHREC verfügbar`, 10);
      }
    }
    await slp(100);

    // --- STEP 2: Build card pool smartly ---
    // Priority: Theme cards first, then general EDHREC, then Scryfall fallback
    // Each card appears only ONCE in the final deck

    const base = `id<=${cs} -is:land -is:dfc game:paper${pf}`;

    // Pool: theme-specific cards (highest priority)
    const themePool = [];
    Object.values(themeCards).flat().forEach(c => themePool.push({...c, priority: 10}));

    // Pool: general EDHREC cards
    edhCards.forEach(c => themePool.push({...c, priority: 5}));

    // Sort by synergy/priority, deduplicate
    themePool.sort((a,b) => (b.synergy||0) - (a.synergy||0) || (b.priority||0) - (a.priority||0));
    const edhPool = [];
    const edhSeen = new Set();
    themePool.forEach(c => { if (!edhSeen.has(c.name)) { edhSeen.add(c.name); edhPool.push(c); } });

    log('Karten werden kategorisiert…', 25);

    // We need: ramp(~10), draw(~9), removal(~9), synergy(~20), wincon(~5), utility(~5) + lands
    // Strategy: pull from EDHREC pool by type, then fill with Scryfall

    async function getCards(typeFilter, minCount, sfQuery, sfCount) {
      // First try EDHREC pool
      const fromEdh = edhPool.filter(c => !seen.has(c.name) && typeFilter(c)).slice(0, minCount);
      const result = dedup(fromEdh.map(c => ({name:c.name, type:c.type||'', manaCost:'', price:null, img:c.img, synergy:c.synergy, isGC:GC_CARDS.has(c.name), isCombo:COMBOS.has(c.name)})));
      
      // Fill with Scryfall if needed
      if (result.length < minCount && sfQuery) {
        const sfCards = await sfSearch(sfQuery, sfCount);
        dedup(sfCards).slice(0, minCount - result.length).forEach(c => {
          result.push({name:c.name, type:c.type_line||'', manaCost:c.mana_cost||'', price:cmEur(c), img:gi(c,'small'), synergy:0, isGC:GC_CARDS.has(c.name), isCombo:COMBOS.has(c.name)});
        });
      }
      return result;
    }

    // --- MANA RAMP (10 cards) ---
    log('Mana-Ramp…', 30);
    const ramp = await getCards(
      c => /ramp|mana|rock|sol ring|accelerat/i.test(c.type+c.name) || (c.synergy||0) > 0,
      10,
      `${base} (o:"add {" OR o:"search your library" o:"land") cmc<=4 (type:artifact OR type:sorcery OR type:land)`, 14
    );
    // Force-add Sol Ring for casual/focused if not GC-banned
    if (!seen.has('Sol Ring') && (gcOk || S.bracket <= 2)) {
      try { const sr = await sfGet('/cards/named?exact=Sol Ring'); if(sr) { seen.add('Sol Ring'); ramp.unshift({name:'Sol Ring',type:'Artifact',manaCost:'{1}',price:cmEur(sr),img:gi(sr,'small'),synergy:99,isGC:GC_CARDS.has('Sol Ring')}); } } catch {}
    }
    await slp(80);

    // --- CARD DRAW (9 cards) ---
    log('Karten-Vorteil…', 38);
    const draw = await getCards(
      c => /draw|card advantage|wheel/i.test(c.name) || (c.synergy||0) > 0,
      9,
      `${base} (o:"draw" o:"card") cmc<=5`, 12
    );
    await slp(80);

    // --- REMOVAL (9 cards) ---
    log('Removal & Interaction…', 45);
    const removal = await getCards(
      c => /destroy|exile|counter|remove|wrath|sweep|doom/i.test(c.name),
      9,
      `${base} (o:"destroy target" OR o:"exile target" OR o:"counter target") cmc<=6`, 12
    );
    await slp(80);

    // --- THEME SYNERGIES (20 cards) ---
    log(`Synergien (${S.themes.length ? S.themes.map(t=>t.label).join('+') : 'generisch'})…`, 52);
    const synCards = await getCards(
      c => (c.synergy||0) > 2 || S.themes.some(t => (c.name+c.type).toLowerCase().includes(t.label.toLowerCase())),
      20,
      buildThemeQuery(S.themes, S.cmd, cs, pf, comboOk), 24
    );
    await slp(80);

    // --- WIN CONDITIONS (5 cards) ---
    log('Win Conditions…', 60);
    const winCons = await getCards(
      c => /win the game|each opponent lose|finisher/i.test(c.name+c.type),
      5,
      comboOk ? `${base} (o:"you win the game" OR o:"each opponent loses") cmc<=8` 
               : `${base} type:creature (o:"trample" OR o:"haste" OR o:"unblockable") cmc>=5`, 8
    );
    await slp(80);

    // --- UTILITY / PROTECTION (5 cards) ---
    log('Utility & Schutz…', 67);
    const utility = await getCards(
      c => /protection|hexproof|indestructible|boots|cloak/i.test(c.name),
      5,
      `${base} (o:"hexproof" OR o:"indestructible") cmc<=4`, 8
    );
    await slp(80);

    // Combine non-land cards
    const nonLands = [...ramp, ...draw, ...removal, ...synCards, ...winCons, ...utility];
    const nonLandTarget = targetTotal - S.landCount;

    // Trim to target if over, pad if under
    let finalNonLands = nonLands.slice(0, nonLandTarget);
    if (finalNonLands.length < nonLandTarget) {
      log('Fülle fehlende Karten auf…', 73);
      const extra = await sfSearch(`${base} type:creature cmc<=4`, nonLandTarget - finalNonLands.length + 5);
      dedup(extra).slice(0, nonLandTarget - finalNonLands.length).forEach(c => {
        finalNonLands.push({name:c.name, type:c.type_line||'', manaCost:c.mana_cost||'', price:cmEur(c), img:gi(c,'small'), synergy:0, isGC:GC_CARDS.has(c.name), isCombo:COMBOS.has(c.name)});
      });
    }

    // --- LANDS ---
    log('Mana-Basis…', 78);
    const landSeen = new Set(finalNonLands.map(c => c.name));
    const nonBasicLands = [];
    if (ci.length > 1) {
      try { const ct = await sfGet('/cards/named?exact=Command+Tower'); if(ct && !landSeen.has('Command Tower')) { landSeen.add('Command Tower'); nonBasicLands.push({name:'Command Tower',type:'Land',manaCost:'',price:cmEur(ct),img:gi(ct,'small')}); } } catch {}
    }
    const fetchedLands = await sfSearch(`id<=${cs} type:land -type:basic game:paper${pf} (o:"add" OR o:"search your library")`, 20);
    fetchedLands.forEach(c => {
      if (!landSeen.has(c.name)) { landSeen.add(c.name); nonBasicLands.push({name:c.name,type:c.type_line||'Land',manaCost:'',price:cmEur(c),img:gi(c,'small')}); }
    });

    const nonBasicCount = Math.min(nonBasicLands.length, Math.floor(S.landCount * 0.65));
    const basicCount = S.landCount - nonBasicCount;
    const basics = [];
    if (ci.length > 0) {
      const perColor = Math.floor(basicCount / ci.length);
      const rem = basicCount % ci.length;
      ci.forEach((col, idx) => {
        const bn = BASICS[col]; if (!bn) return;
        const cnt = perColor + (idx < rem ? 1 : 0);
        for (let i = 0; i < cnt; i++) basics.push({name:bn,type:'Basic Land',manaCost:'',price:0.1,img:null,isBasic:true});
      });
    } else {
      for (let i = 0; i < basicCount; i++) basics.push({name:'Wastes',type:'Basic Land',manaCost:'',price:0.1,img:null,isBasic:true});
    }
    const allLands = [...nonBasicLands.slice(0, nonBasicCount), ...basics];

    // FINAL DECK
    S.deck = [...finalNonLands, ...allLands];

    log('Fertig!', 100);
    await slp(200);

    // Enrich with Scryfall data (mana costs, types) for cards from EDHREC pool
    await enrichDeckData();

    document.getElementById('p4l').style.display = 'none';
    renderDeckPage();
  } catch(err) {
    document.getElementById('p4l').style.display = 'none';
    document.getElementById('p4e').style.display = 'block';
    document.getElementById('etxt').textContent = err.message;
  }
}

// Parse EDHREC page data into card objects
function parseEDHRECPage(data, gcOk, comboOk) {
  const cards = [];
  try {
    const container = data.container || {};
    const jd = container.json_dict || data;
    const lists = jd.cardlists || data.cardlists || [];
    lists.forEach(section => {
      (section.cardviews || []).forEach(cv => {
        if (!cv.name) return;
        if (!gcOk && GC_CARDS.has(cv.name)) return;
        if (!comboOk && COMBOS.has(cv.name)) return;
        cards.push({
          name: cv.name,
          synergy: cv.synergy || 0,
          numDecks: cv.num_decks || 0,
          type: cv.primary_type || '',
          img: null,
        });
      });
    });
  } catch {}
  return cards;
}

function buildThemeQuery(themes, cmd, cs, pf, comboOk) {
  const base = `id<=${cs} -is:land -is:dfc game:paper${pf}`;
  const oracle = (cmd?.oracle_text || '').toLowerCase();
  const name = (cmd?.name || '').toLowerCase();

  if (!themes.length) return `${base} type:creature o:"whenever" cmc<=5`;

  const themeMap = {
    'voltron':       `${base} (type:aura OR type:equipment) (o:"enchanted" OR o:"equipped")`,
    'enchantress':   `${base} (type:enchantment OR (type:creature o:"enchantment"))`,
    'auras':         `${base} type:aura`,
    'equipment':     `${base} type:equipment`,
    'tokens':        `${base} o:"create" o:"token"`,
    'reanimator':    `${base} (o:"from your graveyard" OR o:"unearth" OR o:"dredge")`,
    'graveyard':     `${base} (o:"flashback" OR o:"unearth" OR o:"dredge" OR o:"from your graveyard")`,
    'landfall':      `${base} o:"landfall"`,
    'combo':         comboOk ? `${base} (o:"untap" o:"whenever") cmc<=4` : `${base} type:creature cmc<=4`,
    'stax':          `${base} o:"opponent" o:"can't" type:permanent`,
    'tribal':        `${base} type:creature cmc<=4`,
    'blink':         `${base} (o:"exile" o:"return" o:"enters the battlefield")`,
    'aristocrats':   `${base} o:"whenever a creature" o:"dies"`,
    'spellslinger':  `${base} o:"whenever you cast" o:"instant or sorcery"`,
    'artifacts':     `${base} type:artifact`,
    '+1/+1 counters':`${base} o:"+1/+1 counter" o:"whenever"`,
    'counters':      `${base} o:"+1/+1 counter" o:"whenever"`,
    'infect':        `${base} o:"infect"`,
  };

  // Find first matching theme
  for (const t of themes) {
    const key = t.label.toLowerCase();
    for (const [k, q] of Object.entries(themeMap)) {
      if (key.includes(k)) return q;
    }
  }

  // If commander text mentions auras / equipment → voltron fallback
  if (/aura|enchantment|equip/.test(oracle)) return `${base} (type:aura OR type:equipment)`;

  return `${base} type:creature o:"whenever" cmc<=5`;
}

// Enrich deck cards with Scryfall data (types, mana costs)
async function enrichDeckData() {
  const toEnrich = S.deck.filter(c => !c.isBasic && (!c.manaCost && !c.type));
  if (!toEnrich.length) return;
  // Batch: Scryfall collection endpoint
  const chunks = [];
  for (let i = 0; i < toEnrich.length; i += 75) chunks.push(toEnrich.slice(i, i+75));
  for (const chunk of chunks) {
    try {
      const body = {identifiers: chunk.map(c => ({name: c.name}))};
      const r = await fetch(`${SF}/cards/collection`, {method:'POST', mode:'cors', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
      if (!r.ok) continue;
      const data = await r.json();
      (data.data || []).forEach(sfCard => {
        const d = S.deck.find(c => c.name === sfCard.name);
        if (d) {
          d.type = d.type || sfCard.type_line || '';
          d.manaCost = d.manaCost || sfCard.mana_cost || '';
          d.price = d.price ?? cmEur(sfCard);
          d.img = d.img || gi(sfCard,'small');
        }
      });
    } catch {}
    await slp(120);
  }
}

// ═══════════════════════════════════════════════════════
// RENDER DECK
// ═══════════════════════════════════════════════════════
function cardSection(card) {
  const t = (card.type || '').toLowerCase();
  if (card.isBasic || t.includes('land')) return 'Land';
  if (t.includes('creature')) return 'Creature';
  if (t.includes('instant')) return 'Instant';
  if (t.includes('sorcery')) return 'Sorcery';
  if (t.includes('enchantment')) return 'Enchantment';
  if (t.includes('artifact')) return 'Artifact';
  if (t.includes('planeswalker')) return 'Planeswalker';
  return 'Other';
}

function renderDeckPage() {
  const c = S.cmd, b = BR.find(x=>x.id===S.bracket), p = PT.find(x=>x.id===S.pt);
  const ci = c?.color_identity || [];
  const total = 1 + S.deck.length;

  // Header
  document.getElementById('deckArt').src = gi(c,'art_crop') || gi(c,'normal') || '';
  document.getElementById('deckTitle').textContent = c?.name || '';
  document.getElementById('deckChips').innerHTML =
    ci.map(col=>`<span class="chip" style="color:${COLORS[col]}">${COLOR_NAMES[col]}</span>`).join('') +
    (b ? `<span class="chip" style="color:${b.c}">${b.label}</span>` : '') +
    (p ? `<span class="chip" style="color:${p.c}">${p.l}</span>` : '') +
    S.themes.map(t=>`<span class="chip" style="color:var(--gold)">${esc(t.label)}</span>`).join('') +
    `<span class="chip" style="color:${total===100?'var(--green)':'var(--red)'}">${total}/100</span>`;

  const totalPrice = [c].concat(S.deck).reduce((s,card) => s + (card?.price||0), 0);
  document.getElementById('deckStats').innerHTML =
    `<span class="dstat"><strong>${total}</strong> Karten</span>` +
    `<span class="dstat"><strong>${S.deck.filter(c=>cardSection(c)==='Land').length}</strong> Länder</span>` +
    (totalPrice > 0 ? `<span class="dstat">~<strong>${totalPrice.toFixed(2).replace('.',',')} €</strong> Cardmarket</span>` : '');

  renderDeckSections();
  document.getElementById('p4r').style.display = 'block';
  updatePanel();
}

function renderDeckSections() {
  // Group cards by section
  const groups = {};
  SECTION_ORDER.forEach(s => groups[s.key] = []);
  S.deck.forEach(card => {
    const s = cardSection(card);
    if (groups[s]) groups[s].push(card);
    else groups['Other'].push(card);
  });

  const cont = document.getElementById('deckSections');
  cont.innerHTML = '';

  SECTION_ORDER.forEach(sec => {
    if (sec.key === 'Commander') return; // handled in header
    const cards = groups[sec.key];
    if (!cards.length) return;

    // Consolidate basic lands
    const displayCards = sec.key === 'Land' ? consolidateBasics(cards) : cards;

    const div = document.createElement('div');
    div.className = 'section-group';
    div.innerHTML = `
      <div class="sg-header">
        <div class="sg-title">${sec.icon} ${sec.label} <span class="sg-count">${cards.length}</span></div>
        <button class="sg-addall" id="sa_${sec.key}">Alle hinzufügen</button>
      </div>
      <div class="card-list" id="cl_${sec.key}"></div>`;
    cont.appendChild(div);

    onTap(document.getElementById('sa_'+sec.key), () => addAll(sec.key));
    const list = document.getElementById('cl_'+sec.key);
    displayCards.forEach(card => list.appendChild(buildCardItem(card)));
  });
}

function consolidateBasics(cards) {
  const counts = {};
  cards.forEach(c => { counts[c.name] = (counts[c.name]||0) + 1; });
  const seen = new Set();
  return cards.filter(c => { if (seen.has(c.name)) return false; seen.add(c.name); return true; })
              .map(c => ({...c, _qty: counts[c.name]}));
}

function buildCardItem(card) {
  const inDeck = S.deck.findIndex(c => c === card) >= 0 && S.deck.some(c => c.name === card.name && (window._selected||new Set()).has(c.name));
  const qty = card._qty || 1;
  const div = document.createElement('div');
  div.className = 'citem' + (GC_CARDS.has(card.name)?' is-gc':'');
  div.id = 'ci_' + CSS.escape(card.name);
  div.innerHTML =
    `<span class="citem-qty">${qty > 1 ? qty+'×' : '1×'}</span>` +
    (card.img ? `<img class="citem-img" src="${card.img}" alt="" loading="lazy" onerror="this.style.display='none'">` : '<div class="citem-img"></div>') +
    `<span class="citem-name">${esc(card.name)}</span>` +
    `<span class="citem-type">${esc((card.type||'').replace('Legendary ','').split(' — ')[0])}</span>` +
    `<div class="citem-mana">${card.manaCost ? renderMana(card.manaCost) : ''}</div>` +
    `<div class="citem-badges">${GC_CARDS.has(card.name)?'<span class="badge-gc">GC</span>':''}${COMBOS.has(card.name)?'<span class="badge-combo">∞</span>':''}</div>` +
    (card.price && !card.isBasic ? `<span class="citem-price">${fmtEur(card.price)}</span>` : '') +
    `<button class="citem-add" id="ca_${CSS.escape(card.name)}">＋ Deck</button>`;
  
  window._selected = window._selected || new Set();
  const addBtn = div.querySelector('.citem-add');
  addBtn._card = card;
  addBtn.addEventListener('touchend', ev => { ev.preventDefault(); toggleCard(addBtn._card, addBtn); });
  addBtn.addEventListener('click', () => toggleCard(addBtn._card, addBtn));
  return div;
}

window._selected = new Set();

function toggleCard(card, btn) {
  const name = card.name;
  if (window._selected.has(name)) {
    window._selected.delete(name);
    btn.textContent = '＋ Deck';
    btn.closest('.citem').classList.remove('in-deck');
  } else {
    window._selected.add(name);
    btn.textContent = '✓ Im Deck';
    btn.closest('.citem').classList.add('in-deck');
  }
  updatePanel();
}

function addAll(sectionKey) {
  const groups = {};
  SECTION_ORDER.forEach(s => groups[s.key] = []);
  S.deck.forEach(card => {
    const s = cardSection(card);
    if (groups[s]) groups[s].push(card);
    else groups['Other'].push(card);
  });
  (groups[sectionKey] || []).forEach(card => window._selected.add(card.name));
  renderDeckSections(); // re-render to update buttons
  updatePanel();
}

function updatePanel() {
  const sel = window._selected || new Set();
  const total = 1 + sel.size; // +1 for commander
  document.getElementById('dpcnt').textContent = total;
  document.getElementById('dpsub').textContent = S.cmd ? 'Commander: ' + S.cmd.name : '';
  document.getElementById('dppf').style.width = Math.min(100, total) + '%';
  document.getElementById('dp').style.display = 'flex';
}

// ═══════════════════════════════════════════════════════
// AI CHAT ASSISTANT (via Claude API built into artifact env)
// ═══════════════════════════════════════════════════════
async function handleChat(msg) {
  if (!msg) return;
  const inp = document.getElementById('chatInp');
  inp.value = '';
  
  appendChatMsg('user', msg);
  document.getElementById('chatSend').disabled = true;
  document.getElementById('chatTyping').style.display = 'block';

  try {
    // Build context about current deck
    const deckContext = buildDeckContext();
    
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1000,
        messages: [{
          role: 'user',
          content: `Du bist ein MTG Commander Deck-Assistent. Hier ist der aktuelle Deck-Kontext:
${deckContext}

Nutzer-Anfrage: "${msg}"

Antworte auf Deutsch. Wenn der Nutzer Karten hinzufügen/entfernen/ersetzen möchte, gib eine JSON-Antwort in folgendem Format zurück (zusätzlich zu deiner Text-Erklärung):

[DECK_CHANGES]
{
  "add": ["Kartenname 1", "Kartenname 2"],
  "remove": ["Kartenname 3"],
  "explanation": "Kurze Erklärung der Änderungen"
}
[/DECK_CHANGES]

Wenn keine Deck-Änderungen gewünscht, lass den JSON-Block weg. Halte die Antwort kurz (max 3 Sätze).`
        }]
      })
    });

    const data = await response.json();
    const text = data.content?.[0]?.text || 'Keine Antwort';
    
    // Parse deck changes if present
    const changesMatch = text.match(/\[DECK_CHANGES\]([\s\S]*?)\[\/DECK_CHANGES\]/);
    let displayText = text.replace(/\[DECK_CHANGES\][\s\S]*?\[\/DECK_CHANGES\]/g, '').trim();
    
    if (changesMatch) {
      try {
        const changes = JSON.parse(changesMatch[1].trim());
        applyDeckChanges(changes);
        displayText += changes.explanation ? `\n\n${changes.explanation}` : '';
      } catch {}
    }
    
    appendChatMsg('ai', displayText);
  } catch(err) {
    appendChatMsg('ai', `Fehler: ${err.message}. Bitte versuche es erneut.`);
  }

  document.getElementById('chatSend').disabled = false;
  document.getElementById('chatTyping').style.display = 'none';
}

function buildDeckContext() {
  const groups = {};
  SECTION_ORDER.forEach(s => groups[s.label] = []);
  S.deck.forEach(card => {
    const s = cardSection(card);
    const label = SECTION_ORDER.find(x=>x.key===s)?.label || 'Sonstige';
    if (!groups[label]) groups[label] = [];
    groups[label].push(card.name);
  });
  return `Commander: ${S.cmd?.name || 'unbekannt'}
Themes: ${S.themes.map(t=>t.label).join(', ') || 'keine'}
Bracket: ${S.bracket || 'unbekannt'}
Deck (${S.deck.length} Karten):
${Object.entries(groups).filter(([,v])=>v.length).map(([k,v])=>`${k} (${v.length}): ${v.slice(0,8).join(', ')}${v.length>8?'…':''}`).join('\n')}`;
}

function applyDeckChanges(changes) {
  if (changes.remove) {
    changes.remove.forEach(name => {
      const idx = S.deck.findIndex(c => c.name.toLowerCase() === name.toLowerCase());
      if (idx >= 0) { window._selected.delete(S.deck[idx].name); S.deck.splice(idx, 1); }
    });
  }
  if (changes.add) {
    // Queue Scryfall fetches for added cards
    changes.add.forEach(async name => {
      try {
        const c = await sfGet('/cards/named?fuzzy=' + encodeURIComponent(name));
        if (c && c.name) {
          S.deck.push({name:c.name, type:c.type_line||'', manaCost:c.mana_cost||'', price:cmEur(c), img:gi(c,'small'), isGC:GC_CARDS.has(c.name), isCombo:COMBOS.has(c.name)});
          window._selected.add(c.name);
          renderDeckSections();
          updatePanel();
        }
      } catch {}
    });
  }
  renderDeckSections();
  updatePanel();
}

function appendChatMsg(role, text) {
  const msgs = document.getElementById('chatMsgs');
  const div = document.createElement('div');
  div.className = 'chat-msg ' + role;
  div.innerHTML = `<div class="cm-name">${role === 'user' ? 'Du' : 'Assistent'}</div><div class="cm-text">${esc(text).replace(/\n/g,'<br>')}</div>`;
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
}

// ═══════════════════════════════════════════════════════
// EXPORT
// ═══════════════════════════════════════════════════════
function dlFile(content, fname) {
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([content], {type:'text/plain;charset=utf-8'}));
  a.download = fname; a.click();
}
function exportAll() {
  const seen = new Set();
  const lines = [`1 ${S.cmd?.name||''} *CMDR*`];
  S.deck.forEach(c => { if (!seen.has(c.name)) { seen.add(c.name); lines.push(`1 ${c.name}`); } });
  dlFile(lines.join('\n'), ((S.cmd?.name||'deck').replace(/[^a-z0-9]/gi,'_')) + '_full.txt');
}
function exportSel() {
  const sel = window._selected || new Set();
  const lines = [`1 ${S.cmd?.name||''} *CMDR*`, ...[...sel].map(n=>`1 ${n}`)];
  dlFile(lines.join('\n'), ((S.cmd?.name||'deck').replace(/[^a-z0-9]/gi,'_')) + '_selection.txt');
}

// ═══════════════════════════════════════════════════════
// NAVIGATION
// ═══════════════════════════════════════════════════════
function go(n) {
  if (n === 2 && !S.cmd) return;
  if (n === 2) setupP2();
  if (n === 3) setupP3();
  document.querySelectorAll('.page').forEach((p,i) => p.classList.toggle('on', i+1===n));
  S.step = n;
  for (let i = 1; i <= 4; i++) {
    const d = document.getElementById('d'+i);
    d.classList.remove('active','done');
    if (i === n) d.classList.add('active');
    else if (i < n) d.classList.add('done');
    document.getElementById('dn'+i).textContent = i < n ? '✓' : i;
  }
  // Make done steps clickable
  document.querySelectorAll('.stp.done').forEach(el => {
    const stepNum = +el.id.replace('d','');
    el.style.cursor = 'pointer';
    el.onclick = () => go(stepNum);
  });
  window.scrollTo({top:0, behavior:'smooth'});
}

go(1);
</script>
</body>
</html>
