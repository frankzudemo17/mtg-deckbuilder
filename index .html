<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Commander">
<title>MTG Commander Deckbuilder</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Pro:ital,wght@0,300;0,400;0,500;1,300;1,400&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#05050a;--s1:#0a0a12;--s2:#10101a;--s3:#161622;--s4:#1c1c2a;
  --b1:#252535;--b2:#353550;--b3:#505070;
  --t1:#e8e4f0;--t2:#a8a4b8;--t3:#686480;--t4:#383858;
  --gold:#c8982a;--gold2:#e0b040;--gold3:#a07820;
  --gbg:rgba(200,152,42,.08);--gglow:rgba(200,152,42,.15);
  --red:#c84040;--blue:#4080c8;--green:#40a860;
  --W:#e8dfc0;--U:#6098d0;--B:#9878c8;--R:#c86840;--G:#58a870;--C:#9898b0;
  --safe-t:env(safe-area-inset-top,0px);--safe-b:env(safe-area-inset-bottom,0px);
  --r:12px;--r-sm:8px;--r-lg:16px;
}
*,::before,::after{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html{height:100%;scroll-behavior:smooth}
body{background:var(--bg);color:var(--t1);font-family:'Crimson Pro',Georgia,serif;font-size:16px;line-height:1.6;min-height:100%;-webkit-font-smoothing:antialiased}

/* atmospheric bg */
body::before{content:'';position:fixed;inset:0;z-index:0;pointer-events:none;
  background:
    radial-gradient(ellipse 80% 50% at 20% -10%,rgba(100,60,180,.12) 0%,transparent 60%),
    radial-gradient(ellipse 60% 40% at 80% 110%,rgba(200,152,42,.06) 0%,transparent 55%);
}
body::after{content:'';position:fixed;inset:0;z-index:0;pointer-events:none;opacity:.35;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cfilter id='n'%3E%3CfeTurbulence baseFrequency='.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='200' height='200' filter='url(%23n)' opacity='.04'/%3E%3C/svg%3E");
}
::-webkit-scrollbar{width:3px}::-webkit-scrollbar-thumb{background:var(--b2);border-radius:2px}

/* typography */
.cinzel{font-family:'Cinzel',serif}
.mono{font-family:'DM Mono',monospace}

/* ── HEADER ── */
header{
  position:sticky;top:0;z-index:400;
  background:rgba(5,5,10,.92);border-bottom:1px solid var(--b1);
  backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);
  padding:0 20px;padding-top:var(--safe-t);
  display:flex;align-items:center;justify-content:space-between;gap:12px;
  height:calc(52px + var(--safe-t));
}
.logo{display:flex;align-items:center;gap:10px;flex-shrink:0}
.logo-icon{
  width:28px;height:28px;flex-shrink:0;position:relative;
  display:flex;align-items:center;justify-content:center;
}
.logo-icon::before{
  content:'';position:absolute;inset:0;
  background:var(--gold);
  clip-path:polygon(50% 0%,93% 25%,93% 75%,50% 100%,7% 75%,7% 25%);
}
.logo-icon::after{content:'⚔';position:relative;z-index:1;font-size:11px;color:#000;line-height:1}
.logo-words{display:flex;flex-direction:column;line-height:1.1}
.logo-main{font-family:'Cinzel',serif;font-size:12px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--t1)}
.logo-sub{font-family:'DM Mono',monospace;font-size:8px;letter-spacing:.1em;color:var(--t3);text-transform:uppercase}

.steps{display:flex;align-items:center;gap:0;height:100%;overflow:hidden}
.stp{display:flex;align-items:center;height:100%;padding:0 8px;gap:5px;border-bottom:2px solid transparent;opacity:.18;transition:all .3s;cursor:default;flex-shrink:0}
.stp.active{opacity:1;border-bottom-color:var(--gold)}
.stp.done{opacity:.4}
.stp-n{width:16px;height:16px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:'DM Mono',monospace;font-size:8px;background:var(--s3);color:var(--t3);flex-shrink:0;transition:all .25s}
.stp.active .stp-n{background:var(--gold);color:#000;font-weight:700}
.stp.done .stp-n{background:var(--b2);color:var(--t1)}
.stp-l{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:.05em;color:var(--t3);white-space:nowrap}
.stp.active .stp-l{color:var(--t2)}
.stpsep{color:var(--b1);font-size:10px;flex-shrink:0}

/* ── MAIN ── */
main{position:relative;z-index:1;max-width:680px;margin:0 auto;padding:32px 16px calc(120px + var(--safe-b))}

.page{display:none;animation:pgIn .35s cubic-bezier(.16,1,.3,1) both}
.page.on{display:block}
@keyframes pgIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}

.ptitle{font-family:'Cinzel',serif;font-size:24px;font-weight:700;color:var(--t1);margin-bottom:4px;letter-spacing:.02em;line-height:1.2}
.psub{font-size:14px;color:var(--t3);margin-bottom:28px;font-style:italic;font-weight:300;font-family:'Crimson Pro',serif}

.sect{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:.15em;text-transform:uppercase;color:var(--t3);margin-bottom:10px;margin-top:24px;display:flex;align-items:center;gap:8px}
.sect::after{content:'';flex:1;height:1px;background:linear-gradient(to right,var(--b1),transparent);max-width:60px}

/* ── SEARCH ── */
.sw{position:relative;margin-bottom:6px}
.sr{display:flex;align-items:center;background:var(--s1);border:1px solid var(--b1);border-radius:var(--r);overflow:hidden;transition:border-color .2s,box-shadow .2s}
.sr:focus-within{border-color:rgba(200,152,42,.5);box-shadow:0 0 0 3px var(--gbg)}
.si{flex:1;padding:14px 14px;background:transparent;border:none;color:var(--t1);font-size:16px;font-family:'Crimson Pro',serif;outline:none;min-width:0}
.si::placeholder{color:var(--b2);font-style:italic}
.sico{padding:0 14px;color:var(--t3);font-size:16px;flex-shrink:0;user-select:none}
.scl{padding:0 14px;background:none;border:none;color:var(--t3);cursor:pointer;font-size:20px;line-height:1;min-width:46px;display:flex;align-items:center;justify-content:center;transition:color .15s;touch-action:manipulation}
.scl:hover{color:var(--t1)}
.sspin{padding:0 12px;display:flex;align-items:center}
.spn{display:inline-block;animation:rot .6s linear infinite;color:var(--gold);font-size:14px}
@keyframes rot{to{transform:rotate(360deg)}}
.dr{position:absolute;top:calc(100% + 6px);left:0;right:0;z-index:500;background:var(--s1);border:1px solid var(--b1);border-radius:var(--r);box-shadow:0 24px 60px rgba(0,0,0,.9),0 0 0 1px rgba(255,255,255,.03);max-height:360px;overflow-y:auto;-webkit-overflow-scrolling:touch}
.dri{display:flex;align-items:center;gap:10px;padding:10px 12px;border-bottom:1px solid var(--b1);transition:background .1s;cursor:pointer;touch-action:manipulation}
.dri:last-child{border-bottom:none}
.dri:active{background:var(--s2)}
.drimg{width:28px;height:40px;border-radius:4px;object-fit:cover;object-position:top;flex-shrink:0;background:var(--s2)}
.drname{font-size:14px;font-weight:500;color:var(--t1);line-height:1.2;font-family:'Cinzel',serif;font-size:12px}
.drtype{font-size:9px;color:var(--t3);margin-top:1px;font-family:'DM Mono',monospace;letter-spacing:.03em}
.drci{display:flex;gap:3px;margin-top:3px}
.ciw{width:7px;height:7px;border-radius:50%}
.drrank{font-size:8px;color:var(--t4);font-family:'DM Mono',monospace;margin-top:2px}
.drrank.gc-badge{color:var(--gold);font-weight:700}

/* ── COMMANDER CARD ── */
.cmdr{display:flex;background:var(--s1);border:1px solid var(--b1);border-radius:var(--r-lg);overflow:hidden;margin-bottom:20px;box-shadow:0 16px 50px rgba(0,0,0,.7);position:relative}
.cmdr-bar{width:4px;flex-shrink:0;background:var(--gold)}
.cmdr-img{width:100px;flex-shrink:0;object-fit:cover;object-position:20% 15%;display:block}
.cmdr-body{padding:14px 16px;flex:1;min-width:0;display:flex;flex-direction:column;gap:6px}
.cmdr-name{font-family:'Cinzel',serif;font-size:15px;font-weight:700;color:var(--t1);line-height:1.2;letter-spacing:.02em}
.cmdr-type{font-size:9px;color:var(--t3);font-family:'DM Mono',monospace;letter-spacing:.05em;text-transform:uppercase}
.cmdr-cost{display:inline-block;font-family:'DM Mono',monospace;font-size:10px;color:var(--gold);background:rgba(200,152,42,.08);border:1px solid rgba(200,152,42,.2);padding:2px 8px;border-radius:6px;letter-spacing:.06em}
.cmdr-cols{display:flex;gap:4px;flex-wrap:wrap}
.cmdr-col{padding:2px 8px;border-radius:100px;font-size:8px;font-weight:500;font-family:'DM Mono',monospace;background:rgba(255,255,255,.04);border:1px solid var(--b1)}
.cmdr-txt{font-size:12px;color:var(--b3);line-height:1.6;font-style:italic;font-weight:300;padding-left:8px;border-left:2px solid var(--b1);font-family:'Crimson Pro',serif}
.cmdr-pt{font-family:'Cinzel',serif;font-size:13px;font-weight:700;color:var(--gold)}
.cmdr-rank{font-size:8px;color:var(--b2);font-family:'DM Mono',monospace}
.cmdr-gc{display:inline-flex;align-items:center;gap:4px;font-size:9px;font-family:'DM Mono',monospace;color:var(--gold);background:rgba(200,152,42,.1);border:1px solid rgba(200,152,42,.25);padding:2px 7px;border-radius:4px}

/* ── BUTTONS ── */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:13px 24px;background:var(--gold);border:none;border-radius:var(--r-sm);color:#000;font-family:'Cinzel',serif;font-size:11px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;min-height:48px;box-shadow:0 4px 20px rgba(200,152,42,.25);transition:all .15s;touch-action:manipulation;-webkit-appearance:none}
.btn:hover{background:var(--gold2);box-shadow:0 6px 28px rgba(200,152,42,.35)}
.btn:active{transform:scale(.97)}
.btn:disabled{background:var(--b1);color:var(--t3);box-shadow:none;cursor:not-allowed;transform:none}
.btng{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:12px 18px;background:transparent;border:1px solid var(--b1);border-radius:var(--r-sm);color:var(--t3);font-family:'Crimson Pro',serif;font-size:14px;cursor:pointer;min-height:48px;transition:all .15s;touch-action:manipulation;-webkit-appearance:none}
.btng:hover{border-color:var(--b2);color:var(--t1)}
.btng:active{transform:scale(.97)}
.nav{display:flex;justify-content:space-between;align-items:center;margin-top:28px;gap:10px}

/* ── BRACKET GRID ── */
.bgrid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:24px}
.bc{background:var(--s1);border:1px solid var(--b1);border-radius:var(--r);padding:14px;cursor:pointer;touch-action:manipulation;transition:border-color .2s,background .2s,transform .12s;position:relative;overflow:hidden}
.bc::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:var(--cc,transparent);opacity:.8}
.bc::after{content:attr(data-num);position:absolute;bottom:-4px;right:8px;font-family:'Cinzel',serif;font-size:44px;font-weight:700;color:var(--cc,var(--b1));opacity:.06;pointer-events:none;line-height:1}
.bc:hover{border-color:var(--b2);transform:translateY(-1px)}
.bc.sel{background:var(--s2);border-color:var(--cc,var(--b2))}
.bc-head{display:flex;align-items:center;gap:6px;margin-bottom:4px}
.bc-dot{width:6px;height:6px;border-radius:50%;background:var(--cc,var(--t3));flex-shrink:0}
.bc-name{font-family:'Cinzel',serif;font-size:11px;font-weight:700;color:var(--cc,var(--t1));letter-spacing:.05em}
.bc-desc{font-size:11px;color:var(--t3);margin-bottom:7px;font-style:italic;line-height:1.4;font-family:'Crimson Pro',serif}
.bc-rules{display:flex;flex-direction:column;gap:2px}
.bc-rule{font-size:8px;color:var(--t4);font-family:'DM Mono',monospace;padding-left:8px;position:relative}
.bc-rule::before{content:'—';position:absolute;left:0;color:var(--t4)}

/* ── OPTS ── */
.og{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:24px}
.oc{padding:8px 13px;border-radius:100px;background:var(--s1);border:1px solid var(--b1);cursor:pointer;touch-action:manipulation;transition:all .15s;min-height:42px;display:flex;flex-direction:column;align-items:flex-start;justify-content:center}
.oc:active{transform:scale(.97)}
.oc.sel{background:var(--gbg);border-color:rgba(200,152,42,.4)}
.oc-n{font-size:12px;font-weight:500;color:var(--t2);font-family:'Crimson Pro',serif}
.oc.sel .oc-n{color:var(--gold)}
.oc-s{font-size:8px;color:var(--t4);font-family:'DM Mono',monospace}
.oc.sel .oc-s{color:rgba(200,152,42,.5)}

/* ── PRICE TIERS ── */
.pgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:24px}
.pc{background:var(--s1);border:1px solid var(--b1);border-radius:var(--r-sm);padding:10px 11px;cursor:pointer;touch-action:manipulation;display:flex;align-items:center;gap:7px;transition:all .2s;min-height:44px}
.pc:active{transform:scale(.97)}
.pc.sel{background:var(--s2)}
.pc-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.pc-l{font-size:10px;font-weight:500;font-family:'DM Mono',monospace;color:var(--t3);line-height:1.2}
.pc.sel .pc-l{color:var(--t1)}

/* ── ARCH ── */
.agrid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:20px}
.ac{background:var(--s1);border:1px solid var(--b1);border-radius:var(--r-sm);padding:12px 8px;cursor:pointer;touch-action:manipulation;transition:all .2s;text-align:center;position:relative;overflow:hidden}
.ac:active{transform:scale(.97)}
.ac.sel{background:var(--gbg);border-color:rgba(200,152,42,.4)}
.ac.sel2{background:rgba(160,120,200,.07);border-color:rgba(160,120,200,.35)}
.ac-g{font-family:'Cinzel',serif;font-size:14px;font-weight:700;color:var(--b2);margin-bottom:4px;transition:color .2s}
.ac.sel .ac-g{color:var(--gold)}
.ac.sel2 .ac-g{color:#a078c8}
.ac-n{font-size:8px;font-weight:600;color:var(--t3);font-family:'DM Mono',monospace;margin-bottom:1px;text-transform:uppercase;letter-spacing:.04em;transition:color .2s}
.ac.sel .ac-n,.ac.sel2 .ac-n{color:var(--t2)}
.ac-d{font-size:7px;color:var(--t4);line-height:1.3;font-family:'Crimson Pro',serif}
.arch-hint{font-size:11px;color:var(--t3);font-style:italic;font-family:'Crimson Pro',serif;margin-bottom:8px}
.arch-sel-info{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px;min-height:22px}
.arch-tag{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:100px;font-size:9px;font-family:'DM Mono',monospace;background:var(--gbg);border:1px solid rgba(200,152,42,.3);color:var(--gold)}
.arch-tag.t2{background:rgba(160,120,200,.07);border-color:rgba(160,120,200,.35);color:#a078c8}

/* ── SUMMARY BOX ── */
.sbox{background:var(--s1);border:1px solid var(--b1);border-radius:var(--r);padding:14px 16px;margin-top:16px}
.srow{display:flex;gap:8px;margin-bottom:5px;align-items:baseline}
.sk{font-family:'DM Mono',monospace;font-size:8px;color:var(--t3);min-width:80px;letter-spacing:.06em;text-transform:uppercase;flex-shrink:0}
.sv{color:var(--t1);font-size:13px;font-family:'Crimson Pro',serif}

/* ── COLLECTION ── */
.collbox{margin-top:20px;background:var(--s1);border:1px solid var(--b1);border-radius:var(--r);padding:14px}
.dz{border:1px dashed var(--b2);border-radius:var(--r-sm);padding:14px;text-align:center;cursor:pointer;touch-action:manipulation;font-size:11px;color:var(--t3);font-family:'DM Mono',monospace;transition:all .2s;min-height:50px;display:flex;align-items:center;justify-content:center;letter-spacing:.04em}
.dz:active,.dz.drag{border-color:var(--gold);color:var(--gold)}
.dz.loaded{border-color:rgba(200,152,42,.3);color:var(--gold2);background:rgba(200,152,42,.03);border-style:solid}

/* ── LOADING ── */
.lw{max-width:340px;margin:70px auto;text-align:center;padding:0 16px}
.lsp{width:40px;height:40px;margin:0 auto 18px;border:2px solid var(--b1);border-top-color:var(--gold);border-radius:50%;animation:rot .75s linear infinite}
.lt{font-family:'Cinzel',serif;font-size:18px;font-weight:700;color:var(--t1);margin-bottom:4px}
.lm{font-size:12px;color:var(--t3);margin-bottom:18px;font-style:italic;font-family:'Crimson Pro',serif}
.ll{text-align:left;max-width:260px;margin:0 auto}
.li{font-size:9px;font-family:'DM Mono',monospace;color:var(--t4);margin-bottom:3px;opacity:0;animation:fadeIn .35s forwards}
@keyframes fadeIn{to{opacity:1;color:var(--t3)}}
.lbar{width:100%;height:2px;background:var(--b1);border-radius:1px;overflow:hidden;margin-bottom:16px}
.lbar-fill{height:100%;background:linear-gradient(to right,var(--gold3),var(--gold));border-radius:1px;transition:width .4s ease;width:0}

/* ── ERROR ── */
.ebox{max-width:380px;margin:70px auto;text-align:center;background:var(--s1);border:1px solid #3a1a1a;border-radius:var(--r-lg);padding:24px 20px}
.etit{font-family:'Cinzel',serif;font-size:16px;color:#d06060;margin-bottom:7px}
.emsg{font-size:11px;color:#906060;line-height:1.65;margin-bottom:14px;word-break:break-word;font-family:'DM Mono',monospace}
.einl{font-size:11px;color:#e06060;margin-top:6px;padding:7px 10px;background:rgba(180,50,50,.08);border:1px solid rgba(180,50,50,.18);border-radius:6px;font-family:'DM Mono',monospace}

/* ── RESULTS ── */
.rh{margin-bottom:14px}
.rt{font-family:'Cinzel',serif;font-size:20px;font-weight:700;color:var(--t1);letter-spacing:.02em;margin-bottom:6px;line-height:1.2}
.rc{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:10px}
.chip{padding:3px 9px;border-radius:100px;background:var(--s1);border:1px solid var(--b1);font-size:9px;font-family:'DM Mono',monospace}
.ra{display:flex;gap:7px;flex-wrap:wrap}
.ir{display:grid;grid-template-columns:repeat(3,1fr);gap:7px;margin-bottom:14px}
.ic{background:var(--s1);border:1px solid var(--b1);border-radius:var(--r-sm);padding:11px 13px}
.icl{font-family:'DM Mono',monospace;font-size:8px;font-weight:500;letter-spacing:.1em;text-transform:uppercase;color:var(--gold);margin-bottom:4px}
.ict{font-size:11px;color:var(--t3);line-height:1.5;font-style:italic;font-family:'Crimson Pro',serif}

/* ── TABS ── */
.tbar{display:flex;overflow-x:auto;-webkit-overflow-scrolling:touch;border-bottom:1px solid var(--b1);margin-bottom:14px;scrollbar-width:none;gap:0}
.tbar::-webkit-scrollbar{display:none}
.tb{flex-shrink:0;padding:0 13px;height:38px;background:transparent;border:none;border-bottom:2px solid transparent;color:var(--t3);cursor:pointer;touch-action:manipulation;font-size:11px;font-family:'DM Mono',monospace;letter-spacing:.05em;display:flex;align-items:center;gap:5px;white-space:nowrap;transition:all .15s}
.tb:hover{color:var(--t2)}
.tb.active{color:var(--t1);border-bottom-color:var(--gold)}
.tct{padding:1px 5px;border-radius:100px;background:var(--s2);font-size:8px;color:var(--t3)}
.tb.active .tct{background:var(--gbg);color:var(--gold)}

/* ── CARD GRID ── */
.cath{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:11px;flex-wrap:wrap;gap:8px}
.catname{font-family:'Cinzel',serif;font-size:15px;font-weight:700;color:var(--t1);letter-spacing:.02em}
.catdesc{font-size:11px;color:var(--t3);margin-top:1px;font-style:italic;font-family:'Crimson Pro',serif}
.aab{padding:7px 13px;background:transparent;border:1px solid var(--b1);border-radius:6px;color:var(--t3);cursor:pointer;touch-action:manipulation;font-size:9px;font-family:'DM Mono',monospace;transition:all .15s;white-space:nowrap;min-height:34px;letter-spacing:.05em}
.aab:active{border-color:var(--gold);color:var(--gold)}

.cgrid{display:grid;grid-template-columns:repeat(2,1fr);gap:7px;margin-bottom:90px}
.ccard{background:var(--s1);border:1px solid var(--b1);border-radius:var(--r-sm);overflow:hidden;transition:border-color .15s}
.ccard.ind{border-color:rgba(88,168,112,.4);background:#060e08}
.ccard.now{opacity:.25}
.ccard.isgc{border-color:rgba(200,152,42,.3)}
.caw{height:72px;overflow:hidden;background:var(--s2);position:relative}
.cai{width:100%;height:100%;object-fit:cover;object-position:15% 18%;display:block}
.cao{position:absolute;inset:0;background:linear-gradient(to top,rgba(5,5,10,.8) 0%,transparent 60%)}
.cbody{padding:8px 10px}
.cname{font-size:11px;font-weight:600;color:var(--t1);line-height:1.3;margin-bottom:2px;font-family:'Cinzel',serif;letter-spacing:.01em}
.ctype{font-size:8px;color:var(--t4);font-family:'DM Mono',monospace;margin-bottom:3px}
.ctxt{font-size:9px;color:#484868;line-height:1.4;margin-bottom:5px;font-style:italic;font-family:'Crimson Pro',serif}
.cgcbadge{display:inline-flex;align-items:center;gap:3px;font-size:7px;font-family:'DM Mono',monospace;color:var(--gold);background:rgba(200,152,42,.08);border:1px solid rgba(200,152,42,.2);padding:1px 5px;border-radius:3px;margin-bottom:4px}
.cft{display:flex;align-items:center;gap:3px;flex-wrap:wrap}
.pds{display:flex;gap:2px;flex-shrink:0}
.pd{width:4px;height:4px;border-radius:50%}
.pd.on{background:var(--gold)}
.pd.off{background:var(--b1)}
.ptag{font-size:7px;padding:2px 4px;border-radius:3px;font-family:'DM Mono',monospace;font-weight:500}
.ptag.low{background:#081508;color:#58a870}
.ptag.mid{background:#151000;color:#c89030}
.ptag.high{background:#150808;color:#c06060}
.obadge{font-size:7px;padding:2px 4px;border-radius:3px;font-family:'DM Mono',monospace}
.oy{background:#081508;color:#58a870}
.on2{background:#150808;color:#c06060}
.prc{font-size:8px;color:#58a870;font-family:'DM Mono',monospace;margin-left:auto;white-space:nowrap}
.addb{padding:4px 8px;border-radius:4px;cursor:pointer;touch-action:manipulation;font-size:9px;border:1px solid var(--b1);background:var(--s2);color:var(--t3);transition:all .15s;font-family:'DM Mono',monospace;white-space:nowrap;min-height:28px;font-weight:500;-webkit-appearance:none}
.addb:active{transform:scale(.95)}
.ccard.ind .addb{border-color:rgba(88,168,112,.3);color:#58a870;background:transparent}

/* ── DECK PANEL ── */
.dp{
  position:fixed;right:0;left:0;bottom:0;z-index:500;
  background:rgba(8,8,14,.97);border-top:1px solid var(--b2);
  backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);
  padding:10px 16px calc(10px + var(--safe-b));
  box-shadow:0 -12px 40px rgba(0,0,0,.8);
  display:flex;flex-direction:column;max-height:38vh;
  transition:max-height .3s ease;
}
.dp.expanded{max-height:65vh}
.dp-top{display:flex;align-items:center;gap:10px;margin-bottom:7px;flex-shrink:0}
.dpt{font-family:'Cinzel',serif;font-size:11px;font-weight:700;color:var(--gold);letter-spacing:.08em;text-transform:uppercase;flex:1}
.dp-toggle{background:none;border:none;color:var(--t3);cursor:pointer;touch-action:manipulation;font-size:11px;font-family:'DM Mono',monospace;padding:4px 8px;border-radius:4px;border:1px solid var(--b1);transition:all .15s}
.dp-toggle:active{color:var(--t1)}
.dpc{font-size:10px;color:var(--t3);margin-bottom:7px;font-style:italic;font-family:'Crimson Pro',serif;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex-shrink:0}
.dpl{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;margin-bottom:7px;display:grid;grid-template-columns:1fr 1fr;gap:2px}
.dpli{display:flex;align-items:center;gap:3px;font-size:9px;color:var(--t3);font-family:'DM Mono',monospace;padding:2px 0}
.dpli span{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.dprm{background:none;border:none;color:#703030;cursor:pointer;touch-action:manipulation;padding:0;font-size:12px;line-height:1;min-width:18px;flex-shrink:0}
.dprm:active{color:#e07070}
.dp-cnt-bar{display:flex;align-items:center;gap:8px;margin-bottom:8px;flex-shrink:0}
.dp-cnt{font-family:'DM Mono',monospace;font-size:10px;color:var(--t3)}
.dp-cnt strong{color:var(--t1)}
.dp-prog{flex:1;height:3px;background:var(--b1);border-radius:2px;overflow:hidden}
.dp-prog-fill{height:100%;background:linear-gradient(to right,var(--gold3),var(--gold));border-radius:2px;transition:width .3s}
.dpbtns{display:flex;gap:6px;flex-shrink:0}
.dpb{flex:1;padding:9px 0;border-radius:6px;cursor:pointer;touch-action:manipulation;font-weight:600;font-size:9px;font-family:'DM Mono',monospace;text-align:center;transition:opacity .15s;min-height:34px;display:flex;align-items:center;justify-content:center;border:1px solid;letter-spacing:.05em;-webkit-appearance:none}
.dpb.a{background:rgba(59,130,246,.06);border-color:rgba(59,130,246,.22);color:#60a5fa}
.dpb.s{background:rgba(88,168,112,.06);border-color:rgba(88,168,112,.22);color:#58a870}
.dpb:active{opacity:.65}

textarea{width:100%;padding:11px 13px;background:var(--s1);border:1px solid var(--b1);border-radius:var(--r-sm);color:var(--t1);font-size:15px;outline:none;font-family:'Crimson Pro',serif;line-height:1.65;resize:vertical;-webkit-appearance:none;transition:border-color .2s;min-height:70px}
textarea:focus{border-color:rgba(200,152,42,.4);box-shadow:0 0 0 3px var(--gbg)}
textarea::placeholder{color:var(--b2);font-style:italic}

@media(min-width:500px){
  .cgrid{grid-template-columns:repeat(3,1fr)}
  .dp{left:auto;right:14px;bottom:14px;width:260px;border-radius:var(--r-lg);border:1px solid var(--b2);border-top:1px solid var(--b2);max-height:460px;padding:12px}
  .dp.expanded{max-height:460px}
  .dpl{grid-template-columns:1fr}
  main{padding:36px 20px calc(100px + var(--safe-b))}
}
@media(max-width:380px){
  .bgrid{grid-template-columns:1fr}
  .agrid{grid-template-columns:repeat(3,1fr)}
  .pgrid{grid-template-columns:1fr 1fr}
  .ir{grid-template-columns:1fr 1fr}
  .ptitle{font-size:20px}
  .stp-l{display:none}
}
</style>
</head>
<body>
<header>
  <div class="logo">
    <div class="logo-icon"></div>
    <div class="logo-words">
      <div class="logo-main">Commander</div>
      <div class="logo-sub">Deckbuilder</div>
    </div>
  </div>
  <div class="steps">
    <div class="stp active" id="d1"><div class="stp-n" id="dn1">1</div><span class="stp-l">Commander</span></div>
    <div class="stpsep">›</div>
    <div class="stp" id="d2"><div class="stp-n" id="dn2">2</div><span class="stp-l">Powerlevel</span></div>
    <div class="stpsep">›</div>
    <div class="stp" id="d3"><div class="stp-n" id="dn3">3</div><span class="stp-l">Archetyp</span></div>
    <div class="stpsep">›</div>
    <div class="stp" id="d4"><div class="stp-n" id="dn4">4</div><span class="stp-l">Deck</span></div>
  </div>
</header>

<main>

<!-- ══ PAGE 1 ══ -->
<div class="page on" id="p1">
  <h1 class="ptitle">Wähle deinen Commander</h1>
  <p class="psub">Echtzeit-Suche in Scryfall — 26.000+ Karten, Cardmarket-Preise & EDHREC-Daten</p>
  <div class="sw" id="sw">
    <div class="sr">
      <span class="sico">⌕</span>
      <input class="si" id="si" type="search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Atraxa, Edgar Markov, Krenko…">
      <div class="sspin" id="spin" style="display:none"><span class="spn">◎</span></div>
      <button class="scl" id="scl" style="display:none" aria-label="Löschen">✕</button>
    </div>
    <div class="dr" id="dr" style="display:none"></div>
  </div>
  <div id="serr" style="display:none"></div>
  <div id="sres" style="display:none;margin-top:14px"></div>
  <div class="collbox">
    <div class="sect" style="margin-top:0">Sammlung <span style="font-size:9px;color:var(--t4);text-transform:none;letter-spacing:0;font-weight:300;font-family:'Crimson Pro',serif;font-style:italic">— optional</span></div>
    <div style="font-size:11px;color:var(--t3);margin-bottom:8px;font-style:italic;font-family:'Crimson Pro',serif">Moxfield CSV · Archidekt CSV · MTGO · Plain Text</div>
    <div class="dz" id="dz" ondragover="event.preventDefault();this.classList.add('drag')" ondragleave="this.classList.remove('drag')" ondrop="hdrop(event)">↑ Datei ablegen oder tippen</div>
    <input type="file" id="cf" accept=".csv,.txt" style="display:none">
    <div id="ci2" style="display:none;margin-top:8px;font-size:11px;font-family:'DM Mono',monospace;color:var(--gold);align-items:center;gap:10px">
      <span id="ct"></span>
      <button id="clrCollBtn" style="background:none;border:none;color:var(--t3);cursor:pointer;font-size:11px;text-decoration:underline;font-family:'Crimson Pro',serif;touch-action:manipulation">Entfernen</button>
    </div>
  </div>
</div>

<!-- ══ PAGE 2 ══ -->
<div class="page" id="p2">
  <h1 class="ptitle">Powerlevel & Budget</h1>
  <p class="psub">Das Bracket bestimmt Kartenwahl und Spielerfahrung am Tisch</p>
  <div class="sect" style="margin-top:0">Power-Bracket</div>
  <div class="bgrid" id="bgrid"></div>
  <div class="sect">Optionale Zusätze</div>
  <div class="og" id="og"></div>
  <div class="sect">Budget</div>
  <div class="pgrid" id="pgrid"></div>
  <div class="nav">
    <button class="btng" id="p2back">← Zurück</button>
    <button class="btn" id="s2n" disabled>Weiter →</button>
  </div>
</div>

<!-- ══ PAGE 3 ══ -->
<div class="page" id="p3">
  <h1 class="ptitle">Spielstil & Archetyp</h1>
  <p class="psub">Wähle bis zu 2 Archetypen — beeinflusst die Synergie-Suche</p>
  <div class="sect" style="margin-top:0">Deck-Archetyp <span style="color:var(--t4);font-size:9px;text-transform:none;letter-spacing:0;font-style:italic;font-family:'Crimson Pro',serif">— bis zu 2</span></div>
  <div class="arch-hint">Tippe einen oder zwei Archetypen an:</div>
  <div class="arch-sel-info" id="archSel"></div>
  <div class="agrid" id="agrid"></div>
  <div class="sect">Strategie-Notiz</div>
  <textarea id="strat" rows="2" placeholder="z.B. Elfenstamm mit Haste-Combo, kein Stax…"></textarea>
  <div class="sbox" id="sumbox"></div>
  <div class="nav">
    <button class="btng" id="p3back">← Zurück</button>
    <button class="btn" id="p3gen">Deck generieren →</button>
  </div>
</div>

<!-- ══ PAGE 4 ══ -->
<div class="page" id="p4">
  <div id="p4l" style="display:none">
    <div class="lw">
      <div class="lsp"></div>
      <div class="lt">Deck wird gebaut</div>
      <div class="lm" id="lmsg">Verbinde mit Scryfall…</div>
      <div class="lbar"><div class="lbar-fill" id="lbarfill"></div></div>
      <div class="ll" id="llog"></div>
    </div>
  </div>
  <div id="p4e" style="display:none">
    <div class="ebox">
      <div class="etit">Verbindungsfehler</div>
      <div class="emsg" id="etxt"></div>
      <div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap">
        <button class="btng" id="p4eback">← Zurück</button>
        <button class="btn" id="p4eretry">Erneut versuchen</button>
      </div>
    </div>
  </div>
  <div id="p4r" style="display:none">
    <div class="rh">
      <div class="rt" id="rtit"></div>
      <div class="rc" id="rchips"></div>
      <div class="ra">
        <button class="btng" style="font-size:12px;padding:9px 14px;min-height:42px" id="p4radj">Anpassen</button>
        <button class="btng" style="font-size:12px;padding:9px 14px;min-height:42px;border-color:rgba(88,168,112,.25);color:#58a870" id="p4rexp">Export .txt</button>
      </div>
    </div>
    <div class="ir" id="rinfo"></div>
    <div class="tbar" id="rtabs"></div>
    <div id="rcont"></div>
  </div>
  <div class="dp" id="dp" style="display:none">
    <div class="dp-top">
      <div class="dpt">Decklist</div>
      <button class="dp-toggle" id="dpToggle">▲ Anzeigen</button>
    </div>
    <div class="dp-cnt-bar">
      <div class="dp-cnt"><strong id="dpcnt">0</strong>/100 Karten</div>
      <div class="dp-prog"><div class="dp-prog-fill" id="dpprogfill"></div></div>
    </div>
    <div class="dpc" id="dpcmdr"></div>
    <div class="dpl" id="dplist" style="display:none"></div>
    <div class="dpbtns">
      <button class="dpb a" id="dpexpA">Alles exportieren</button>
      <button class="dpb s" id="dpexpS">Auswahl exportieren</button>
    </div>
  </div>
</div>

</main>
<script>
const SF='https://api.scryfall.com';
const CM_BASE='https://www.cardmarket.com/de/Magic/Products/Singles';

// ── STATIC DATA ──
const BR=[
  {id:1,label:'Casual',    c:'#58a870',desc:'Pre-Con Niveau. Entspannt, einsteigerfreundlich.',  rules:['Keine Kombos','Keine Tutoren','Kein Fast-Mana','Kein MLD','Kein Extra Turn']},
  {id:2,label:'Focused',   c:'#60a5fa',desc:'Upgrages Pre-Con. Klare Strategie, kein Powerspike.',rules:['Keine Kombos','Max 2-3 Tutoren','Kein Turn 5 Win']},
  {id:3,label:'Optimized', c:'#c8982a',desc:'Starke Synergien, kompetitiv-freundlich.',           rules:['Interaction erwartet','Starke Synergien OK','GC-Karten nach Absprache']},
  {id:4,label:'cEDH',      c:'#d06060',desc:'Competitive: maximale Effizienz, Turn 3-4 Win.',     rules:['Alles Legale erlaubt','Fast-Mana OK','GC-Karten erlaubt']},
  {id:5,label:'cEDH+',     c:'#b84080',desc:'Wie cEDH, keine Einschränkungen.',                   rules:['Alles erlaubt','Proxies OK','Turnier-Level']},
];
const OPT=[
  {id:'gc',  n:'Gamechanger-Karten',  s:'Nur offizielle GC-Liste'},
  {id:'combo',n:'Infinite Combos',    s:'Unendliche Kombos erlaubt'},
  {id:'tutor',n:'Unbegrenzte Tutoren',s:'Keine Tutoren-Einschränkung'},
  {id:'stax', n:'Stax Pieces',        s:'Symmetrische Locks'},
  {id:'extra',n:'Extra Turns',        s:'Extrazüge erlaubt'},
  {id:'mld',  n:'Mass Land Destroy',  s:'MLD erlaubt'},
];
const PT=[
  {id:'xs',l:'Unter 10€', max:10, c:'#58a870'},
  {id:'s', l:'10–30€',    max:30, c:'#34d399'},
  {id:'m', l:'30–100€',   max:100,c:'#60a5fa'},
  {id:'l', l:'100–300€',  max:300,c:'#a78bfa'},
  {id:'xl',l:'300–800€',  max:800,c:'#c8982a'},
  {id:'op',l:'Kein Limit',max:9999,c:'#d06060'},
];
const AR=[
  {id:'blink',      n:'Blink/ETB',    g:'↻',d:'ETB wiederholen'},
  {id:'landfall',   n:'Landfall',     g:'⛰',d:'Länder nutzen'},
  {id:'counters',   n:'+1/+1',        g:'+',d:'Counter stapeln'},
  {id:'infect',     n:'Infect',       g:'☠',d:'10 Gift-Marker'},
  {id:'tokens',     n:'Tokens',       g:'⚔',d:'Massen-Tokens'},
  {id:'reanimator', n:'Reanimator',   g:'†',d:'Friedhof nutzen'},
  {id:'combo',      n:'Combo',        g:'∞',d:'Infinite Kombos'},
  {id:'voltron',    n:'Voltron',      g:'⬡',d:'Commander pumpen'},
  {id:'aristocrats',n:'Aristocrats',  g:'♦',d:'Kreaturen opfern'},
  {id:'spellslinger',n:'Spellslinger',g:'✦',d:'Viele Zauber'},
  {id:'stax',       n:'Stax',         g:'⛓',d:'Gegner bremsen'},
  {id:'theft',      n:'Theft',        g:'◈',d:'Stehlen & Kontroll.'},
  {id:'tribal',     n:'Tribal',       g:'★',d:'Ein Typ fokus'},
  {id:'enchantress',n:'Enchantress',  g:'◎',d:'Verzauberungen'},
  {id:'graveyard',  n:'Graveyard',    g:'⚰',d:'Friedhof Ressource'},
  {id:'artifacts',  n:'Artifacts',    g:'⚙',d:'Artefakt-Ketten'},
];
const CN={W:'Weiß',U:'Blau',B:'Schwarz',R:'Rot',G:'Grün',C:'Farblos'};
const CH={W:'#e8dfc0',U:'#6098d0',B:'#9878c8',R:'#c86840',G:'#58a870',C:'#9898b0'};
const BL={W:'Plains',U:'Island',B:'Swamp',R:'Mountain',G:'Forest'};

// Official Gamechanger cards (MTG Rules Committee official list as of 2024)
const GC_CARDS=new Set([
  'Black Lotus','Ancestral Recall','Time Walk','Mox Pearl','Mox Sapphire','Mox Jet','Mox Ruby','Mox Emerald',
  'Mana Crypt','Mana Vault','Grim Monolith','Chrome Mox','Mox Diamond','Mox Opal',
  'Jeweled Lotus','Jeweled Amulet',
  'Demonic Tutor','Vampiric Tutor','Imperial Seal','Mystical Tutor','Enlightened Tutor','Worldly Tutor','Sylvan Tutor','Lim-Dul\'s Vault',
  'Timetwister','Time Spiral','Wheel of Fortune',
  'Necropotence','Ad Nauseam','Peer into the Abyss',
  'Cyclonic Rift','Expropriate','Armageddon','Ravages of War','Catastrophe',
  'Thassa\'s Oracle','Jace, Wielder of Mysteries','Laboratory Maniac',
  'Doomsday','Thoracle','Consultation','Demonic Consultation','Tainted Pact',
  'Flash','Protean Hulk','Pattern of Rebirth',
  'Seedborn Muse','Rhystic Study','Smothering Tithe','Teferi\'s Protection',
  'Omniscience','Enter the Infinite','Tooth and Nail',
  'Craterhoof Behemoth','Triumph of the Hordes',
  'Doubling Season','Parallel Lives',
  'Food Chain','Survival of the Fittest',
  'Yawgmoth\'s Will','Underworld Breach','Past in Flames','Magus of the Will',
  'Sensei\'s Divining Top','Scroll Rack',
  'Intuition','Gifts Ungiven','Buried Alive',
  'Fierce Guardianship','Deflecting Swipe','Deadly Rollick','Flawless Maneuver','Obscuring Haze',
  'Bolas\'s Citadel','Aetherflux Reservoir',
  'Isochron Scepter','Dramatic Reversal',
  'Hermit Druid','Mesmeric Orb',
  'Cloudstone Curio','Temur Sabertooth',
  'Moraug, Fury of Akoum',
  'Hullbreacher','Opposition Agent',
  'Narset, Parter of Veils','Leovold, Emissary of Trest',
  'Winter Orb','Static Orb','Stasis',
  'Torpor Orb','Grafdigger\'s Cage',
  'Grand Abolisher','City of Solitude',
]);

// Known infinite combo pieces (simplified, major ones)
const COMBO_PIECES=new Set([
  'Isochron Scepter','Dramatic Reversal','Basalt Monolith','Rings of Brighthearth',
  'Grim Monolith','Power Artifact','Palinchron','Deadeye Navigator','Phantasmal Image',
  'Reveillark','Karmic Guide','Saffi Eriksdotter',
  'Nim Deathmantle','Ashnod\'s Altar','Phyrexian Altar',
  'Mikaeus, the Unhallowed','Triskelion','Walking Ballista',
  'Devoted Druid','Vizier of Remedies','Flourishing Defenses',
  'Kiki-Jiki, Mirror Breaker','Splinter Twin','Deceiver Exarch','Pestermite',
  'Exquisite Blood','Sanguine Bond','Vito, Thorn of the Dusk Rose',
  'Heliod, Sun-Crowned','Walking Ballista',
  'Melira, Sylvok Outcast','Woodfall Primus',
  'Food Chain','Squee, the Immortal','Misthollow Griffin',
  'Thassa\'s Oracle','Demonic Consultation','Tainted Pact',
  'Doomsday','Laboratory Maniac','Jace, Wielder of Mysteries',
  'Tooth and Nail','Emrakul, the Aeons Torn',
  'Cloudstone Curio','Temur Sabertooth',
  'Auriok Salvagers','Lion\'s Eye Diamond',
  'Grapeshot','Tendrils of Agony',
]);

const S={step:1,cmd:null,bracket:null,opts:[],pt:null,archs:[],coll:null,collMode:false,cats:[],dl:[]};
let tmr=null,lastQ='';

// ── UTILS ──
const e=s=>String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
const gi=(c,z)=>c.image_uris?.[z]||c.card_faces?.[0]?.image_uris?.[z]||null;
const slp=ms=>new Promise(r=>setTimeout(r,ms));
function onTap(el,fn){
  if(!el)return;
  let moved=false;
  el.addEventListener('touchstart',()=>{moved=false;},{passive:true});
  el.addEventListener('touchmove',()=>{moved=true;},{passive:true});
  el.addEventListener('touchend',ev=>{if(moved)return;ev.preventDefault();fn();},{passive:false});
  el.addEventListener('click',fn);
}

// ── SCRYFALL ──
async function sfGet(path){
  const r=await fetch(SF+path,{mode:'cors'});
  if(!r.ok)throw new Error('Scryfall HTTP '+r.status);
  return r.json();
}
async function sfSearch(q){
  const d=await sfGet('/cards/search?q='+encodeURIComponent(q)+'&order=edhrec&unique=cards');
  return d.data||[];
}
async function sfSafe(q,n){
  try{const res=await sfSearch(q);return res.slice(0,n);}
  catch{return[];}
}

// Cardmarket price estimate (EUR) - we use Scryfall EUR prices as proxy
function cmPrice(card){
  const eur=parseFloat(card.prices?.eur||card.prices?.eur_foil||'0');
  return eur||null;
}
function fmtEur(p){if(!p)return null;return p<0.1?'< 0,10 €':p.toFixed(2).replace('.',',')+' €';}
function priceTier(p){if(!p||p<1)return'low';if(p<8)return'mid';return'high';}

// ── INIT ──
window.addEventListener('load',function(){
  const inp=document.getElementById('si');
  inp.addEventListener('input',function(){
    const v=this.value.trim();
    document.getElementById('scl').style.display=v?'flex':'none';
    clearTimeout(tmr);
    if(v.length<2){hideDr();return;}
    if(v===lastQ)return;
    lastQ=v;showSpinner(true);
    tmr=setTimeout(()=>doSearch(v),420);
  });
  inp.addEventListener('keydown',ev=>{if(ev.key==='Escape')hideDr();});
  document.addEventListener('touchstart',ev=>{if(!document.getElementById('sw').contains(ev.target))hideDr();},{passive:true});
  document.addEventListener('click',ev=>{if(!document.getElementById('sw').contains(ev.target))hideDr();});

  onTap(document.getElementById('scl'),clearSearch);
  onTap(document.getElementById('dz'),()=>document.getElementById('cf').click());
  document.getElementById('cf').addEventListener('change',function(){loadFile(this.files[0]);});
  onTap(document.getElementById('clrCollBtn'),clearColl);

  // p2
  onTap(document.getElementById('p2back'),()=>go(1));
  onTap(document.getElementById('s2n'),()=>go(3));

  // p3
  onTap(document.getElementById('p3back'),()=>go(2));
  onTap(document.getElementById('p3gen'),gen);

  // p4
  onTap(document.getElementById('p4eback'),()=>go(3));
  onTap(document.getElementById('p4eretry'),gen);
  onTap(document.getElementById('p4radj'),()=>{go(3);document.getElementById('p4r').style.display='none';});
  onTap(document.getElementById('p4rexp'),exportAll);
  onTap(document.getElementById('dpexpA'),exportAll);
  onTap(document.getElementById('dpexpS'),exportSel);
  onTap(document.getElementById('dpToggle'),toggleDeckPanel);
});

// ── SEARCH ──
async function doSearch(q){
  try{
    let cards=[];
    try{cards=await sfSearch('is:commander name:'+q+' game:paper');}
    catch{try{cards=await sfSearch('is:commander name:"'+q+'" game:paper');}catch{cards=[];}}
    showDr(cards.slice(0,12));
  }catch(err){showInlineErr(err.message);}
  showSpinner(false);
}
function showDr(cards){
  const d=document.getElementById('dr');
  if(!cards.length){d.style.display='none';return;}
  d.innerHTML='';
  cards.forEach(function(c){
    const img=gi(c,'small'),ci=c.color_identity||[];
    const isGC=GC_CARDS.has(c.name);
    const div=document.createElement('div');
    div.className='dri';
    div.innerHTML=
      (img?'<img class="drimg" src="'+img+'" alt="" loading="lazy" onerror="this.style.display=\'none\'">'
          :'<div class="drimg"></div>')+
      '<div style="flex:1;min-width:0">'+
        '<div class="drname">'+e(c.name)+(isGC?' <span style="color:var(--gold);font-size:8px">[GC]</span>':'')+'</div>'+
        '<div class="drtype">'+e((c.type_line||'').replace('Legendary ','').replace('Creature ',''))+'</div>'+
        '<div class="drci">'+ci.map(x=>'<div class="ciw" style="background:'+(CH[x]||'#888')+'"></div>').join('')+'</div>'+
        (c.edhrec_rank?'<div class="drrank">EDHREC #'+c.edhrec_rank.toLocaleString()+'</div>':'')+
      '</div>';
    div._card=c;
    div.addEventListener('touchend',function(ev){ev.preventDefault();pickCard(div._card);});
    div.addEventListener('click',function(){pickCard(div._card);});
    d.appendChild(div);
  });
  d.style.display='block';
}
function hideDr(){document.getElementById('dr').style.display='none';}
function showSpinner(on){document.getElementById('spin').style.display=on?'flex':'none';}
function showInlineErr(msg){const el=document.getElementById('serr');el.className='einl';el.textContent=msg;el.style.display='block';setTimeout(()=>el.style.display='none',4000);}
function clearSearch(){document.getElementById('si').value='';document.getElementById('scl').style.display='none';document.getElementById('sres').style.display='none';hideDr();S.cmd=null;lastQ='';}

function pickCard(c){
  if(!c||typeof c!=='object')return;
  S.cmd=c;hideDr();
  document.getElementById('si').value=c.name;
  document.getElementById('scl').style.display='flex';
  showCmdr(c);
}
function showCmdr(c){
  const ci=c.color_identity||[];
  const bar=ci.length?ci.map(x=>CH[x]||'#555').join(','):'#c8982a';
  const imgN=gi(c,'normal');const txt=c.oracle_text||'';
  const isGC=GC_CARDS.has(c.name);
  const tags=ci.map(col=>'<span class="cmdr-col" style="color:'+(CH[col]||'#ccc')+'">'+CN[col]+'</span>').join('');
  const eur=cmPrice(c);
  const res=document.getElementById('sres');
  res.innerHTML=
    '<div class="cmdr">'+
      '<div class="cmdr-bar" style="background:linear-gradient(to bottom,'+bar+')"></div>'+
      (imgN?'<img class="cmdr-img" src="'+imgN+'" alt="" onerror="this.style.display=\'none\'">':'')+
      '<div class="cmdr-body">'+
        '<div class="cmdr-name">'+e(c.name)+'</div>'+
        '<div class="cmdr-type">'+e((c.type_line||'').replace('Legendary ',''))+'</div>'+
        (c.mana_cost?'<div class="cmdr-cost">'+e(c.mana_cost)+'</div>':'')+
        '<div class="cmdr-cols">'+tags+'</div>'+
        (isGC?'<div class="cmdr-gc">⚠ Offizieller Gamechanger</div>':'')+
        (txt?'<div class="cmdr-txt">'+e(txt.slice(0,180))+(txt.length>180?'…':'')+'</div>':'')+
        (c.power?'<div class="cmdr-pt">'+e(c.power)+' / '+e(c.toughness)+'</div>':'')+
        (c.edhrec_rank?'<div class="cmdr-rank">EDHREC Rang #'+c.edhrec_rank.toLocaleString()+'</div>':'')+
        (eur?'<div class="cmdr-rank" style="color:#58a870">Cardmarket ca. '+fmtEur(eur)+'</div>':'')+
        '<div style="margin-top:10px"><button class="btn" id="cmdrnextbtn">Powerlevel wählen →</button></div>'+
      '</div>'+
    '</div>';
  res.style.display='block';
  onTap(document.getElementById('cmdrnextbtn'),()=>go(2));
}

// ── COLLECTION ──
function hdrop(ev){ev.preventDefault();document.getElementById('dz').classList.remove('drag');loadFile(ev.dataTransfer.files[0]);}
function loadFile(f){
  if(!f)return;
  const r=new FileReader();
  r.onload=ev=>{
    const cards=parseCollection(ev.target.result);
    if(!cards.size){alert('Keine Karten erkannt.');return;}
    S.coll=new Set([...cards].map(n=>n.toLowerCase()));S.collMode=true;
    const d=document.getElementById('dz');d.classList.add('loaded');d.textContent=cards.size+' Karten geladen ✓';
    document.getElementById('ci2').style.display='flex';
    document.getElementById('ct').textContent=cards.size+' Karten aus Sammlung';
  };r.readAsText(f);
}
function parseCollection(txt){
  const out=new Set();
  txt.split(/\r?\n/).map(l=>l.trim()).filter(Boolean).forEach(line=>{
    if(/^[/#]/.test(line)||/^(name|card name|qty|quantity)/i.test(line))return;
    let name=null;
    if(line.includes(','))name=line.split(',').map(x=>x.replace(/"/g,'').trim()).find(x=>x.length>1&&isNaN(+x));
    else{const m=line.match(/^(?:\d+[xX]?\s+)?(.+?)(?:\s+\*.*)?(?:\s+\(.*\).*)?$/);if(m)name=m[1].trim();}
    if(name){name=name.replace(/\s+\[.*\]$/,'').replace(/\s+#\d+$/,'').trim();if(name.length>1&&name.length<120)out.add(name);}
  });return out;
}
function clearColl(){S.coll=null;S.collMode=false;const d=document.getElementById('dz');d.classList.remove('loaded');d.textContent='↑ Datei ablegen oder tippen';document.getElementById('ci2').style.display='none';}
function inColl(n){return!S.collMode||!S.coll||S.coll.has(n.toLowerCase());}

// ── STEP 2 ──
function setupS2(){
  const bg=document.getElementById('bgrid');bg.innerHTML='';
  BR.forEach(b=>{
    const div=document.createElement('div');div.className='bc';div.id='br'+b.id;
    div.style.setProperty('--cc',b.c);div.setAttribute('data-num',b.id);
    div.innerHTML='<div class="bc-head"><div class="bc-dot"></div><div class="bc-name">'+b.label+'</div></div><div class="bc-desc">'+b.desc+'</div><div class="bc-rules">'+b.rules.map(r=>'<div class="bc-rule">'+r+'</div>').join('')+'</div>';
    div._bid=b.id;
    div.addEventListener('touchend',function(ev){ev.preventDefault();selBr(this._bid);});
    div.addEventListener('click',function(){selBr(this._bid);});
    bg.appendChild(div);
  });
  const og=document.getElementById('og');og.innerHTML='';
  OPT.forEach(o=>{
    const div=document.createElement('div');div.className='oc';div.id='oc'+o.id;
    div.innerHTML='<div class="oc-n">'+o.n+'</div><div class="oc-s">'+o.s+'</div>';
    div._oid=o.id;
    div.addEventListener('touchend',function(ev){ev.preventDefault();togOpt(this._oid);});
    div.addEventListener('click',function(){togOpt(this._oid);});
    og.appendChild(div);
  });
  const pg=document.getElementById('pgrid');pg.innerHTML='';
  PT.forEach(p=>{
    const div=document.createElement('div');div.className='pc';div.id='pt'+p.id;
    div.innerHTML='<div class="pc-dot" style="background:'+p.c+'"></div><span class="pc-l">'+p.l+'</span>';
    div._pid=p.id;
    div.addEventListener('touchend',function(ev){ev.preventDefault();selPt(this._pid);});
    div.addEventListener('click',function(){selPt(this._pid);});
    pg.appendChild(div);
  });
}
function selBr(id){S.bracket=id;document.querySelectorAll('.bc').forEach(el=>el.classList.remove('sel'));const el=document.getElementById('br'+id);el.classList.add('sel');el.style.borderColor=BR.find(x=>x.id===id).c;checkS2();}
function togOpt(id){const el=document.getElementById('oc'+id);if(S.opts.includes(id)){S.opts=S.opts.filter(x=>x!==id);el.classList.remove('sel');}else{S.opts.push(id);el.classList.add('sel');}}
function selPt(id){S.pt=id;document.querySelectorAll('.pc').forEach(el=>el.classList.remove('sel'));const el=document.getElementById('pt'+id);el.classList.add('sel');el.style.borderColor=PT.find(x=>x.id===id).c;checkS2();}
function checkS2(){document.getElementById('s2n').disabled=!(S.bracket&&S.pt);}

// ── STEP 3 ──
function setupS3(){
  const ag=document.getElementById('agrid');ag.innerHTML='';
  AR.forEach(a=>{
    const div=document.createElement('div');div.className='ac';div.id='ac'+a.id;
    div.innerHTML='<div class="ac-g">'+a.g+'</div><div class="ac-n">'+a.n+'</div><div class="ac-d">'+a.d+'</div>';
    div._aid=a.id;
    div.addEventListener('touchend',function(ev){ev.preventDefault();selArch(this._aid);});
    div.addEventListener('click',function(){selArch(this._aid);});
    ag.appendChild(div);
  });
  renderArchSel();
  renderSum();
}
function selArch(id){
  if(S.archs.includes(id)){
    S.archs=S.archs.filter(x=>x!==id);
  }else{
    if(S.archs.length>=2){S.archs.shift();}
    S.archs.push(id);
  }
  document.querySelectorAll('.ac').forEach(el=>{el.classList.remove('sel','sel2');});
  S.archs.forEach((aid,i)=>{
    const el=document.getElementById('ac'+aid);
    if(el)el.classList.add(i===0?'sel':'sel2');
  });
  renderArchSel();
  renderSum();
}
function renderArchSel(){
  const el=document.getElementById('archSel');
  if(!S.archs.length){el.innerHTML='<span style="font-size:10px;color:var(--t4);font-family:\'DM Mono\',monospace">Noch nichts ausgewählt</span>';return;}
  el.innerHTML=S.archs.map((id,i)=>{const a=AR.find(x=>x.id===id);return a?'<span class="arch-tag'+(i===1?' t2':'')+'">'+a.g+' '+a.n+'</span>':''}).join('');
}
function renderSum(){
  const b=BR.find(x=>x.id===S.bracket),p=PT.find(x=>x.id===S.pt);
  const ci=S.cmd?.color_identity||[];
  document.getElementById('sumbox').innerHTML=
    '<div class="sect" style="margin-top:0;margin-bottom:10px">Zusammenfassung</div>'+
    '<div class="srow"><span class="sk">Commander</span><span class="sv">'+(S.cmd?e(S.cmd.name):'—')+'</span></div>'+
    '<div class="srow"><span class="sk">Farben</span><span class="sv">'+(ci.map(c=>'<span style="color:'+CH[c]+';font-weight:500">'+CN[c]+'</span>').join(' · ')||'Farblos')+'</span></div>'+
    '<div class="srow"><span class="sk">Bracket</span><span class="sv" style="color:'+(b?b.c:'#fff')+'">'+(b?b.id+' — '+b.label:'—')+'</span></div>'+
    '<div class="srow"><span class="sk">Budget</span><span class="sv" style="color:'+(p?p.c:'#fff')+'">'+(p?p.l:'—')+'</span></div>'+
    '<div class="srow"><span class="sk">Archetypen</span><span class="sv" style="color:var(--gold)">'+(S.archs.map(id=>{const a=AR.find(x=>x.id===id);return a?a.n:'';}).filter(Boolean).join(' + ')||'Kein Archetyp')+'</span></div>'+
    (S.opts.length?'<div class="srow"><span class="sk">Extras</span><span class="sv">'+S.opts.map(id=>OPT.find(x=>x.id===id)?.n||id).join(', ')+'</span></div>':'')+
    (S.collMode?'<div class="srow"><span class="sk">Sammlung</span><span class="sv" style="color:#58a870">Aktiv</span></div>':'');
}

// ── GENERATE ──
async function gen(){
  go(4);
  document.getElementById('p4l').style.display='block';
  document.getElementById('p4e').style.display='none';
  document.getElementById('p4r').style.display='none';
  document.getElementById('llog').innerHTML='';
  S.cats=[];S.dl=[];updPanel();
  const ci=S.cmd?.color_identity||[];
  const cs=ci.length?ci.join(''):'C';
  const pt=PT.find(x=>x.id===S.pt);
  // Use EUR budget thresholds (approx 1 EUR = 1.1 USD, round down for safety)
  const maxEur=pt?pt.max:9999;
  const pf=pt&&pt.max<9999?' eur<='+maxEur:'';
  const base='id<='+cs+' -is:land -is:dfc game:paper'+pf;
  const gcAllowed=S.opts.includes('gc')||S.bracket>=3;
  const comboAllowed=S.opts.includes('combo')||S.bracket>=4;
  const tutorAllowed=S.opts.includes('tutor')||(S.bracket>=3?true:false);
  let progress=0;
  function log(msg,pct){
    document.getElementById('lmsg').textContent=msg;
    if(pct){progress=pct;document.getElementById('lbarfill').style.width=pct+'%';}
    const el=document.createElement('div');el.className='li';el.textContent='▸ '+msg;
    document.getElementById('llog').appendChild(el);
  }
  try{
    // --- MANA RAMP (12 cards) ---
    // High-quality ramp: prioritize 2-mana rocks, land ramp, color-fixing
    log('Mana-Beschleunigung laden…',8);
    let ramp=[];
    // Two-mana rocks (most efficient)
    const rocks2=await sfSafe(base+' (type:artifact type:mana) cmc=2',8);
    // Land ramp (sustainable)
    const landRamp=await sfSafe(base+' (o:"search your library" o:"land") type:sorcery',8);
    // Color-fixing for multicolor
    const fixing=ci.length>2?await sfSafe(base+' (o:"add one mana of any" OR o:"add mana of any") type:artifact',6):[];
    const rampPool=[...rocks2,...landRamp,...fixing];
    ramp=dedupCards(rampPool).filter(c=>gcAllowed||!GC_CARDS.has(c.name)).slice(0,11);
    // Always add Sol Ring unless GC banned
    if(gcAllowed||S.bracket<=2){
      try{const sr=await sfGet('/cards/named?exact=Sol Ring');if(sr&&!ramp.find(r=>r.name==='Sol Ring'))ramp.unshift(sr);}catch{}
    }
    await slp(120);

    // --- CARD DRAW (10 cards) ---
    log('Karten-Vorteil laden…',18);
    const draw1=await sfSafe(base+' (o:"draw two cards" OR o:"draw three cards") cmc<=5',8);
    const draw2=await sfSafe(base+' o:"draw a card" o:"whenever" type:creature',8);
    // Wheels (powerful but meta-dependent)
    const wheels=gcAllowed?await sfSafe(base+' (o:"each player draws" OR o:"discard your hand")',4):[];
    const drawPool=dedupCards([...draw1,...draw2,...wheels]);
    const draw=drawPool.filter(c=>gcAllowed||!GC_CARDS.has(c.name)).slice(0,10);
    await slp(120);

    // --- REMOVAL & INTERACTION (10 cards) ---
    log('Removal & Interaction…',28);
    // Single-target removal
    const removal1=await sfSafe(base+' (o:"destroy target" OR o:"exile target") cmc<=4',8);
    // Counterspells if blue
    const counters=ci.includes('U')?await sfSafe(base+' type:instant o:"counter target" cmc<=3',6):[];
    // Board wipes
    const wraths=await sfSafe(base+' (o:"destroy all creatures" OR o:"exile all" OR o:"each creature gets -") cmc<=6',6);
    const interactPool=dedupCards([...removal1,...counters,...wraths]);
    const interact=interactPool.filter(c=>gcAllowed||!GC_CARDS.has(c.name)).slice(0,10);
    await slp(120);

    // --- SYNERGIES (up to 22 cards for 1-2 archetypes) ---
    log('Synergien laden ('+(S.archs.length?S.archs.map(id=>AR.find(a=>a.id===id)?.n||id).join('+'):'generisch')+')…',40);
    let synCards=[];
    for(const archId of S.archs){
      const archSyn=await fetchArchSyn(archId,cs,pf,14,comboAllowed,tutorAllowed,gcAllowed);
      synCards=[...synCards,...archSyn];
      await slp(100);
    }
    if(S.archs.length===0){
      const generic=await sfSafe(base+' type:creature cmc<=4 o:"whenever"',14);
      synCards=generic;
    }
    const synergy=dedupCards(synCards).filter(c=>gcAllowed||!GC_CARDS.has(c.name)).slice(0,S.archs.length===2?22:18);
    await slp(120);

    // --- WIN CONDITIONS (5 cards) ---
    log('Win-Conditions laden…',55);
    let winCons=[];
    if(comboAllowed){
      // Combo win conditions
      const comboWins=await sfSafe(base+' (o:"you win the game" OR o:"each opponent loses") cmc<=8',6);
      winCons=comboWins;
    }else{
      // Damage-based finishers
      const beatdown=await sfSafe(base+' type:creature (o:"trample" OR o:"unblockable" OR o:"can\'t be blocked") cmc>=5',8);
      winCons=beatdown;
    }
    const wins=dedupCards(winCons).filter(c=>gcAllowed||!GC_CARDS.has(c.name)).slice(0,5);
    await slp(120);

    // --- UTILITY / PROTECTION (6 cards) ---
    log('Utility & Schutz…',65);
    const prot1=await sfSafe(base+' (o:"hexproof" OR o:"shroud") type:instant cmc<=3',5);
    const prot2=await sfSafe(base+' (o:"indestructible" OR o:"regenerate") cmc<=3',5);
    const utility=dedupCards([...prot1,...prot2]).slice(0,6);
    await slp(120);

    // --- LAND BASE (37 lands = Commander rule for 100-card deck) ---
    log('Mana-Basis bauen…',75);
    // Non-basic lands
    const duals=await sfSafe('id<='+cs+' type:land -type:basic game:paper'+pf+' (o:"add {W}" OR o:"add {U}" OR o:"add {B}" OR o:"add {R}" OR o:"add {G}") -type:snow',20);
    const fetches=ci.length>1?await sfSafe('id<='+cs+' type:land game:paper'+pf+' o:"search your library" o:"land"',8):[];
    const utility_lands=await sfSafe('id<='+cs+' type:land game:paper'+pf+' (o:"draw a card" OR o:"add" o:"enters" o:"whenever")',8);
    
    // Always include Command Tower for multicolor
    let specialLands=[];
    if(ci.length>1){
      try{const ct=await sfGet('/cards/named?exact=Command+Tower');if(ct)specialLands.push(ct);}catch{}
      try{const eo=await sfGet('/cards/named?exact=Exotic+Orchard');if(eo)specialLands.push(eo);}catch{}
    }
    const nonBasicPool=dedupCards([...specialLands,...fetches,...duals,...utility_lands]);
    const nonBasics=nonBasicPool.slice(0,Math.min(20,nonBasicPool.length));
    
    // Fill remaining with basic lands
    const basicCount=37-nonBasics.length;
    const basics=[];
    if(basicCount>0&&ci.length>0){
      const perColor=Math.floor(basicCount/ci.length);
      const remainder=basicCount%ci.length;
      ci.forEach((c,idx)=>{
        const bn=BL[c];if(!bn)return;
        const count=perColor+(idx<remainder?1:0);
        for(let i=0;i<count;i++){
          basics.push({
            name:bn,type_line:'Basic Land — '+bn,oracle_text:'({T}: Add {'+c+'.})',
            prices:{eur:'0.10'},_isBasic:true,_count:1,id:'basic_'+bn+'_'+i,
          });
        }
      });
    }else if(basicCount>0){
      // Colorless: Wastes
      for(let i=0;i<basicCount;i++){
        basics.push({name:'Wastes',type_line:'Basic Land',oracle_text:'({T}: Add {C}.)',prices:{eur:'0.10'},_isBasic:true,id:'wastes_'+i});
      }
    }
    const allLands=[...nonBasics,...basics].slice(0,37);
    await slp(100);
    log('Decklist zusammenstellen…',88);

    // Build categories
    const mk=c=>({
      name:c.name,
      type:(c.type_line||'').replace('Legendary ',''),
      text:(c.oracle_text||'').slice(0,120),
      price:cmPrice(c),
      tier:priceTier(cmPrice(c)||0),
      power:c.edhrec_rank?Math.max(1,Math.min(5,6-Math.min(5,Math.floor(c.edhrec_rank/3500)))):3,
      img:gi(c,'small'),
      isGC:GC_CARDS.has(c.name),
      isCombo:COMBO_PIECES.has(c.name),
      isBasic:!!c._isBasic,
    });

    S.cats=[
      {name:'Mana Ramp',     desc:'Beschleunigung & Fixing',  cards:ramp.slice(0,12).map(mk)},
      {name:'Karten-Vorteil',desc:'Hand & Ressourcen',         cards:draw.slice(0,10).map(mk)},
      {name:'Removal',       desc:'Interaction & Wipes',       cards:interact.slice(0,10).map(mk)},
      {name:'Synergien',     desc:S.archs.length?S.archs.map(id=>AR.find(a=>a.id===id)?.n||'').join(' + '):'Kern-Synergien',cards:synergy.map(mk)},
      {name:'Win Conditions',desc:'Siegwege',                  cards:wins.slice(0,5).map(mk)},
      {name:'Utility',       desc:'Schutz & Flexibilität',     cards:utility.slice(0,6).map(mk)},
      {name:'Länder',        desc:'Mana-Basis (37)',            cards:allLands.map(mk)},
    ];

    // Enforce exactly 100 cards: Commander (1) + rest (99)
    // Pad/trim categories to reach 99 non-commander cards
    let totalNonLand=S.cats.slice(0,6).reduce((s,c)=>s+c.cards.length,0);
    const landCount=S.cats[6].cards.length;
    const currentTotal=totalNonLand+landCount;
    const target=99;
    
    if(currentTotal<target){
      // Need more cards - add to synergies
      const need=target-currentTotal;
      log('Fülle fehlende Karten auf ('+need+')…',92);
      const extra=await sfSafe(base+' type:creature cmc<=5',need+5);
      const existingNames=new Set(S.cats.flatMap(c=>c.cards.map(x=>x.name)));
      const newCards=extra.filter(c=>!existingNames.has(c.name)).slice(0,need).map(mk);
      S.cats[3].cards=[...S.cats[3].cards,...newCards];
    }else if(currentTotal>target){
      // Trim from synergies first, then others
      let excess=currentTotal-target;
      for(let i=3;i>=0&&excess>0;i--){
        const trim=Math.min(excess,S.cats[i].cards.length-1);
        S.cats[i].cards=S.cats[i].cards.slice(0,S.cats[i].cards.length-trim);
        excess-=trim;
      }
    }

    document.getElementById('lbarfill').style.width='100%';
    await slp(200);
    document.getElementById('p4l').style.display='none';
    renderResults();
  }catch(err){
    document.getElementById('p4l').style.display='none';
    document.getElementById('p4e').style.display='block';
    document.getElementById('etxt').textContent=err.message;
  }
}

async function fetchArchSyn(archId,cs,pf,lim,comboOk,tutorOk,gcOk){
  const b='id<='+cs+' -is:land -is:dfc game:paper'+pf;
  const queries={
    blink:   [b+' (o:"enters the battlefield" o:"exile" OR o:"blink") type:creature',b+' (o:"leaves the battlefield" o:"enters") type:enchantment',b+' o:"flicker" OR o:"phase out"'],
    landfall:[b+' o:"landfall"',b+' (o:"land" o:"enters" o:"you control") type:creature',b+' type:sorcery o:"land" o:"search"'],
    counters:[b+' o:"+1/+1 counter" o:"whenever" type:creature',b+' o:"proliferate"',b+' (o:"put a +1/+1 counter" o:"each") type:enchantment'],
    infect:  [b+' o:"infect"',b+' o:"proliferate"',b+' (o:"wither" OR o:"toxic")'],
    tokens:  [b+' o:"create" o:"token" type:instant OR type:sorcery',b+' o:"create" o:"token" o:"whenever" type:creature',b+' (o:"populate" OR o:"convoke")'],
    reanimator:[b+' o:"return" o:"graveyard" o:"battlefield" type:sorcery',b+' (o:"unearth" OR o:"dredge" OR o:"flashback")',b+' o:"discard" o:"whenever" type:creature'],
    combo:   comboOk?[b+' (o:"untap" o:"whenever") type:creature cmc<=4',b+' (o:"copy" o:"spell") type:instant',b+' (o:"storm" OR o:"grapeshot" OR o:"mind\'s desire")',b+' o:"infinite" OR (o:"loop" o:"repeatedly")',]:[b+' type:creature cmc<=4',b+' type:instant cmc<=3'],
    voltron: [b+' type:equipment o:"equipped"',b+' type:aura o:"enchanted"',b+' (o:"double strike" OR o:"lifelink" OR o:"trample") type:creature cmc<=2'],
    aristocrats:[b+' o:"sacrifice" o:"whenever" o:"dies" type:creature',b+' o:"whenever a creature" o:"dies" type:enchantment',b+' type:creature o:"dies" o:"drain" OR o:"life"'],
    spellslinger:[b+' o:"whenever you cast" o:"instant or sorcery" type:creature',b+' (o:"copy" o:"spell") type:instant',b+' o:"magecraft"'],
    stax:    [b+' o:"opponent" o:"can\'t" type:enchantment',b+' (o:"pay" o:"more to cast" OR o:"skip")',b+' (o:"tapped" o:"enter" o:"opponent") type:enchantment'],
    theft:   [b+' o:"gain control" type:instant OR type:sorcery',b+' o:"gain control" o:"whenever" type:creature',b+' o:"gain control" type:enchantment'],
    tribal:  [b+' type:creature cmc<=3',b+' type:tribal',b+' o:"of the chosen type" OR o:"kindred"'],
    enchantress:[b+' type:enchantment o:"draw"',b+' o:"enchantment" o:"whenever" type:creature',b+' o:"enchantress" OR o:"constellation"'],
    graveyard:[b+' (o:"flashback" OR o:"unearth" OR o:"dredge") cmc<=5',b+' o:"from your graveyard" o:"return" type:creature',b+' o:"mill" o:"whenever"'],
    artifacts:[b+' type:artifact o:"when" o:"enters" type:artifact',b+' o:"artifact" o:"whenever" type:creature',b+' (o:"improvise" OR o:"affinity for artifacts")'],
  }[archId]||[b+' type:creature cmc<=4',b+' type:instant cmc<=3'];

  const seen=new Set();const result=[];
  for(const q of queries){
    if(result.length>=lim)break;
    const cards=await sfSafe(q,lim);await slp(80);
    for(const c of cards){
      if(result.length>=lim)break;
      if(!seen.has(c.name)){seen.add(c.name);result.push(c);}
    }
  }
  return result;
}

function dedupCards(arr){const s=new Set();return arr.filter(c=>{if(!c||s.has(c.name))return false;s.add(c.name);return true;});}

// ── RENDER RESULTS ──
function renderResults(){
  const c=S.cmd,b=BR.find(x=>x.id===S.bracket),p=PT.find(x=>x.id===S.pt);
  const ci=c?.color_identity||[];
  const tot=1+S.cats.reduce((s,x)=>s+x.cards.length,0);
  document.getElementById('rtit').textContent=c?.name||'';
  document.getElementById('rchips').innerHTML=
    ci.map(col=>'<span class="chip" style="color:'+CH[col]+'">'+CN[col]+'</span>').join('')+
    (b?'<span class="chip" style="color:'+b.c+'">'+b.label+'</span>':'')+
    (p?'<span class="chip" style="color:'+p.c+'">'+p.l+'</span>':'')+
    (S.archs.length?S.archs.map(id=>{const a=AR.find(x=>x.id===id);return a?'<span class="chip" style="color:var(--gold)">'+a.n+'</span>':'';}).join(''):'')+
    (S.collMode?'<span class="chip" style="color:#a078c8">Sammlung</span>':'')+
    '<span class="chip" style="color:'+(tot===100?'#58a870':'#d06060')+'">'+tot+'/100</span>';
  document.getElementById('rinfo').innerHTML=
    '<div class="ic"><div class="icl">Decklist</div><div class="ict">'+tot+' Karten inkl. Commander. Ziel: 100.</div></div>'+
    '<div class="ic"><div class="icl">Bracket</div><div class="ict">'+(b?b.rules.join(' · '):'')+'</div></div>'+
    '<div class="ic"><div class="icl">Export</div><div class="ict">Manabox, Moxfield & Archidekt kompatibel</div></div>';
  // Tabs
  const tbar=document.getElementById('rtabs');tbar.innerHTML='';
  S.cats.forEach((cat,i)=>{
    const btn=document.createElement('button');
    btn.className='tb'+(i===0?' active':'');btn.id='tb'+i;
    btn.innerHTML=cat.name+'<span class="tct">'+cat.cards.length+'</span>';
    btn._ti=i;
    btn.addEventListener('touchend',function(ev){ev.preventDefault();swTab(this._ti);});
    btn.addEventListener('click',function(){swTab(this._ti);});
    tbar.appendChild(btn);
  });
  renderTab(0);
  document.getElementById('p4r').style.display='block';
  window.activeTab=0;
}
function swTab(i){
  window.activeTab=i;
  document.querySelectorAll('.tb').forEach((t,j)=>t.classList.toggle('active',j===i));
  renderTab(i);
}
function renderTab(i){
  const cat=S.cats[i];if(!cat)return;
  const cont=document.getElementById('rcont');
  cont.innerHTML='<div class="cath"><div><div class="catname">'+cat.name+'</div><div class="catdesc">'+cat.desc+'</div></div><button class="aab" id="aab'+i+'">Alle hinzufügen</button></div><div class="cgrid" id="cg'+i+'"></div>';
  onTap(document.getElementById('aab'+i),()=>addAll(i));
  const grid=document.getElementById('cg'+i);
  cat.cards.forEach((card,j)=>grid.appendChild(buildCard(card,i,j)));
}
function buildCard(card,ci,ji){
  const inD=S.dl.includes(card.name),owned=inColl(card.name),miss=!owned&&S.collMode;
  const div=document.createElement('div');
  div.className='ccard'+(inD?' ind':'')+(miss?' now':'')+(card.isGC?' isgc':'');
  div.id='cc'+ci+'_'+ji;
  div.innerHTML=
    (card.img?'<div class="caw"><img class="cai" src="'+card.img+'" alt="" loading="lazy" onerror="this.parentNode.style.display=\'none\'"><div class="cao"></div></div>':'')+
    '<div class="cbody">'+
    '<div class="cname">'+e(card.name)+'</div>'+
    (card.type?'<div class="ctype">'+e(card.type.slice(0,45))+'</div>':'')+
    (card.isGC?'<div class="cgcbadge">⚠ Gamechanger</div>':'')+
    (card.isCombo?'<div class="cgcbadge" style="color:#a078c8;background:rgba(160,120,200,.08);border-color:rgba(160,120,200,.2)">∞ Combo-Teil</div>':'')+
    (card.text&&!card.isBasic?'<div class="ctxt">'+e(card.text)+'</div>':'')+
    '<div class="cft">'+
      '<div class="pds">'+[1,2,3,4,5].map(x=>'<div class="pd '+(x<=card.power?'on':'off')+'"></div>').join('')+'</div>'+
      (S.collMode?'<span class="obadge '+(owned?'oy':'on2')+'">'+(owned?'✓':'?')+'</span>':'')+
      (card.isBasic?'':'<span class="ptag '+card.tier+'">'+card.tier+'</span>')+
      (card.price&&!card.isBasic?'<span class="prc">'+fmtEur(card.price)+'</span>':'')+
      '<button class="addb" id="addb'+ci+'_'+ji+'">'+(inD?'✓':'＋')+'</button>'+
    '</div></div>';
  const btn=div.querySelector('#addb'+ci+'_'+ji);
  btn._cn=card.name;btn._ci=ci;btn._ji=ji;
  btn.addEventListener('touchend',function(ev){ev.preventDefault();togCard(this._cn,this._ci,this._ji);});
  btn.addEventListener('click',function(){togCard(this._cn,this._ci,this._ji);});
  return div;
}
function togCard(name,ci,ji){
  if(S.dl.includes(name))S.dl=S.dl.filter(x=>x!==name);else S.dl.push(name);
  const cat=S.cats[ci];if(!cat||!cat.cards[ji])return;
  const old=document.getElementById('cc'+ci+'_'+ji);
  if(old)old.replaceWith(buildCard(cat.cards[ji],ci,ji));
  updPanel();
}
function addAll(i){
  const cat=S.cats[i];if(!cat)return;
  cat.cards.forEach(c=>{if(!S.dl.includes(c.name))S.dl.push(c.name);});
  renderTab(i);updPanel();
}

// ── DECK PANEL ──
let panelExpanded=false;
function toggleDeckPanel(){
  panelExpanded=!panelExpanded;
  const dp=document.getElementById('dp');
  dp.classList.toggle('expanded',panelExpanded);
  document.getElementById('dplist').style.display=panelExpanded?'grid':'none';
  document.getElementById('dpToggle').textContent=panelExpanded?'▼ Schließen':'▲ Anzeigen';
}
function updPanel(){
  const dp=document.getElementById('dp');
  const n=S.dl.length;
  document.getElementById('dpcnt').textContent=n;
  const totalWithCmdr=n+1;
  document.getElementById('dpprogfill').style.width=Math.min(100,totalWithCmdr)+' %';
  document.getElementById('dpcmdr').textContent=S.cmd?.name?'Commander: '+S.cmd.name:'';
  if(!n){dp.style.display='none';return;}
  dp.style.display='flex';
  if(panelExpanded){
    const list=document.getElementById('dplist');
    list.innerHTML='';
    S.dl.forEach(name=>{
      const div=document.createElement('div');div.className='dpli';
      div.innerHTML='<span>'+e(name)+'</span><button class="dprm">✕</button>';
      const btn=div.querySelector('.dprm');
      btn._n=name;
      btn.addEventListener('touchend',function(ev){ev.preventDefault();removeFromDeck(this._n);});
      btn.addEventListener('click',function(){removeFromDeck(this._n);});
      list.appendChild(div);
    });
  }
}
function removeFromDeck(name){S.dl=S.dl.filter(x=>x!==name);updPanel();if(window.activeTab!==undefined)renderTab(window.activeTab);}

// ── EXPORT ──
function dlFile(content,fname){const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([content],{type:'text/plain;charset=utf-8'}));a.download=fname;a.click();}
function exportSel(){
  if(!S.dl.length)return;
  const lines=['1 '+(S.cmd?.name||'')+' *CMDR*',...S.dl.map(n=>'1 '+n)];
  dlFile(lines.join('\n'),makeFn('_auswahl'));
}
function exportAll(){
  const seen=new Set();
  const lines=['1 '+(S.cmd?.name||'')+' *CMDR*'];
  S.cats.forEach(cat=>cat.cards.forEach(c=>{
    if(!seen.has(c.name)){seen.add(c.name);lines.push('1 '+c.name);}
  }));
  dlFile(lines.join('\n'),makeFn('_komplett'));
}
function makeFn(suf){return(S.cmd?.name||'deck').replace(/[^a-zA-Z0-9]/g,'_')+suf+'.txt';}

// ── NAVIGATION ──
function go(n){
  if(n===2&&!S.cmd)return;
  if(n===2)setupS2();
  if(n===3)setupS3();
  document.querySelectorAll('.page').forEach((p,i)=>p.classList.toggle('on',i+1===n));
  S.step=n;
  for(let i=1;i<=4;i++){
    const d=document.getElementById('d'+i);
    d.classList.remove('active','done');
    if(i===n)d.classList.add('active');
    else if(i<n)d.classList.add('done');
    document.getElementById('dn'+i).textContent=i<n?'✓':i;
  }
  window.scrollTo({top:0,behavior:'smooth'});
}
go(1);
</script>
</body>
</html>
